<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract Review - Collaborative Redlining</title>
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="nav-toggle" id="nav-toggle" title="Toggle navigation">
                <span class="nav-toggle-icon">&#9776;</span>
            </button>
            <h1>Contract Review</h1>
        </div>
        <div class="header-actions">
            <span class="header-info" id="session-info"></span>
            <button class="btn btn-secondary btn-sm" id="btn-new" onclick="showIntake()">New Session</button>
            <button class="btn btn-success btn-sm hidden" id="btn-finalize" onclick="finalize()">Finalize</button>
        </div>
    </header>

    <!-- Main Container - Three Panel Layout -->
    <div class="main-container">
        <!-- Intake Screen -->
        <div class="intake-screen" id="intake-screen">
            <div class="intake-card">
                <h2 class="intake-title">Start Contract Review</h2>
                <p class="intake-subtitle">Upload a contract and configure your review preferences.</p>

                <form id="intake-form" onsubmit="submitIntake(event)">
                    <!-- File uploads -->
                    <div class="form-group">
                        <label class="form-label">Target Contract *</label>
                        <div class="upload-area" id="target-upload" onclick="document.getElementById('target-file').click()">
                            <div class="upload-icon">&#128196;</div>
                            <div id="target-filename">Click or drag to upload .docx file</div>
                        </div>
                        <input type="file" id="target-file" accept=".docx" style="display:none" onchange="handleFileSelect(this, 'target')">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Precedent/Preferred Form (Optional)</label>
                        <div class="upload-area" id="precedent-upload" onclick="document.getElementById('precedent-file').click()">
                            <div class="upload-icon">&#128203;</div>
                            <div id="precedent-filename">Click or drag to upload .docx file</div>
                        </div>
                        <input type="file" id="precedent-file" accept=".docx" style="display:none" onchange="handleFileSelect(this, 'precedent')">
                    </div>

                    <!-- Representation -->
                    <div class="form-group">
                        <label class="form-label">You represent:</label>
                        <select class="form-select" name="representation" required>
                            <option value="seller">Seller</option>
                            <option value="buyer">Buyer/Purchaser</option>
                            <option value="landlord">Landlord</option>
                            <option value="tenant">Tenant</option>
                            <option value="lender">Lender</option>
                            <option value="borrower">Borrower</option>
                            <option value="developer">Developer</option>
                            <option value="grantor">Grantor</option>
                            <option value="grantee">Grantee</option>
                        </select>
                    </div>

                    <!-- Approach -->
                    <div class="form-group">
                        <label class="form-label">Review Approach:</label>
                        <select class="form-select" name="approach">
                            <option value="quick-sale">Quick-Sale (Minimize redlines, critical risks only)</option>
                            <option value="competitive-bid" selected>Competitive Bid (Balanced protection)</option>
                            <option value="relationship">Relationship Deal (Thorough review)</option>
                            <option value="adversarial">Adversarial (Maximum protection)</option>
                        </select>
                    </div>

                    <!-- Aggressiveness -->
                    <div class="form-group">
                        <label class="form-label">Aggressiveness: <span id="aggr-value">3</span>/5</label>
                        <input type="range" class="form-input" name="aggressiveness" min="1" max="5" value="3"
                               style="padding:0" oninput="document.getElementById('aggr-value').textContent=this.value">
                    </div>

                    <!-- Deal context -->
                    <div class="form-group">
                        <label class="form-label">Deal Context (Optional)</label>
                        <textarea class="form-textarea" name="deal_context" placeholder="Any relevant context about the deal, parties, or special considerations..."></textarea>
                    </div>

                    <!-- Include exhibits -->
                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" name="include_exhibits">
                            <span>Include exhibits in review</span>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width:100%">Start Review</button>

                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); text-align: center;">
                        <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.5rem;">Or load saved analysis for testing:</p>
                        <button type="button" class="btn btn-secondary" onclick="loadTestSession()" style="width:100%">Load Test Session</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Navigation Panel (New) -->
        <nav class="nav-panel hidden" id="nav-panel">
            <div class="nav-header">
                <h2 class="nav-title">Document Navigator</h2>
            </div>

            <!-- Review Mode Selector -->
            <div class="nav-section">
                <div class="nav-section-title">Review Mode</div>
                <div class="review-mode-selector">
                    <button class="review-mode-btn active" data-mode="linear" onclick="setReviewMode('linear')">
                        <span class="review-mode-icon">&#8597;</span>
                        <span>Linear</span>
                    </button>
                    <button class="review-mode-btn" data-mode="by-risk" onclick="setReviewMode('by-risk')">
                        <span class="review-mode-icon">&#9888;</span>
                        <span>By Risk</span>
                    </button>
                    <button class="review-mode-btn" data-mode="by-category" onclick="setReviewMode('by-category')">
                        <span class="review-mode-icon">&#9783;</span>
                        <span>By Category</span>
                    </button>
                </div>
            </div>

            <!-- Progress Summary -->
            <div class="nav-section">
                <div class="nav-section-title">Progress</div>
                <div class="nav-progress">
                    <div class="nav-progress-row">
                        <span class="nav-progress-label">Clauses Reviewed</span>
                        <span class="nav-progress-value" id="nav-reviewed-count">0/0</span>
                    </div>
                    <div class="nav-progress-bar-container">
                        <div class="nav-progress-bar" id="nav-progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Risk Summary -->
            <div class="nav-section">
                <div class="nav-section-title">Risk Summary</div>
                <div class="risk-summary">
                    <div class="risk-summary-item severity-high">
                        <span class="risk-summary-count" id="nav-high-risks">0</span>
                        <span class="risk-summary-label">High</span>
                    </div>
                    <div class="risk-summary-item severity-medium">
                        <span class="risk-summary-count" id="nav-medium-risks">0</span>
                        <span class="risk-summary-label">Medium</span>
                    </div>
                    <div class="risk-summary-item severity-low">
                        <span class="risk-summary-count" id="nav-low-risks">0</span>
                        <span class="risk-summary-label">Low</span>
                    </div>
                </div>
            </div>

            <!-- Document Outline -->
            <div class="nav-section nav-outline-section">
                <div class="nav-section-title">Document Outline</div>
                <div class="nav-outline" id="nav-outline">
                    <!-- Section hierarchy rendered here -->
                    <div class="nav-outline-empty">Load a document to see outline</div>
                </div>
            </div>

            <!-- Batch Actions -->
            <div class="nav-section">
                <div class="nav-section-title">Batch Actions</div>
                <div class="batch-actions">
                    <button class="btn btn-sm btn-outline" onclick="jumpToNextRisk()">
                        Next Risk &#8594;
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="jumpToNextUnreviewed()">
                        Next Unreviewed &#8594;
                    </button>
                </div>
            </div>
        </nav>

        <!-- Document Panel -->
        <div class="document-panel hidden" id="document-panel">
            <div class="document-wrapper" id="document-content">
                <!-- Document paragraphs will be rendered here -->
            </div>
        </div>

        <!-- Sidebar (Clause Analysis) -->
        <aside class="sidebar hidden" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title-row">
                    <h2 class="sidebar-title">Clause Analysis</h2>
                    <span class="sidebar-section-ref" id="sidebar-section-ref"></span>
                </div>
                <div class="sidebar-section-title" id="sidebar-section-title">Select a clause</div>
            </div>

            <!-- Tabbed Interface -->
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="risks" onclick="switchSidebarTab('risks')">Risks</button>
                <button class="sidebar-tab" data-tab="related" onclick="switchSidebarTab('related')">Related</button>
                <button class="sidebar-tab" data-tab="definitions" onclick="switchSidebarTab('definitions')">Definitions</button>
                <button class="sidebar-tab" data-tab="history" onclick="switchSidebarTab('history')">History</button>
            </div>

            <!-- Tab Content -->
            <div class="sidebar-tab-content">
                <!-- Risks Tab -->
                <div class="sidebar-tab-pane active" id="tab-risks">
                    <div class="sidebar-content" id="sidebar-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">&#128269;</div>
                            <p>Click on a clause in the document to see its analysis.</p>
                        </div>
                    </div>
                </div>

                <!-- Related Tab -->
                <div class="sidebar-tab-pane" id="tab-related">
                    <div class="related-clauses-content" id="related-clauses-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">&#128279;</div>
                            <p>Related clauses will appear here when you select a clause.</p>
                        </div>
                    </div>
                </div>

                <!-- Definitions Tab -->
                <div class="sidebar-tab-pane" id="tab-definitions">
                    <div class="definitions-content" id="definitions-content">
                        <div class="definitions-search">
                            <input type="text" class="form-input" id="definition-search" placeholder="Search defined terms...">
                        </div>
                        <div class="definitions-list" id="definitions-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">&#128218;</div>
                                <p>Defined terms will appear here after analysis.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div class="sidebar-tab-pane" id="tab-history">
                    <div class="history-content" id="history-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">&#128337;</div>
                            <p>Revision history for this clause will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Related Clauses Quick Selection -->
            <div class="related-selection-panel" id="related-selection-panel" style="display: none;">
                <div class="related-selection-header">
                    <span class="related-selection-title">Include Related Clauses</span>
                    <button class="related-selection-toggle" id="related-selection-toggle" title="Toggle selection">&#9660;</button>
                </div>
                <div class="related-selection-body" id="related-selection-body">
                    <div class="related-selection-hint">Check clauses to include in the revision prompt for harmonization</div>
                    <div class="related-selection-list" id="related-selection-list"></div>
                </div>
            </div>

            <div class="sidebar-footer" id="sidebar-footer">
                <div class="sidebar-footer-info" id="sidebar-footer-info"></div>
                <div class="sidebar-footer-actions">
                    <button class="btn btn-primary" id="btn-generate-revision" disabled>Generate Revision</button>
                    <button class="btn btn-warning" id="btn-flag-client">Flag for Client</button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Flag Modal -->
    <div class="modal-overlay" id="flag-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="flag-type-tabs">
                    <button class="flag-type-tab active" data-type="client" onclick="switchFlagType('client')">Client Review</button>
                    <button class="flag-type-tab" data-type="attorney" onclick="switchFlagType('attorney')">Attorney Review</button>
                </div>
                <h2>Flag for Client Review</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Note for Client (included in transmittal):</label>
                    <textarea class="form-textarea" id="flag-note" placeholder="Add a note explaining what should be reviewed..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeFlagModal()">Cancel</button>
                <button class="btn btn-warning" onclick="submitFlag()">Flag for Client</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Revision Bottom Sheet -->
    <div class="bottom-sheet" id="revision-sheet">
        <div class="bottom-sheet-handle" id="sheet-handle">
            <div class="handle-bar"></div>
            <span class="sheet-title">Proposed Revision</span>
            <button class="sheet-close-btn" id="sheet-close">&times;</button>
        </div>
        <div class="bottom-sheet-content" id="sheet-content">
            <div class="revision-diff" id="revision-diff"></div>
            <div class="revision-rationale" id="revision-rationale"></div>
            <div class="revision-actions" id="revision-actions">
                <button class="btn btn-success" id="btn-accept-revision">Accept</button>
                <button class="btn btn-secondary" id="btn-edit-revision">Edit</button>
                <button class="btn btn-danger" id="btn-reject-revision">Reject</button>
            </div>
        </div>
    </div>

    <!-- Related Clause Viewer Bottom Sheet -->
    <div class="bottom-sheet clause-viewer-sheet" id="clause-viewer-sheet">
        <div class="bottom-sheet-handle">
            <div class="handle-bar"></div>
            <span class="sheet-title" id="clause-viewer-title">Related Clause</span>
            <button class="sheet-close-btn" onclick="closeClauseViewer()">&times;</button>
        </div>
        <div class="clause-viewer-content">
            <div class="clause-viewer-doc" id="clause-viewer-doc">
                <!-- Scrollable document with clauses will be rendered here -->
            </div>
            <div class="clause-viewer-actions" id="clause-viewer-actions">
                <span class="clause-viewer-edit-hint">Click on any clause to edit directly</span>
                <button class="btn btn-success" id="btn-apply-clause-edits" disabled>Apply Edits</button>
                <button class="btn btn-warning" id="btn-flag-clause">Flag for Review</button>
                <button class="btn btn-secondary" onclick="closeClauseViewer()">Dismiss</button>
            </div>
        </div>
    </div>

    <!-- Analysis Overlay -->
    <div class="analysis-overlay" id="analysis-overlay">
        <div class="analysis-panel">
            <div class="analysis-icon">&#9878;</div>
            <div class="analysis-title">Analyzing Contract</div>
            <div class="analysis-verb" id="analysis-verb">Reviewing document structure...</div>
            <div class="analysis-progress-container">
                <div class="analysis-progress-bar" id="analysis-progress"></div>
            </div>
            <div class="analysis-status" id="analysis-status">Initializing...</div>
            <div class="analysis-detail" id="analysis-detail">Preparing to analyze clauses with Claude Opus 4.5</div>
            <div class="analysis-batch-info" id="analysis-batch-info"></div>
        </div>
    </div>

    <!-- JavaScript modules (order matters for dependencies) -->
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/state.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/toast.js"></script>
    <script src="/static/js/views.js"></script>
    <script src="/static/js/navigation.js"></script>
    <script src="/static/js/analysis.js"></script>
    <script src="/static/js/sidebar.js"></script>
    <script src="/static/js/document.js"></script>
    <script src="/static/js/revision.js"></script>
    <script src="/static/js/flag.js"></script>
    <script src="/static/js/intake.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
