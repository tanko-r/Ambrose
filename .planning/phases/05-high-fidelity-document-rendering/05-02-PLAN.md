---
phase: 05-high-fidelity-document-rendering
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/static/js/document.js
  - app/static/index.html
  - app/static/css/main.css
autonomous: true

must_haves:
  truths:
    - "Main document panel displays PDF instead of plain text"
    - "User can click on PDF to select paragraphs"
    - "PDF scales correctly when panel resizes"
    - "Paragraph selection still triggers sidebar update"
  artifacts:
    - path: "app/static/js/document.js"
      provides: "PDF rendering in main panel"
      contains: "pdfjsLib"
    - path: "app/static/index.html"
      provides: "PDF.js library includes"
      contains: "pdf.min.js"
    - path: "app/static/css/main.css"
      provides: "PDF canvas styling"
      contains: ".pdf-page"
  key_links:
    - from: "app/static/js/document.js"
      to: "/api/document/{session_id}/pdf"
      via: "fetch PDF from backend"
      pattern: "api.*document.*pdf"
    - from: "app/static/js/document.js"
      to: "selectParagraph"
      via: "click handler on PDF overlay calls selectParagraph which updates sidebar"
      pattern: "onclick.*selectParagraph"
    - from: "selectParagraph"
      to: "updateRiskSidebar"
      via: "selectParagraph must call updateRiskSidebar to show risks"
      pattern: "selectParagraph.*updateRiskSidebar|showRisks"
---

<objective>
Integrate PDF.js into the main document panel to render the target contract as a high-fidelity PDF.

Purpose: Replace the current text-based rendering with PDF canvas rendering that preserves exact Word formatting, fonts, and automatic numbering. Maintain click-to-select paragraph functionality using an overlay approach.

Output: Main document panel shows PDF rendering with clickable paragraph regions that still trigger the risk sidebar.
</objective>

<execution_context>
@C:\Users\david\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\david\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-high-fidelity-document-rendering/05-RESEARCH.md
@.planning/phases/05-high-fidelity-document-rendering/05-01-SUMMARY.md

@app/static/js/document.js
@app/static/index.html
@app/static/css/main.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PDF.js library and container structure</name>
  <files>app/static/index.html, app/static/css/main.css</files>
  <action>
**In index.html:**

Add PDF.js CDN scripts in the head section (after other scripts):
```html
<!-- PDF.js for high-fidelity document rendering -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.js';
</script>
```

Modify the document-content div structure to support dual rendering:
- Keep existing text-based rendering as fallback
- Add PDF container that will be shown when PDF is available

Inside the main-document-pane, update the structure:
```html
<div id="document-content" class="document-content">
    <!-- Text fallback (existing) -->
    <div id="document-text-content" class="document-text-content"></div>
    <!-- PDF rendering (new) -->
    <div id="document-pdf-content" class="document-pdf-content hidden">
        <div id="pdf-pages-container"></div>
        <div id="pdf-paragraph-overlay"></div>
    </div>
</div>
```

**In main.css:**

Add styles for PDF rendering:
```css
/* PDF Document Rendering */
.document-pdf-content {
    position: relative;
    width: 100%;
    height: 100%;
    overflow-y: auto;
    background: #f5f5f5;
}

.document-pdf-content.hidden {
    display: none;
}

.document-text-content.hidden {
    display: none;
}

#pdf-pages-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 0;
    gap: 20px;
}

.pdf-page {
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    max-width: 100%;
}

#pdf-paragraph-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

.pdf-para-region {
    position: absolute;
    cursor: pointer;
    pointer-events: auto;
    border-radius: 2px;
    transition: background-color 0.15s ease;
}

.pdf-para-region:hover {
    background-color: rgba(59, 130, 246, 0.1);
}

.pdf-para-region.selected {
    background-color: rgba(59, 130, 246, 0.2);
    outline: 2px solid #3b82f6;
}

.pdf-para-region.has-risk {
    border-left: 3px solid #ef4444;
}

.pdf-para-region.has-revision {
    border-left: 3px solid #22c55e;
}

/* Loading state for PDF */
.pdf-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: #666;
}

.pdf-loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e5e7eb;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
```
  </action>
  <verify>
Open index.html in browser dev tools - verify PDF.js is loaded:
```javascript
console.log(typeof pdfjsLib); // Should print 'object'
```
Verify new CSS classes exist and don't break existing layout.
  </verify>
  <done>
PDF.js library is included via CDN. HTML structure supports both text and PDF rendering modes. CSS provides proper PDF page styling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement PDF rendering with paragraph selection wiring</name>
  <files>app/static/js/document.js</files>
  <action>
Modify document.js to add PDF rendering capability while preserving text fallback:

1. **Add PDF state tracking** at the top:
```javascript
// PDF rendering state
let pdfDocument = null;
let pdfRenderMode = false;  // true = PDF, false = text
let pdfScale = 1.5;  // Rendering scale
```

2. **Add renderDocumentAsPdf() function:**
```javascript
async function renderDocumentAsPdf() {
    const pdfUrl = `/api/document/${AppState.sessionId}/pdf`;
    const container = document.getElementById('pdf-pages-container');
    const overlay = document.getElementById('pdf-paragraph-overlay');

    // Show loading state
    container.innerHTML = `
        <div class="pdf-loading">
            <div class="pdf-loading-spinner"></div>
            <p>Loading document preview...</p>
        </div>
    `;

    try {
        // Load PDF document
        pdfDocument = await pdfjsLib.getDocument(pdfUrl).promise;
        container.innerHTML = '';

        // Render each page
        for (let pageNum = 1; pageNum <= pdfDocument.numPages; pageNum++) {
            const page = await pdfDocument.getPage(pageNum);
            const viewport = page.getViewport({ scale: pdfScale });

            const canvas = document.createElement('canvas');
            canvas.className = 'pdf-page';
            canvas.dataset.pageNum = pageNum;
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const ctx = canvas.getContext('2d');
            await page.render({ canvasContext: ctx, viewport }).promise;

            container.appendChild(canvas);
        }

        // Create paragraph overlay regions
        createParagraphOverlay();

        pdfRenderMode = true;

    } catch (error) {
        console.error('PDF rendering failed:', error);
        // Fall back to text rendering
        pdfRenderMode = false;
        showTextFallback();
    }
}
```

3. **Add createParagraphOverlay() function:**
This creates clickable regions over the PDF for paragraph selection.

```javascript
function createParagraphOverlay() {
    const overlay = document.getElementById('pdf-paragraph-overlay');
    const container = document.getElementById('pdf-pages-container');
    overlay.innerHTML = '';

    // Get all paragraphs from document data
    const paragraphs = AppState.document.content.filter(item => item.type === 'paragraph');

    // Simple approach: create evenly distributed click regions
    // Each paragraph gets a horizontal band across the container
    const containerRect = container.getBoundingClientRect();
    const scrollContainer = document.getElementById('document-pdf-content');
    const totalHeight = container.scrollHeight;
    const paraHeight = totalHeight / Math.max(paragraphs.length, 1);

    paragraphs.forEach((para, index) => {
        const region = document.createElement('div');
        region.className = 'pdf-para-region';
        region.dataset.paraId = para.id;

        // Position the region
        region.style.top = `${index * paraHeight}px`;
        region.style.left = '0';
        region.style.width = '100%';
        region.style.height = `${paraHeight}px`;

        // Add risk/revision indicators
        const risks = AppState.analysis?.risk_by_paragraph?.[para.id] || [];
        if (risks.length > 0) {
            region.classList.add('has-risk');
        }

        const revision = AppState.revisions?.[para.id];
        if (revision?.accepted) {
            region.classList.add('has-revision');
        }

        // CRITICAL: Click handler that calls selectParagraph to trigger sidebar update
        // selectParagraph() is the existing function that updates the risk sidebar
        region.onclick = () => selectParagraph(para.id);

        overlay.appendChild(region);
    });
}
```

4. **IMPORTANT: Verify selectParagraph exists and updates sidebar**
Before implementing, check that selectParagraph(paraId) exists in document.js and:
- Updates AppState.selectedParagraphId
- Calls a function to update the risk sidebar (e.g., showRisksForParagraph, updateRiskSidebar, or similar)
- Handles visual selection feedback

If selectParagraph does NOT update the sidebar, add that wiring:
```javascript
function selectParagraph(paraId) {
    AppState.selectedParagraphId = paraId;

    // Update visual selection
    document.querySelectorAll('.pdf-para-region.selected, .para-text.selected').forEach(el =>
        el.classList.remove('selected'));

    if (pdfRenderMode) {
        const region = document.querySelector(`.pdf-para-region[data-para-id="${paraId}"]`);
        if (region) {
            region.classList.add('selected');
            region.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // CRITICAL: Update the risk sidebar
    // This is the key wiring that shows risks when paragraph is selected
    if (typeof showRisksForParagraph === 'function') {
        showRisksForParagraph(paraId);
    } else if (typeof updateRiskSidebar === 'function') {
        updateRiskSidebar(paraId);
    } else {
        // If neither exists, the sidebar update function needs to be identified
        // Check for: renderRiskPane, showRiskAnalysis, displayRisks, etc.
        console.warn('No sidebar update function found - check for existing risk display function');
    }
}
```

5. **Modify loadDocument() to try PDF first:**
```javascript
async function loadDocument() {
    const result = await api(`/document/${AppState.sessionId}`);
    AppState.document = result;
    AppState.flags = result.flags || [];
    AppState.revisions = result.revisions || {};

    // Try PDF rendering first, fall back to text
    const pdfContainer = document.getElementById('document-pdf-content');
    const textContainer = document.getElementById('document-text-content');

    if (pdfContainer && typeof pdfjsLib !== 'undefined') {
        pdfContainer.classList.remove('hidden');
        textContainer.classList.add('hidden');
        await renderDocumentAsPdf();
    } else {
        // Fall back to text rendering
        pdfContainer?.classList.add('hidden');
        textContainer?.classList.remove('hidden');
        renderDocument();
    }

    // Update navigation panel
    if (typeof updateNavPanel === 'function') {
        updateNavPanel();
    }
}
```

6. **Add showTextFallback() helper:**
```javascript
function showTextFallback() {
    const pdfContainer = document.getElementById('document-pdf-content');
    const textContainer = document.getElementById('document-text-content');

    pdfContainer?.classList.add('hidden');
    textContainer?.classList.remove('hidden');
    renderDocument();  // Use existing text rendering
}
```

7. **Export new functions:**
```javascript
window.renderDocumentAsPdf = renderDocumentAsPdf;
window.showTextFallback = showTextFallback;
```
  </action>
  <verify>
1. Start the app and upload a document
2. Main panel should show PDF rendering (not plain text)
3. Click on different areas of the PDF - sidebar MUST update with risk analysis
4. Verify paragraph selection visual feedback works (selected region highlighted)
5. Check console for any errors
6. Specifically test: click paragraph -> verify sidebar shows risks for that paragraph
  </verify>
  <done>
Main document panel renders PDF using PDF.js. Paragraph overlay allows click-to-select. selectParagraph is properly wired to update the risk sidebar. Fallback to text rendering if PDF fails.
  </done>
</task>

<task type="auto">
  <name>Task 3: Handle panel resizing and scroll sync</name>
  <files>app/static/js/document.js</files>
  <action>
Add handling for panel resize events to re-render PDF at appropriate scale:

1. **Add resize observer for PDF scaling:**
```javascript
// Watch for container resize to adjust PDF scale
let pdfResizeObserver = null;

function setupPdfResizeObserver() {
    const container = document.getElementById('document-pdf-content');
    if (!container || pdfResizeObserver) return;

    pdfResizeObserver = new ResizeObserver(debounce(() => {
        if (pdfRenderMode && pdfDocument) {
            // Recalculate scale based on container width
            const containerWidth = container.clientWidth - 60;  // Account for padding
            // Re-render is expensive, only do if significant change
            // For now, just update overlay positions
            createParagraphOverlay();
        }
    }, 250));

    pdfResizeObserver.observe(container);
}

// Simple debounce helper
function debounce(fn, ms) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(this, args), ms);
    };
}
```

2. **Update renderDocumentAsPdf to set up observer:**
Add at the end of renderDocumentAsPdf (after createParagraphOverlay):
```javascript
setupPdfResizeObserver();
```

3. **Add scroll position sync for navigation:**
When user clicks nav panel item, scroll PDF to approximate position:
```javascript
function scrollPdfToSection(sectionIndex) {
    if (!pdfRenderMode) return;

    const container = document.getElementById('document-pdf-content');
    const overlay = document.getElementById('pdf-paragraph-overlay');
    const regions = overlay.querySelectorAll('.pdf-para-region');

    if (regions[sectionIndex]) {
        const region = regions[sectionIndex];
        region.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

window.scrollPdfToSection = scrollPdfToSection;
```

4. **Cleanup on view change:**
Add cleanup when switching away from analysis view:
```javascript
function cleanupPdfRendering() {
    if (pdfResizeObserver) {
        pdfResizeObserver.disconnect();
        pdfResizeObserver = null;
    }
    pdfDocument = null;
    pdfRenderMode = false;
}

window.cleanupPdfRendering = cleanupPdfRendering;
```
  </action>
  <verify>
1. Open precedent panel (Split.js resizes main panel)
2. PDF should remain readable, overlay should adjust
3. Click navigation items - PDF should scroll to section
4. No console errors during resize operations
  </verify>
  <done>
PDF rendering handles panel resize gracefully. Navigation clicks scroll PDF to appropriate section. Resources are cleaned up properly on view changes.
  </done>
</task>

</tasks>

<verification>
- [ ] PDF.js library loads from CDN
- [ ] Main document panel shows PDF rendering
- [ ] PDF pages display with correct formatting
- [ ] Automatic numbering renders correctly in PDF
- [ ] Click on PDF selects paragraph and updates sidebar (KEY LINK)
- [ ] Selected paragraph has visual highlight
- [ ] Risk indicators show on paragraph overlay regions
- [ ] Panel resize doesn't break PDF display
- [ ] Navigation panel clicks scroll PDF appropriately
- [ ] Falls back to text rendering if PDF fails
</verification>

<success_criteria>
1. Opening a document shows PDF rendering by default (not plain text)
2. PDF preserves exact Word formatting (fonts, spacing, numbering)
3. Clicking anywhere on the PDF selects the nearest paragraph
4. Sidebar updates with risk analysis for selected paragraph (CRITICAL)
5. Visual indicators (risk, revision) appear on PDF overlay
6. Resizing panel maintains readable PDF display
7. Falls back gracefully to text rendering if PDF unavailable
</success_criteria>

<output>
After completion, create `.planning/phases/05-high-fidelity-document-rendering/05-02-SUMMARY.md`
</output>
