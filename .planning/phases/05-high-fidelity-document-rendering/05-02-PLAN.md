---
phase: 05-high-fidelity-document-rendering
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/static/js/document.js
  - app/static/js/precedent.js
  - app/static/css/main.css
autonomous: true

must_haves:
  truths:
    - "Main document panel displays high-fidelity HTML instead of plain text"
    - "Precedent panel displays high-fidelity HTML instead of plain text"
    - "Clicking paragraphs still triggers sidebar risk display"
    - "Both panels use consistent styling"
  artifacts:
    - path: "app/static/js/document.js"
      provides: "HTML rendering for main panel"
      contains: "/html"
    - path: "app/static/js/precedent.js"
      provides: "HTML rendering for precedent panel"
      contains: "/html"
    - path: "app/static/css/main.css"
      provides: "Document preview styling"
      contains: ".document-preview"
  key_links:
    - from: "app/static/js/document.js"
      to: "/api/document/{session_id}/html"
      via: "fetch HTML endpoint"
      pattern: "document.*html"
    - from: "app/static/js/document.js"
      to: "selectParagraph"
      via: "click handler on paragraphs"
      pattern: "selectParagraph"
---

<objective>
Integrate high-fidelity HTML rendering into the frontend panels.

Purpose: Replace the current plain text document display with rich HTML that preserves all Word formatting. Enable paragraph click handling for sidebar interaction.

Output: Both main document and precedent panels render documents with full formatting fidelity.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/05-high-fidelity-document-rendering/05-RESEARCH.md
@.planning/phases/05-high-fidelity-document-rendering/05-01-SUMMARY.md

@app/static/js/document.js
@app/static/js/precedent.js
@app/static/css/main.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update main document panel to use HTML rendering</name>
  <files>app/static/js/document.js</files>
  <action>
Modify document.js to fetch and display HTML instead of rendering plain text:

1. **Add new function to render document as HTML:**
```javascript
async function renderDocumentAsHtml() {
    const container = document.getElementById('document-content');
    if (!container) return false;

    // Show loading state
    container.innerHTML = `
        <div class="document-loading">
            <div class="loading-spinner"></div>
            <p>Loading document preview...</p>
        </div>
    `;

    try {
        // Fetch high-fidelity HTML from backend
        const response = await fetch(`/api/document/${AppState.sessionId}/html`);
        if (!response.ok) {
            throw new Error(`Failed to load document: ${response.status}`);
        }

        const html = await response.text();
        container.innerHTML = html;

        // Setup paragraph click handlers
        setupDocumentClickHandlers(container);

        return true;
    } catch (error) {
        console.error('HTML rendering failed:', error);
        // Fall back to plain text rendering
        renderDocument();
        return false;
    }
}
```

2. **Add click handler setup function:**
```javascript
function setupDocumentClickHandlers(container) {
    // Find all paragraphs with data-para-id
    container.querySelectorAll('[data-para-id]').forEach(p => {
        p.classList.add('clickable-paragraph');

        p.addEventListener('click', (e) => {
            e.stopPropagation();
            const paraId = p.dataset.paraId;

            // Remove previous selection
            container.querySelectorAll('.clickable-paragraph.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // Select this paragraph
            p.classList.add('selected');

            // Trigger sidebar update
            selectParagraph(paraId);
        });
    });
}
```

3. **Modify loadDocument() to use HTML rendering:**
Find the loadDocument function and update it to call renderDocumentAsHtml:

```javascript
async function loadDocument() {
    const result = await api(`/document/${AppState.sessionId}`);
    AppState.document = result;
    AppState.flags = result.flags || [];
    AppState.revisions = result.revisions || {};

    // Use high-fidelity HTML rendering
    const htmlSuccess = await renderDocumentAsHtml();

    if (!htmlSuccess) {
        // Fallback already handled in renderDocumentAsHtml
        console.log('Using plain text fallback');
    }

    // Update navigation panel
    if (typeof updateNavPanel === 'function') {
        updateNavPanel();
    }
}
```

4. **Update selectParagraph to scroll in HTML mode:**
Add at the start of selectParagraph (or modify existing):
```javascript
// Scroll to and highlight paragraph in HTML view
const htmlPara = document.querySelector(`[data-para-id="${paraId}"]`);
if (htmlPara) {
    // Remove previous selection
    document.querySelectorAll('.clickable-paragraph.selected').forEach(el => {
        el.classList.remove('selected');
    });
    htmlPara.classList.add('selected');
    htmlPara.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
```

5. **Export new functions:**
```javascript
window.renderDocumentAsHtml = renderDocumentAsHtml;
window.setupDocumentClickHandlers = setupDocumentClickHandlers;
```
  </action>
  <verify>
1. Start the app and upload a document
2. Main panel should show formatted document (not plain text)
3. Click on paragraphs - sidebar should update with risks
4. Selected paragraph should have visual highlight
5. Check console for errors
  </verify>
  <done>
Main document panel renders high-fidelity HTML. Paragraph click handlers work. Sidebar updates correctly on selection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update precedent panel to use HTML rendering</name>
  <files>app/static/js/precedent.js</files>
  <action>
Modify precedent.js to fetch and display HTML:

1. **Add HTML rendering function:**
```javascript
async function renderPrecedentAsHtml() {
    const contentEl = document.getElementById('precedent-content');
    if (!contentEl) return false;

    // Show loading state
    contentEl.innerHTML = `
        <div class="document-loading">
            <div class="loading-spinner"></div>
            <p>Loading precedent document...</p>
        </div>
    `;

    try {
        // Fetch high-fidelity HTML from backend
        const response = await fetch(`/api/precedent/${AppState.sessionId}/html`);
        if (!response.ok) {
            throw new Error(`Failed to load precedent: ${response.status}`);
        }

        const html = await response.text();
        contentEl.innerHTML = html;

        // Setup click handlers for precedent paragraphs
        setupPrecedentClickHandlers(contentEl);

        // Apply related clause highlights
        updatePrecedentHighlights();

        return true;
    } catch (error) {
        console.error('Precedent HTML rendering failed:', error);
        // Fall back to existing text rendering
        renderPrecedentAsText();
        return false;
    }
}
```

2. **Add click handler setup:**
```javascript
function setupPrecedentClickHandlers(container) {
    container.querySelectorAll('[data-para-id]').forEach(p => {
        p.classList.add('precedent-paragraph');

        p.addEventListener('click', (e) => {
            e.stopPropagation();
            const paraId = p.dataset.paraId;

            // Update navigator active item
            if (typeof updateActiveNavItem === 'function') {
                updateActiveNavItem(paraId);
            }

            // Scroll to section
            scrollToPrecedentSection(paraId);
        });
    });
}
```

3. **Add/update highlight function for HTML mode:**
```javascript
function updatePrecedentHighlights() {
    const container = document.getElementById('precedent-content');
    if (!container) return;

    // Clear existing highlights
    container.querySelectorAll('.precedent-paragraph.related').forEach(el => {
        el.classList.remove('related');
    });

    // Add highlights for related clauses
    const relatedIds = precedentPanelState.relatedClauseIds || [];
    relatedIds.forEach(id => {
        const para = container.querySelector(`[data-para-id="${id}"]`);
        if (para) {
            para.classList.add('related');
        }
    });
}
```

4. **Modify renderPrecedentPanel to use HTML:**
Update the content rendering part:
```javascript
function renderPrecedentPanel() {
    const doc = precedentPanelState.document;
    if (!doc) return;

    // Render header (keep existing)
    const headerEl = document.getElementById('precedent-header');
    if (headerEl) {
        headerEl.innerHTML = `
            <div class="precedent-header-left">
                <span class="precedent-header-icon">&#128203;</span>
                <span class="precedent-header-filename">${escapeHtml(precedentPanelState.filename)}</span>
            </div>
            <button class="precedent-header-close" onclick="closePrecedentPanel()" title="Close panel">&times;</button>
        `;
    }

    // Use HTML rendering
    renderPrecedentAsHtml();

    // Build and render navigator (keep existing)
    renderPrecedentNavigator();
}
```

5. **Update updatePrecedentRelatedClauses for HTML mode:**
At the end of the function, call the highlight update:
```javascript
// Add at end of updatePrecedentRelatedClauses
updatePrecedentHighlights();
```

6. **Export new functions:**
```javascript
window.renderPrecedentAsHtml = renderPrecedentAsHtml;
window.updatePrecedentHighlights = updatePrecedentHighlights;
```
  </action>
  <verify>
1. Open Compare Precedent panel
2. Document should show formatted (not plain text)
3. Related clause highlighting should work
4. Click paragraphs - navigator should update
5. Text selection should work for copy
  </verify>
  <done>
Precedent panel renders high-fidelity HTML. Related clause highlighting works. Click handlers functional.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CSS styling for document preview</name>
  <files>app/static/css/main.css</files>
  <action>
Add CSS styles for the high-fidelity document preview:

```css
/* ===========================================
   High-Fidelity Document Preview
   =========================================== */

/* Document preview container (injected from backend) */
.document-preview {
    background: white;
    min-height: 100%;
}

/* Clickable paragraph styling */
.clickable-paragraph,
.precedent-paragraph {
    cursor: pointer;
    transition: background-color 0.15s ease;
    border-radius: 2px;
    position: relative;
}

.clickable-paragraph:hover,
.precedent-paragraph:hover {
    background-color: rgba(59, 130, 246, 0.06);
}

.clickable-paragraph.selected {
    background-color: rgba(59, 130, 246, 0.12);
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

/* Precedent related clause highlight */
.precedent-paragraph.related {
    background-color: rgba(16, 185, 129, 0.12);
    border-left: 3px solid #10b981;
    padding-left: 8px;
    margin-left: -11px;
}

.precedent-paragraph.related:hover {
    background-color: rgba(16, 185, 129, 0.18);
}

/* Document loading state */
.document-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: #6b7280;
}

.document-loading .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e5e7eb;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Override docx-parser-converter defaults for better integration */
.document-preview p {
    margin-bottom: 0.5em;
}

.document-preview .list-marker {
    display: inline;
}

/* Ensure text is selectable for copy */
.document-preview,
.precedent-paragraph,
.clickable-paragraph {
    user-select: text;
    -webkit-user-select: text;
}

/* Print styles for document preview */
@media print {
    .document-preview {
        padding: 0;
        box-shadow: none;
    }
}
```
  </action>
  <verify>
1. Load a document - verify styling looks clean
2. Hover over paragraphs - subtle highlight appears
3. Click paragraph - stronger highlight with outline
4. Open precedent - related clauses show green highlight
5. Text should be selectable
  </verify>
  <done>
CSS provides proper styling for document preview, click states, and related clause highlights.
  </done>
</task>

</tasks>

<verification>
- [ ] Main document panel shows formatted HTML (not plain text)
- [ ] Automatic numbering displays correctly
- [ ] Clicking paragraph updates sidebar with risks
- [ ] Selected paragraph has visual highlight
- [ ] Precedent panel shows formatted HTML
- [ ] Related clause highlighting works in precedent
- [ ] Text is selectable for copy
- [ ] Loading states display during fetch
- [ ] Falls back to plain text if HTML fails
</verification>

<success_criteria>
1. Opening a document shows high-fidelity rendering (not plain text)
2. Automatic numbering schemes display correctly (RENDER-02)
3. Indentation and formatting preserved (RENDER-01, RENDER-03)
4. Both panels use same rendering engine (RENDER-04)
5. Click-to-select paragraph functionality works
6. Sidebar updates with risk analysis on selection
7. Precedent related clause highlighting functional
</success_criteria>

<output>
After completion, create `.planning/phases/05-high-fidelity-document-rendering/05-02-SUMMARY.md`
</output>
