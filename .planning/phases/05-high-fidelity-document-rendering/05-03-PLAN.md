---
phase: 05-high-fidelity-document-rendering
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/static/js/precedent.js
  - app/static/css/main.css
autonomous: true

must_haves:
  truths:
    - "Precedent panel displays PDF instead of plain text"
    - "PDF in precedent panel has same quality as main panel"
    - "Related clause highlighting works in PDF mode"
    - "Text copy from PDF still works (PREC-04)"
  artifacts:
    - path: "app/static/js/precedent.js"
      provides: "PDF rendering for precedent panel"
      contains: "pdfjsLib"
    - path: "app/static/css/main.css"
      provides: "Precedent PDF styling"
      contains: ".precedent-pdf"
  key_links:
    - from: "app/static/js/precedent.js"
      to: "/api/precedent/{session_id}/pdf"
      via: "fetch PDF from backend"
      pattern: "precedent.*pdf"
---

<objective>
Apply the same high-fidelity PDF rendering to the precedent panel.

Purpose: Ensure both document panels (main and precedent) use identical rendering quality for consistent user experience. The precedent document should render with the same Word-perfect fidelity as the main document.

Output: Precedent panel renders PDF with related clause highlighting and maintains text copy functionality.
</objective>

<execution_context>
@C:\Users\david\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\david\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-high-fidelity-document-rendering/05-RESEARCH.md
@.planning/phases/05-high-fidelity-document-rendering/05-01-SUMMARY.md

@app/static/js/precedent.js
@app/static/css/main.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PDF rendering capability to precedent panel</name>
  <files>app/static/js/precedent.js</files>
  <action>
Modify precedent.js to support PDF rendering similar to document.js:

1. **Add PDF state variables** after existing state:
```javascript
// PDF rendering state for precedent
let precedentPdfDocument = null;
let precedentPdfRenderMode = false;
let precedentPdfScale = 1.3;  // Slightly smaller scale for split view
```

2. **Add renderPrecedentAsPdf() function:**
```javascript
async function renderPrecedentAsPdf() {
    const pdfUrl = `/api/precedent/${AppState.sessionId}/pdf`;
    const contentEl = document.getElementById('precedent-content');

    // Show loading state
    contentEl.innerHTML = `
        <div class="precedent-pdf-loading">
            <div class="pdf-loading-spinner"></div>
            <p>Loading precedent document...</p>
        </div>
    `;

    try {
        // Load PDF document
        precedentPdfDocument = await pdfjsLib.getDocument(pdfUrl).promise;
        contentEl.innerHTML = '';

        // Create PDF container structure
        const pdfContainer = document.createElement('div');
        pdfContainer.id = 'precedent-pdf-container';
        pdfContainer.className = 'precedent-pdf-container';

        const pagesContainer = document.createElement('div');
        pagesContainer.id = 'precedent-pdf-pages';
        pagesContainer.className = 'precedent-pdf-pages';

        const overlay = document.createElement('div');
        overlay.id = 'precedent-pdf-overlay';
        overlay.className = 'precedent-pdf-overlay';

        pdfContainer.appendChild(pagesContainer);
        pdfContainer.appendChild(overlay);
        contentEl.appendChild(pdfContainer);

        // Render each page
        for (let pageNum = 1; pageNum <= precedentPdfDocument.numPages; pageNum++) {
            const page = await precedentPdfDocument.getPage(pageNum);
            const viewport = page.getViewport({ scale: precedentPdfScale });

            const canvas = document.createElement('canvas');
            canvas.className = 'precedent-pdf-page';
            canvas.dataset.pageNum = pageNum;
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const ctx = canvas.getContext('2d');
            await page.render({ canvasContext: ctx, viewport }).promise;

            pagesContainer.appendChild(canvas);
        }

        // Create paragraph overlay for click-to-select and highlights
        createPrecedentPdfOverlay();

        precedentPdfRenderMode = true;

        // Re-highlight related clauses after PDF renders
        updatePrecedentPdfHighlights();

    } catch (error) {
        console.error('Precedent PDF rendering failed:', error);
        precedentPdfRenderMode = false;
        // Fall back to text rendering
        renderPrecedentAsText();
    }
}
```

3. **Add createPrecedentPdfOverlay() function:**
```javascript
function createPrecedentPdfOverlay() {
    const overlay = document.getElementById('precedent-pdf-overlay');
    const pagesContainer = document.getElementById('precedent-pdf-pages');
    if (!overlay || !pagesContainer) return;

    overlay.innerHTML = '';

    const doc = precedentPanelState.document;
    if (!doc) return;

    const paragraphs = doc.content.filter(item => item.type === 'paragraph');
    const totalHeight = pagesContainer.scrollHeight;
    const paraHeight = totalHeight / Math.max(paragraphs.length, 1);

    paragraphs.forEach((para, index) => {
        const region = document.createElement('div');
        region.className = 'precedent-pdf-para-region';
        region.id = `prec-pdf-${para.id}`;
        region.dataset.paraId = para.id;

        // Position the region
        region.style.top = `${index * paraHeight}px`;
        region.style.left = '0';
        region.style.width = '100%';
        region.style.height = `${paraHeight}px`;

        // Click handler to scroll to section
        region.onclick = () => {
            scrollToPrecedentSection(para.id);
            // Also update nav item
            updateActiveNavItem(para.id);
        };

        overlay.appendChild(region);
    });
}
```

4. **Add updatePrecedentPdfHighlights() function:**
```javascript
function updatePrecedentPdfHighlights() {
    if (!precedentPdfRenderMode) return;

    const overlay = document.getElementById('precedent-pdf-overlay');
    if (!overlay) return;

    // Clear existing highlights
    overlay.querySelectorAll('.precedent-pdf-para-region').forEach(region => {
        region.classList.remove('precedent-related', 'precedent-highlight-flash');
    });

    // Add highlights for related clauses
    const relatedIds = precedentPanelState.relatedClauseIds || [];
    relatedIds.forEach(id => {
        const region = document.getElementById(`prec-pdf-${id}`);
        if (region) {
            region.classList.add('precedent-related');
        }
    });
}
```

5. **Add text fallback function:**
```javascript
function renderPrecedentAsText() {
    // Use existing buildPrecedentContent function
    const doc = precedentPanelState.document;
    if (!doc) return;

    const contentHtml = buildPrecedentContent(doc.content || []);
    const contentEl = document.getElementById('precedent-content');
    if (contentEl) {
        contentEl.innerHTML = contentHtml;
        setupPrecedentCopyHandler();
        setupPrecedentScrollObserver();
    }
}
```

6. **Modify renderPrecedentPanel() to try PDF first:**
Replace the content rendering section:
```javascript
function renderPrecedentPanel() {
    const doc = precedentPanelState.document;
    if (!doc) return;

    // Render header (keep existing code)
    const headerEl = document.getElementById('precedent-header');
    if (headerEl) {
        headerEl.innerHTML = `
            <div class="precedent-header-left">
                <span class="precedent-header-icon">&#128203;</span>
                <span class="precedent-header-filename">${escapeHtml(precedentPanelState.filename)}</span>
            </div>
            <button class="precedent-header-close" onclick="closePrecedentPanel()" title="Close panel">&times;</button>
        `;
    }

    // Try PDF rendering first, fall back to text
    if (typeof pdfjsLib !== 'undefined') {
        renderPrecedentAsPdf();
    } else {
        renderPrecedentAsText();
    }

    // Build and render navigator (keep existing)
    renderPrecedentNavigator();
}
```

7. **Update updatePrecedentRelatedClauses() for PDF mode:**
Add PDF highlight update at the end of the function:
```javascript
async function updatePrecedentRelatedClauses(paraId) {
    if (!precedentPanelState.isOpen || !precedentPanelState.document) return;

    precedentPanelState.currentParaId = paraId;
    await fetchRelatedPrecedentClauses(paraId);

    if (precedentPdfRenderMode) {
        // Update PDF overlay highlights
        updatePrecedentPdfHighlights();
    } else {
        // Update text-based highlights (existing code)
        const contentEl = document.getElementById('precedent-content');
        if (contentEl) {
            contentEl.querySelectorAll('.precedent-related').forEach(el => {
                el.classList.remove('precedent-related');
            });
            precedentPanelState.relatedClauseIds.forEach(id => {
                const el = document.getElementById(`prec-${id}`);
                if (el) {
                    el.classList.add('precedent-related');
                }
            });
        }
    }

    // Update navigator (keep existing)
    renderPrecedentNavigator();
}
```

8. **Modify scrollToPrecedentSection() for PDF mode:**
```javascript
function scrollToPrecedentSection(paraId) {
    if (precedentPdfRenderMode) {
        const region = document.getElementById(`prec-pdf-${paraId}`);
        if (region) {
            region.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Brief highlight effect
            region.classList.add('precedent-highlight-flash');
            setTimeout(() => region.classList.remove('precedent-highlight-flash'), 1500);
        }
    } else {
        // Existing text-based scroll (keep)
        const element = document.getElementById(`prec-${paraId}`);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            element.classList.add('precedent-highlight-flash');
            setTimeout(() => element.classList.remove('precedent-highlight-flash'), 1500);
        }
    }

    updateActiveNavItem(paraId);
}
```

9. **Update closePrecedentPanel() to clean up PDF:**
Add at the start of closePrecedentPanel:
```javascript
// Clean up PDF resources
precedentPdfDocument = null;
precedentPdfRenderMode = false;
```

10. **Export new functions:**
```javascript
window.renderPrecedentAsPdf = renderPrecedentAsPdf;
window.updatePrecedentPdfHighlights = updatePrecedentPdfHighlights;
```
  </action>
  <verify>
1. Open precedent panel with a document
2. Verify PDF renders instead of plain text
3. Click on different paragraphs - navigation should update
4. Select different main document paragraphs - related clauses should highlight
5. Check that highlight flash animation works
  </verify>
  <done>
Precedent panel renders PDF using PDF.js. Related clause highlighting works in PDF mode. Navigation and selection function correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CSS for precedent PDF rendering</name>
  <files>app/static/css/main.css</files>
  <action>
Add CSS styles for precedent PDF rendering (add after existing precedent styles):

```css
/* Precedent PDF Rendering */
.precedent-pdf-container {
    position: relative;
    width: 100%;
    height: 100%;
}

.precedent-pdf-pages {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px 0;
    gap: 15px;
}

.precedent-pdf-page {
    background: white;
    box-shadow: 0 1px 4px rgba(0,0,0,0.12);
    max-width: 100%;
}

.precedent-pdf-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

.precedent-pdf-para-region {
    position: absolute;
    cursor: pointer;
    pointer-events: auto;
    border-radius: 2px;
    transition: background-color 0.15s ease;
}

.precedent-pdf-para-region:hover {
    background-color: rgba(16, 185, 129, 0.08);
}

.precedent-pdf-para-region.precedent-related {
    background-color: rgba(16, 185, 129, 0.15);
    border-left: 3px solid #10b981;
}

.precedent-pdf-para-region.precedent-highlight-flash {
    animation: precedentPdfFlash 1.5s ease-out;
}

@keyframes precedentPdfFlash {
    0% { background-color: rgba(16, 185, 129, 0.4); }
    100% { background-color: rgba(16, 185, 129, 0.15); }
}

/* Loading state for precedent PDF */
.precedent-pdf-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    color: #666;
}
```
  </action>
  <verify>
Open precedent panel - verify:
1. PDF pages have white background with shadow
2. Related clauses have green highlight
3. Hover shows subtle highlight
4. Flash animation works on navigation
  </verify>
  <done>
CSS styles provide consistent visual appearance for precedent PDF rendering matching the main panel style but with green accent for related clauses.
  </done>
</task>

<task type="auto">
  <name>Task 3: Ensure text selection works for PDF (PREC-04)</name>
  <files>app/static/js/precedent.js</files>
  <action>
PDF.js renders to canvas which doesn't support native text selection. Add a text layer for selection support:

1. **Modify the page rendering loop in renderPrecedentAsPdf():**
Replace the page rendering loop with:

```javascript
// Render each page with text layer
for (let pageNum = 1; pageNum <= precedentPdfDocument.numPages; pageNum++) {
    const page = await precedentPdfDocument.getPage(pageNum);
    const viewport = page.getViewport({ scale: precedentPdfScale });

    // Create wrapper for page + text layer
    const pageWrapper = document.createElement('div');
    pageWrapper.className = 'precedent-pdf-page-wrapper';
    pageWrapper.style.position = 'relative';
    pageWrapper.style.width = `${viewport.width}px`;
    pageWrapper.style.height = `${viewport.height}px`;

    // Canvas for PDF rendering
    const canvas = document.createElement('canvas');
    canvas.className = 'precedent-pdf-page';
    canvas.dataset.pageNum = pageNum;
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    const ctx = canvas.getContext('2d');
    await page.render({ canvasContext: ctx, viewport }).promise;

    pageWrapper.appendChild(canvas);

    // Text layer for selection (PREC-04)
    const textContent = await page.getTextContent();
    const textLayer = document.createElement('div');
    textLayer.className = 'precedent-pdf-text-layer';
    textLayer.style.cssText = `
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
        opacity: 0.2;
        line-height: 1.0;
    `;

    // Render text items
    pdfjsLib.renderTextLayer({
        textContent: textContent,
        container: textLayer,
        viewport: viewport,
        textDivs: []
    });

    pageWrapper.appendChild(textLayer);
    pagesContainer.appendChild(pageWrapper);
}
```

2. **Add CSS for text layer in main.css:**
```css
/* PDF Text Layer for Selection (PREC-04) */
.precedent-pdf-page-wrapper {
    position: relative;
    background: white;
    box-shadow: 0 1px 4px rgba(0,0,0,0.12);
}

.precedent-pdf-text-layer {
    position: absolute;
    left: 0;
    top: 0;
    right: 0;
    bottom: 0;
    overflow: hidden;
    line-height: 1.0;
    user-select: text;
    -webkit-user-select: text;
}

.precedent-pdf-text-layer > span {
    color: transparent;
    position: absolute;
    white-space: pre;
    transform-origin: 0% 0%;
    cursor: text;
}

.precedent-pdf-text-layer ::selection {
    background: rgba(59, 130, 246, 0.3);
}
```

NOTE: PDF.js text layer is optional and may not perfectly align with the visual rendering. It provides reasonable text selection for copy/paste. If it causes issues, can be disabled by removing the text layer code.

3. **Update copy handler for PDF mode:**
In setupPrecedentCopyHandler(), the existing keyboard shortcut should work since text layer enables selection. Add a visual feedback:

```javascript
// Add at the end of the copy event listener
document.addEventListener('copy', (e) => {
    const selection = window.getSelection();
    if (selection && selection.toString().trim()) {
        // Check if selection is within precedent panel
        const precedentContent = document.getElementById('precedent-content');
        if (precedentContent && precedentContent.contains(selection.anchorNode)) {
            showToast('Text copied to clipboard', 'success');
        }
    }
});
```
  </action>
  <verify>
1. Open precedent panel with PDF rendering
2. Try to select text in the PDF
3. Press Ctrl+C to copy
4. Paste in another application - verify text is copied
5. Toast notification should appear
  </verify>
  <done>
Text selection works in PDF mode via text layer overlay. Users can select and copy text from precedent document (PREC-04 requirement met).
  </done>
</task>

</tasks>

<verification>
- [ ] Precedent panel renders PDF when opened
- [ ] PDF formatting matches Word document
- [ ] Related clause highlighting works in PDF mode
- [ ] Navigation clicks scroll to correct PDF region
- [ ] Text selection is possible in PDF
- [ ] Copy/paste works (PREC-04)
- [ ] Flash animation on navigation works
- [ ] Falls back to text rendering if PDF fails
- [ ] Panel resize doesn't break PDF display
</verification>

<success_criteria>
1. Opening Compare Precedent shows PDF rendering (not plain text)
2. PDF has same quality as main document panel (RENDER-04)
3. Related clause highlighting appears as green overlay regions
4. User can select and copy text from the PDF (PREC-04)
5. Navigation panel clicks scroll PDF to correct section
6. Falls back gracefully to text rendering if PDF unavailable
</success_criteria>

<output>
After completion, create `.planning/phases/05-high-fidelity-document-rendering/05-03-SUMMARY.md`
</output>
