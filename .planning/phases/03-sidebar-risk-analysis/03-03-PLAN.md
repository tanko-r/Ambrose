---
phase: 03-sidebar-risk-analysis
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - frontend/src/components/review/analysis-overlay.tsx
  - frontend/src/app/review/[sessionId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "When analysis starts, a full-screen overlay appears with progress bar and rotating legal verbs"
    - "Overlay shows two-stage indicator (Initial Analysis + Parallel Batches) with checkmark on completion"
    - "Progress percentage updates in real-time during analysis"
    - "Overlay disappears when analysis completes"
    - "Analysis starts automatically when entering review page if not already analyzed"
  artifacts:
    - path: "frontend/src/components/review/analysis-overlay.tsx"
      provides: "Full-screen analysis progress overlay with two stages, progress bar, rotating verbs"
      exports: ["AnalysisOverlay"]
    - path: "frontend/src/app/review/[sessionId]/page.tsx"
      provides: "Review page with AnalysisOverlay rendered and useAnalysis hook connected"
      contains: "AnalysisOverlay"
  key_links:
    - from: "frontend/src/app/review/[sessionId]/page.tsx"
      to: "frontend/src/hooks/use-analysis.ts"
      via: "useAnalysis hook called with sessionId"
      pattern: "useAnalysis"
    - from: "frontend/src/components/review/analysis-overlay.tsx"
      to: "frontend/src/lib/store.ts"
      via: "reads analysisStatus, analysisStage, analysisPercent, stageDisplay from store"
      pattern: "useAppStore"
---

<objective>
Build the analysis progress overlay and wire the analysis hook into the review page.

Purpose: When a user enters the review page after intake, analysis begins automatically. The overlay provides visual feedback during the 60-90 second analysis process, showing which stage the system is in and progress percentage. Without this, users would see a blank sidebar with no indication that work is happening.

Output: analysis-overlay.tsx component and updated page.tsx with analysis integration.
</objective>

<execution_context>
@C:\Users\david\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\david\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-sidebar-risk-analysis/03-RESEARCH.md
@.planning/phases/03-sidebar-risk-analysis/03-01-SUMMARY.md

@frontend/src/app/review/[sessionId]/page.tsx
@frontend/src/hooks/use-analysis.ts
@frontend/src/lib/store.ts
@frontend/src/components/ui/progress.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analysis-overlay.tsx with progress and rotating verbs</name>
  <files>frontend/src/components/review/analysis-overlay.tsx</files>
  <action>
Create `frontend/src/components/review/analysis-overlay.tsx`:

```
"use client";
```

**Component: AnalysisOverlay**

Reads from store:
- `analysisStatus` — only renders when `=== 'analyzing'`
- `analysisStage` — `'initial_analysis'` | `'parallel_batches'` | `'complete'`
- `analysisPercent` — 0-100
- `stageDisplay` — human-readable string like "Parallel analysis: 3/6 batches [45s]"

Layout (fixed full-screen overlay):
```tsx
<div className="fixed inset-0 z-50 flex items-center justify-center bg-background/80 backdrop-blur-sm">
  <div className="w-full max-w-lg rounded-2xl border bg-card p-8 shadow-2xl">
    {/* Content here */}
  </div>
</div>
```

Content structure:

1. **Title:** "Analyzing Document" in `text-lg font-semibold`

2. **Two-stage indicator:** Two items in a horizontal flex:
   - "Initial Analysis" — shows a spinner (animated) when `stage === 'initial_analysis'`, checkmark when stage is `'parallel_batches'` or `'complete'`
   - "Parallel Batches" — shows a dot (not started) when `stage === 'initial_analysis'`, spinner when `stage === 'parallel_batches'`, checkmark when `stage === 'complete'`

   Use lucide-react icons: `Loader2` (with `animate-spin`), `Check` (checkmark), and a simple `Circle` (dot). Each stage label with its icon, using `text-sm` and appropriate colors (active = foreground, completed = green-600, pending = muted-foreground).

3. **Progress bar:** Use shadcn `<Progress value={analysisPercent} />` component. Below it, show `{analysisPercent}%` in `text-xs text-muted-foreground text-right`.

4. **Stage display:** Show `stageDisplay` text in `text-sm text-muted-foreground text-center mt-2` when available.

5. **Rotating legal verb:** Use the `useRotatingVerb` hook (defined locally in this file). Displays a rotating message every 2.5 seconds with a fade transition.

**useRotatingVerb hook (local to this file):**

```typescript
const ANALYSIS_VERBS = [
  "Reading the fine print...",
  "Briefing...",
  "Arguing both sides...",
  "Thinking aggressively...",
  "Finding the loopholes...",
  "Protecting your interests...",
  "Channeling senior partner energy...",
  "Billable hours accumulating...",
  "Citing precedent...",
  "Drafting counterarguments...",
  "Playing devil's advocate...",
  "Reviewing for gotchas...",
  "Checking the defined terms...",
  "Lawyering...",
  "Cross-referencing...",
  "Due diligence-ing...",
  "Risk-assessing...",
  "Zealously advocating...",
  "Preparing the markup...",
];
```

Hook implementation:
- Takes `active: boolean` param
- Uses `useState` for index and fading state
- `useEffect` with `setInterval(2500)` when active:
  - Set `fading = true`
  - After 200ms timeout: increment index (mod length), set `fading = false`
  - Cleanup: clear interval
- Returns `{ verb: ANALYSIS_VERBS[index], fading }`

Render the verb in `text-sm text-muted-foreground italic text-center mt-4` with a CSS transition: `className={... transition-opacity duration-200 ${fading ? 'opacity-0' : 'opacity-100'}}`.

**Guard:** If `analysisStatus !== 'analyzing'`, return `null`.

Export: `AnalysisOverlay` as named export.
  </action>
  <verify>
Run `npx tsc --noEmit` from `frontend/` — no type errors. Read the file and verify: (1) reads from store correctly, (2) renders nothing when not analyzing, (3) two-stage indicator with correct icons per stage, (4) progress bar uses shadcn Progress, (5) rotating verb with fade.
  </verify>
  <done>
analysis-overlay.tsx renders a full-screen overlay during analysis with two-stage indicator, progress bar, stage display text, and rotating legal-themed verbs with fade transitions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire analysis overlay and hook into review page</name>
  <files>frontend/src/app/review/[sessionId]/page.tsx</files>
  <action>
Update `frontend/src/app/review/[sessionId]/page.tsx`:

1. **Add imports:**
   ```typescript
   import { useAnalysis } from "@/hooks/use-analysis";
   import { AnalysisOverlay } from "@/components/review/analysis-overlay";
   ```
   Also import `useEffect` from React (add to existing `use` import).

2. **Call useAnalysis hook:**
   After the `useDocument` call, add:
   ```typescript
   const { startAnalysis, isAnalyzing } = useAnalysis(sessionId);
   const analysisStatus = useAppStore((s) => s.analysisStatus);
   ```

3. **Auto-start analysis after document loads:**
   Add a `useEffect` that starts analysis when the document finishes loading and analysis hasn't been done:
   ```typescript
   useEffect(() => {
     if (!loading && sessionId && analysisStatus === 'not_started') {
       startAnalysis();
     }
   }, [loading, sessionId, analysisStatus, startAnalysis]);
   ```

   This triggers analysis automatically after intake. If the user navigates back to a session that already has analysis (`analysisStatus === 'complete'`), it won't re-trigger.

4. **Add AnalysisOverlay to JSX:**
   Place `<AnalysisOverlay />` AFTER the main content div but INSIDE the root div, so it renders above everything with its `fixed` positioning:
   ```tsx
   <div className="flex h-screen flex-col">
     <Header />
     <div className="flex flex-1 overflow-hidden">
       <NavigationPanel />
       <DocumentViewer loading={loading} />
       <Sidebar />
     </div>
     <BottomBar />
     <AnalysisOverlay />
   </div>
   ```

   The overlay uses `fixed inset-0 z-50` so its DOM position doesn't matter much, but placing it at the end of the root div is cleaner.

5. **Keep all existing functionality unchanged:**
   - Session ID setting
   - useDocument hook
   - Layout structure (header, nav, viewer, sidebar, bottom bar)
  </action>
  <verify>
Run `npx tsc --noEmit` from `frontend/` — no type errors. Run `npm run build` from `frontend/` — build succeeds. Read page.tsx and verify: (1) imports useAnalysis and AnalysisOverlay, (2) auto-starts analysis when not_started and not loading, (3) AnalysisOverlay rendered in JSX.
  </verify>
  <done>
Review page auto-triggers analysis on document load, renders AnalysisOverlay during analysis, and the overlay self-hides when analysis completes. No changes to existing layout.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in frontend/
2. `npm run build` passes in frontend/
3. AnalysisOverlay reads store state and shows/hides based on analysisStatus
4. page.tsx auto-starts analysis after document loads
5. AnalysisOverlay is rendered at page level (not inside sidebar or viewer)
</verification>

<success_criteria>
- Full-screen overlay appears when analysisStatus is 'analyzing' with progress bar, stage indicator, and rotating verbs
- Overlay automatically disappears when analysis completes
- Analysis starts automatically when entering review page after intake
- Analysis does NOT re-trigger if already complete (e.g., navigating back to session)
- Rotating verbs cycle every 2.5s with smooth fade transition
</success_criteria>

<output>
After completion, create `.planning/phases/03-sidebar-risk-analysis/03-03-SUMMARY.md`
</output>
