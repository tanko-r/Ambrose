---
phase: 03-sidebar-risk-analysis
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/review/risk-card.tsx
  - frontend/src/components/review/risk-accordion.tsx
  - frontend/src/components/review/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Each risk displays severity badge with effective severity arrow when mitigators exist"
    - "Each risk shows description, relationships (mitigated by / amplified by), and include/exclude toggle"
    - "Only one risk is expanded at a time (accordion single-expand behavior)"
    - "Risk count and selection count shown in sidebar footer"
  artifacts:
    - path: "frontend/src/components/review/risk-card.tsx"
      provides: "Individual risk display with severity, description, relationships, toggle"
      exports: ["RiskCard"]
    - path: "frontend/src/components/review/risk-accordion.tsx"
      provides: "Accordion wrapper for list of risk cards"
      exports: ["RiskAccordion"]
    - path: "frontend/src/components/review/sidebar.tsx"
      provides: "Refactored sidebar using RiskAccordion instead of flat RisksTabContent"
      contains: "RiskAccordion"
  key_links:
    - from: "frontend/src/components/review/risk-accordion.tsx"
      to: "frontend/src/components/ui/accordion.tsx"
      via: "shadcn Accordion component"
      pattern: "import.*Accordion.*from.*@/components/ui/accordion"
    - from: "frontend/src/components/review/sidebar.tsx"
      to: "frontend/src/components/review/risk-accordion.tsx"
      via: "import and render"
      pattern: "import.*RiskAccordion"
---

<objective>
Build the risk card and risk accordion components, then refactor the sidebar to use them.

Purpose: Replace the flat risk list (Phase 2 placeholder) with an interactive accordion matching the old sidebar.js behavior. Users need to expand individual risks to see full descriptions, cross-clause relationships, and include/exclude toggles. This is the core interaction pattern for the review workflow.

Output: risk-card.tsx, risk-accordion.tsx, and updated sidebar.tsx with full risk interaction.
</objective>

<execution_context>
@C:\Users\david\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\david\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-sidebar-risk-analysis/03-RESEARCH.md

@frontend/src/components/review/sidebar.tsx
@frontend/src/lib/store.ts
@frontend/src/lib/types.ts
@frontend/src/components/ui/accordion.tsx
@frontend/src/components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create risk-card.tsx and risk-accordion.tsx</name>
  <files>frontend/src/components/review/risk-card.tsx, frontend/src/components/review/risk-accordion.tsx</files>
  <action>
**risk-card.tsx** — A single risk item rendered inside an AccordionItem.

```
"use client";
```

Props interface:
```typescript
interface RiskCardProps {
  risk: Risk;
  riskMap: RiskMap | null;
  paraId: string;
  isIncluded: boolean;
  onToggleInclude: (riskId: string) => void;
  onHover: (riskId: string | null) => void;
  onFocus: (riskId: string) => void;
}
```

Structure:
- Wrap in `AccordionItem` with `value={risk.risk_id}`
- **AccordionTrigger** contains:
  - `SeverityBadgeWithEffective` component — shows base severity badge; if riskMap has effective_severity different from base_severity for this risk, show an arrow "BASE -> EFFECTIVE" with two badges
  - Risk title (truncated to 1 line with `truncate` class)
  - Risk type badge: "risk" in red-ish, "opportunity" in green-ish (using the `type` field from Risk)
- **AccordionContent** contains:
  - Description paragraph (text-xs leading-relaxed text-muted-foreground)
  - `highlight_text` display if present: quoted text in a small italic block styled with `text-xs italic border-l-2 border-muted pl-2 my-2`
  - `RiskRelationships` sub-component: shows "Mitigated by:" and "Amplified by:" with refs, only if relationships exist. Green text for mitigators, red for amplifiers. Uses riskMap data for the current para_id and risk_id.
  - Include/Exclude toggle: a small switch or checkbox. Label: "Include in revision". Use a `<button>` styled as a toggle with `text-xs`. When included, show checkmark + "Included". When excluded, show "Excluded" grayed out. This controls local UI state only (Phase 4 wires the actual revision generation).

Mouse events on the AccordionItem container div:
- `onMouseEnter` -> `onHover(risk.risk_id)`
- `onMouseLeave` -> `onHover(null)`

`SeverityBadgeWithEffective` implementation:
- Look up risk in `riskMap?.[paraId]` by matching `risk_id`
- If `riskData?.effective_severity && riskData.effective_severity !== riskData.base_severity`:
  - Render: `<BaseBadge> <ArrowRight icon size 3> <EffectiveBadge>`
- Otherwise render single severity badge
- Reuse the `SeverityBadge` component pattern from sidebar.tsx (copy the severity color mapping)

Export: `RiskCard` as named export, plus `SeverityBadge` as named export (other components will need it).

---

**risk-accordion.tsx** — Wraps a list of RiskCard components in a shadcn Accordion.

```
"use client";
```

Props:
```typescript
interface RiskAccordionProps {
  risks: Risk[];
  riskMap: RiskMap | null;
  paraId: string;
}
```

Implementation:
- Use local state `expandedRiskId` (string or empty string) for which risk is open
- Use local state `riskInclusions` as `Record<string, boolean>` — tracks include/exclude per risk_id. Default all to `true`.
- Get `setHoveredRiskId` and `setFocusedRiskId` from store (these will be added by Plan 01, but import them now — TypeScript will error until Plan 01 runs, which is fine since they're in the same wave and will be integrated)
  - ACTUALLY: since Plan 01 and 02 are Wave 1 (parallel), DO NOT import store setters that don't exist yet. Instead, define the onHover and onFocus as no-ops for now. Plan 04 (Wave 2) will wire the actual store connection.
  - Define: `const handleHover = (riskId: string | null) => { /* wired in Plan 04 */ };`
  - Define: `const handleFocus = (riskId: string) => { /* wired in Plan 04 */ };`

- Render shadcn `<Accordion type="single" collapsible value={expandedRiskId} onValueChange={setExpandedRiskId}>`
- Map over `risks` and render `<RiskCard>` for each
- Pass `isIncluded={riskInclusions[risk.risk_id] ?? true}`
- Pass `onToggleInclude` that flips the boolean in `riskInclusions` state

- Below the accordion, show footer summary:
  ```
  <div className="mt-3 pt-3 border-t text-xs text-muted-foreground">
    {includedCount} of {risks.length} risks selected for revision
  </div>
  ```

Export: `RiskAccordion` as named export.
  </action>
  <verify>
Run `npx tsc --noEmit` from `frontend/` — should compile (hover/focus handlers are local no-ops, no dependency on Plan 01 store changes). Read both files and verify: AccordionItem usage, severity badge with effective severity, relationships display, toggle state.
  </verify>
  <done>
risk-card.tsx renders a single risk with severity badge (effective arrow), description, highlight_text, relationships, and include/exclude toggle inside an AccordionItem. risk-accordion.tsx wraps risks in shadcn Accordion with single-expand behavior and inclusion tracking.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor sidebar.tsx to use RiskAccordion</name>
  <files>frontend/src/components/review/sidebar.tsx</files>
  <action>
Modify `sidebar.tsx` to replace the flat `RisksTabContent` with `RiskAccordion`:

1. **Add imports:**
   - `import { RiskAccordion } from "./risk-accordion";`
   - `import type { RiskMap } from "@/lib/types";` (already imports Risk)

2. **Add store selector for riskMap:**
   In the `Sidebar` component, add:
   ```typescript
   const riskMap = useAppStore((s) => s.riskMap);
   ```

3. **Replace RisksTabContent usage:**
   Change from:
   ```tsx
   <RisksTabContent risks={paraRisks} />
   ```
   To:
   ```tsx
   <RiskAccordion risks={paraRisks} riskMap={riskMap} paraId={selectedParaId!} />
   ```

4. **Remove old `RisksTabContent` and `SeverityBadge` components:**
   Delete the `RisksTabContent` function (lines ~176-201) and `SeverityBadge` function (lines ~203-221) since they're now in risk-card.tsx.

5. **Keep remaining sub-components:**
   Keep `EmptyState` component in sidebar.tsx (it's used by other tabs).

6. **Update the footer:**
   The footer currently shows risk count and a disabled "Generate Revision" button. Keep this as-is — the RiskAccordion now handles the per-risk inclusion count internally, and the footer button remains disabled until Phase 4.

7. **Keep all other sidebar functionality unchanged:**
   - Tab switching (risks, related, definitions, flags)
   - Header with section ref and caption
   - Toggle button when closed
   - Empty states for non-risks tabs (these get replaced in Plan 04)
  </action>
  <verify>
Run `npx tsc --noEmit` from `frontend/` — no type errors. Read sidebar.tsx and confirm: (1) imports RiskAccordion, (2) no more RisksTabContent or SeverityBadge defined locally, (3) passes riskMap and paraId to RiskAccordion, (4) EmptyState still present for other tabs.
  </verify>
  <done>
sidebar.tsx uses RiskAccordion for the risks tab. Old flat RisksTabContent and SeverityBadge removed. riskMap passed through from store. All other sidebar functionality preserved.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in frontend/ with zero errors
2. `npm run build` passes in frontend/
3. risk-card.tsx exports RiskCard and SeverityBadge
4. risk-accordion.tsx exports RiskAccordion, uses shadcn Accordion type="single"
5. sidebar.tsx imports and renders RiskAccordion, no duplicate SeverityBadge
</verification>

<success_criteria>
- Risk cards show severity badge with effective severity arrow when mitigators/amplifiers change severity
- Accordion expands one risk at a time (single + collapsible)
- Include/exclude toggle tracks state per risk locally
- Sidebar compiles and renders with the new RiskAccordion component
- No regressions in sidebar tab switching, header, or close behavior
</success_criteria>

<output>
After completion, create `.planning/phases/03-sidebar-risk-analysis/03-02-SUMMARY.md`
</output>
