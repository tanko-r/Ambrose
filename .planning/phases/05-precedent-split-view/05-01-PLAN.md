---
phase: 05-precedent-split-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/types.ts
  - frontend/src/lib/store.ts
  - frontend/src/hooks/use-precedent.ts
  - frontend/src/components/review/split-layout.tsx
  - frontend/src/app/globals.css
autonomous: true

must_haves:
  truths:
    - "Precedent state slice exists in Zustand store with lock, snippet queue, and navigator position"
    - "use-precedent hook loads precedent data, fetches related clauses, and manages snippet queue"
    - "SplitLayout wraps DocumentViewer and conditionally renders resizable panes"
    - "Panel sizes persist to localStorage across page reloads"
  artifacts:
    - path: "frontend/src/lib/types.ts"
      provides: "PrecedentSnippet, NavigatorPosition types"
      contains: "PrecedentSnippet"
    - path: "frontend/src/lib/store.ts"
      provides: "Precedent state slice with lock, snippets, navigator mode"
      contains: "lockedParaId"
    - path: "frontend/src/hooks/use-precedent.ts"
      provides: "Precedent data loading, related clause fetching, lock toggle, snippet queue management"
      exports: ["usePrecedent"]
    - path: "frontend/src/components/review/split-layout.tsx"
      provides: "Resizable split layout using react-resizable-panels v4"
      exports: ["SplitLayout"]
    - path: "frontend/src/app/globals.css"
      provides: "Precedent highlight and pulse animation CSS"
      contains: "clause-pulse"
  key_links:
    - from: "frontend/src/hooks/use-precedent.ts"
      to: "/api/precedent/{id}"
      via: "getPrecedent, getPrecedentHtml, getRelatedClauses from @/lib/api"
      pattern: "getPrecedent|getPrecedentHtml|getRelatedClauses"
    - from: "frontend/src/components/review/split-layout.tsx"
      to: "react-resizable-panels"
      via: "Group, Panel, Separator, useDefaultLayout imports"
      pattern: "from \"react-resizable-panels\""
    - from: "frontend/src/hooks/use-precedent.ts"
      to: "frontend/src/lib/store.ts"
      via: "useAppStore for precedent state reads/writes"
      pattern: "useAppStore"
---

<objective>
Foundation for the precedent split view: types, store state, data hook, resizable layout shell, and CSS animations.

Purpose: Establish all the shared state, data management, and layout primitives that Plan 02 (components) and Plan 03 (integration) depend on. No visual UI yet -- this plan creates the infrastructure.

Output: Extended types.ts, extended store.ts, use-precedent.ts hook, split-layout.tsx component, CSS for highlights/pulse.
</objective>

<execution_context>
@C:/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-precedent-split-view/05-CONTEXT.md
@.planning/phases/05-precedent-split-view/05-RESEARCH.md
@frontend/src/lib/types.ts
@frontend/src/lib/store.ts
@frontend/src/lib/api.ts
@frontend/src/hooks/use-revision.ts
@frontend/src/components/review/related-clauses-tab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Types + Store extensions for precedent state</name>
  <files>frontend/src/lib/types.ts, frontend/src/lib/store.ts</files>
  <action>
**types.ts** -- Add the following types at the end of the file, before the closing:

```typescript
// --- Precedent Split View ---

export type NavigatorPosition = 'right-sidebar' | 'bottom-drawer' | 'overlay';

export interface PrecedentSnippet {
  id: string;
  text: string;
  sourceParagraphId: string;
  sourceSection: string;
  targetParaId: string;
  timestamp: string;
}
```

**store.ts** -- Add a new `PrecedentState` interface and extend the store:

1. Add import for `PrecedentSnippet`, `NavigatorPosition`, `RelatedClause` to the existing import.

2. Define `PrecedentState` interface:
```typescript
interface PrecedentState {
  lockedParaId: string | null;
  lockedRelatedClauses: RelatedClause[] | null;
  precedentSnippets: PrecedentSnippet[];
  navigatorPosition: NavigatorPosition;
  precedentFilename: string | null;
  precedentParagraphs: Paragraph[];  // for navigator hierarchical display
  precedentSections: Section[];
}
```

3. Add to `AppStore` interface:
```typescript
// Precedent actions
setLockedParaId: (paraId: string | null) => void;
setLockedRelatedClauses: (clauses: RelatedClause[] | null) => void;
addPrecedentSnippet: (snippet: PrecedentSnippet) => void;
removePrecedentSnippet: (snippetId: string) => void;
clearPrecedentSnippets: (targetParaId?: string) => void;
setNavigatorPosition: (position: NavigatorPosition) => void;
setPrecedentData: (data: { filename: string; paragraphs: Paragraph[]; sections: Section[] }) => void;
openPrecedentPanel: () => void;
closePrecedentPanel: () => void;
```

4. Add initial state:
```typescript
const initialPrecedentState: PrecedentState = {
  lockedParaId: null,
  lockedRelatedClauses: null,
  precedentSnippets: [],
  navigatorPosition: 'right-sidebar',
  precedentFilename: null,
  precedentParagraphs: [],
  precedentSections: [],
};
```

5. Spread `initialPrecedentState` in the create() call. Add it to `resetSession` as well.

6. Implement actions:
- `setLockedParaId`: set lockedParaId. If setting to null, also clear lockedRelatedClauses.
- `setLockedRelatedClauses`: set lockedRelatedClauses.
- `addPrecedentSnippet`: append to precedentSnippets array.
- `removePrecedentSnippet`: filter out by snippet id.
- `clearPrecedentSnippets`: if targetParaId provided, filter out snippets for that target; otherwise clear all.
- `setNavigatorPosition`: set navigatorPosition.
- `setPrecedentData`: set precedentFilename, precedentParagraphs, precedentSections.
- `openPrecedentPanel`: set precedentPanelOpen to true (NOT toggle -- explicit open).
- `closePrecedentPanel`: set precedentPanelOpen to false, also clear lockedParaId and lockedRelatedClauses.

7. Replace the existing `togglePrecedentPanel` implementation to use the explicit open/close pattern but keep the function for backward compatibility (it still toggles).

Note: Load `navigatorPosition` from localStorage in a separate initialization effect in the page component (not in the store itself, since Zustand stores are synchronous). Plan 03 will handle persistence.
  </action>
  <verify>
Run `cd C:/Users/david/Documents/claude-redlining/frontend && npx tsc --noEmit` -- no type errors.
Verify the new types exist by grepping: `PrecedentSnippet`, `NavigatorPosition`, `lockedParaId`, `addPrecedentSnippet`.
  </verify>
  <done>
Types file has PrecedentSnippet and NavigatorPosition. Store has precedent state slice with lock, snippet queue, navigator position, and explicit open/close actions. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: use-precedent hook -- data loading, related clauses, lock, and snippet queue</name>
  <files>frontend/src/hooks/use-precedent.ts</files>
  <action>
Create `frontend/src/hooks/use-precedent.ts`. This is the primary data hook for the precedent feature. Follow the patterns from `use-revision.ts` and `use-document.ts`.

The hook should:

1. **Load precedent data on mount** (when sessionId exists and hasPrecedent is true):
   - Call `getPrecedent(sessionId)` to get structured content (paragraphs, sections, filename).
   - Call `getPrecedentHtml(sessionId)` to get rendered HTML.
   - Store results: `setDocument({ precedentHtml })` for the HTML, `setPrecedentData({ filename, paragraphs, sections })` for structured data.
   - Use a `loadedRef` to prevent re-fetching on re-renders (same pattern as use-document).
   - Set `loading` state during fetch.

2. **Fetch related clauses** for the currently selected paragraph:
   - Accept `paraId` (the target document paragraph) as a parameter or read from store.
   - Maintain a `Map<string, RelatedClause[]>` cache (useRef, same pattern as RelatedClausesTab's cacheRef).
   - When paraId changes (and hasPrecedent is true):
     - Check cache first. If cached, return immediately.
     - Otherwise call `getRelatedClauses(sessionId, paraId)`.
     - Store result in cache.
     - Sort results by similarity/score descending (best matches first -- per user decision, scores NOT shown to user).
   - Return the current related clauses array.
   - When locked: still fetch related clauses for the new paraId (for navigator pulse highlights), but return `lockedRelatedClauses` as the "active" clauses for content display.

3. **Lock/unlock clause**:
   - `toggleLock()`: If currently locked, unlock (set lockedParaId to null). If unlocked, lock current view (set lockedParaId to current focused precedent paragraph, set lockedRelatedClauses to current related clauses).
   - On unlock: re-fetch related clauses for the currently selected paraId to refresh the view (bypass cache by deleting the cache entry).

4. **Snippet queue management**:
   - `addSnippet(text, sourceParagraphId, sourceSection)`: Creates a PrecedentSnippet with a generated ID (crypto.randomUUID or Date.now fallback), the provided text, source info, and `targetParaId` from the currently selected paragraph in the store. Calls `addPrecedentSnippet` on the store.
   - `removeSnippet(snippetId)`: Calls `removePrecedentSnippet` on the store.
   - `clearSnippetsForPara(paraId)`: Calls `clearPrecedentSnippets(paraId)` on the store.
   - `getSnippetsForPara(paraId)`: Filters store's `precedentSnippets` by targetParaId.

5. **Return value**:
```typescript
return {
  loading,
  precedentHtml,          // from store
  precedentFilename,      // from store
  precedentParagraphs,    // from store
  precedentSections,      // from store
  relatedClauses,         // current related clauses (respects lock)
  allRelatedClauses,      // latest fetch (ignores lock -- for navigator pulse)
  isLocked,               // boolean
  lockedParaId,           // string | null
  toggleLock,
  addSnippet,
  removeSnippet,
  clearSnippetsForPara,
  getSnippetsForPara,
  snippetsForCurrentPara, // filtered for selectedParaId
};
```

IMPORTANT: Do NOT debounce related clause fetches -- user decision says "no debounce, immediate." The cache prevents redundant API calls.

IMPORTANT: Do NOT auto-scroll precedent content when paragraph changes -- user decision says NO auto-scroll.
  </action>
  <verify>
Run `cd C:/Users/david/Documents/claude-redlining/frontend && npx tsc --noEmit` -- no type errors.
Grep for `usePrecedent` to confirm the hook is exported.
  </verify>
  <done>
use-precedent.ts hook exists, exports usePrecedent, loads precedent data, fetches related clauses with caching, implements lock/unlock toggle, manages snippet queue. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 3: SplitLayout component + CSS for highlights and pulse animations</name>
  <files>frontend/src/components/review/split-layout.tsx, frontend/src/app/globals.css</files>
  <action>
**split-layout.tsx** -- Create using react-resizable-panels v4 API.

CRITICAL: Import directly from "react-resizable-panels" -- NOT from any shadcn wrapper. Use v4 names: `Group`, `Panel`, `Separator`, `useDefaultLayout`.

```typescript
"use client";

import { Group, Panel, Separator, useDefaultLayout } from "react-resizable-panels";
import { useAppStore } from "@/lib/store";

interface SplitLayoutProps {
  children: React.ReactNode;           // DocumentViewer (always rendered)
  precedentSlot?: React.ReactNode;     // PrecedentPanel (rendered when open)
}

export function SplitLayout({ children, precedentSlot }: SplitLayoutProps) {
  const precedentPanelOpen = useAppStore((s) => s.precedentPanelOpen);

  const { defaultLayout, onLayoutChanged } = useDefaultLayout({
    id: "precedent-split",
    storage: typeof window !== "undefined" ? localStorage : undefined,
  });

  // When precedent is closed, render just the document viewer at full width
  if (!precedentPanelOpen || !precedentSlot) {
    return <>{children}</>;
  }

  return (
    <Group
      orientation="horizontal"
      defaultLayout={defaultLayout}
      onLayoutChanged={onLayoutChanged}
    >
      <Panel id="main-doc" defaultSize="60%" minSize="35%">
        {children}
      </Panel>
      <Separator
        id="split-handle"
        className="w-1.5 bg-border hover:bg-primary/30 active:bg-primary/50 transition-colors data-[resize-handle-active]:bg-primary/50"
      />
      <Panel id="precedent" defaultSize="40%" minSize="25%">
        {precedentSlot}
      </Panel>
    </Group>
  );
}
```

Key details:
- `defaultSize="60%"` and `"40%"` are strings per v4 API (strings without explicit unit assumed to be percentages).
- `useDefaultLayout` with `id: "precedent-split"` handles localStorage persistence automatically.
- Use `onLayoutChanged` (not deprecated `onLayoutChange`) per the v4 type definitions.
- SSR safety: pass `storage` only when `window` is defined.
- The Separator gets a thin 6px (w-1.5) visual handle with hover/active states.

**globals.css** -- Append at the end of the file the following CSS for precedent features:

```css
/* ==========================================================================
   Precedent Split View
   ========================================================================== */

/* Related clause highlight in precedent content */
[data-para-id].related-clause {
  border-left: 3px solid oklch(0.546 0.215 264);
  background: oklch(0.95 0.02 264 / 0.12);
  transition: background-color 300ms ease;
}

[data-para-id].related-clause-locked {
  border-left: 3px solid oklch(0.546 0.215 264);
  background: oklch(0.93 0.04 264 / 0.18);
}

/* Pulse animation for navigator items when related clauses update */
@keyframes clause-pulse {
  0%, 100% { background-color: transparent; }
  50% { background-color: oklch(0.546 0.215 264 / 0.12); }
}

.pulse-highlight {
  animation: clause-pulse 750ms ease-in-out 2;
}

/* Flash animation for precedent content scroll-to target */
@keyframes clause-flash {
  0% { background-color: oklch(0.546 0.215 264 / 0.25); }
  100% { background-color: transparent; }
}

.flash-highlight {
  animation: clause-flash 1s ease-out 1;
}

/* Sidebar restore tab (when collapsed for precedent view) */
.sidebar-restore-tab {
  position: fixed;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  z-index: 30;
}

/* Sidebar overlay (when expanded during precedent view) */
.sidebar-overlay {
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  z-index: 40;
  width: 380px;
}

/* Precedent navigator matched item indicator */
.nav-match-dot::before {
  content: '';
  display: inline-block;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: oklch(0.546 0.215 264);
  margin-right: 6px;
  flex-shrink: 0;
}

/* Precedent selection tooltip */
.precedent-selection-tooltip {
  pointer-events: auto;
}

/* react-resizable-panels separator styling */
[data-panel-group] > [data-resize-handle] {
  position: relative;
}

[data-panel-group] > [data-resize-handle]::after {
  content: '';
  position: absolute;
  inset: 0 -2px;
}
```
  </action>
  <verify>
Run `cd C:/Users/david/Documents/claude-redlining/frontend && npx tsc --noEmit` -- no type errors.
Run `cd C:/Users/david/Documents/claude-redlining/frontend && npx next build 2>&1 | tail -20` to verify the build succeeds (or at minimum `tsc` passes).
Grep for `SplitLayout` to confirm it is exported.
Grep globals.css for `clause-pulse` to confirm CSS was added.
  </verify>
  <done>
SplitLayout component renders resizable panes via react-resizable-panels v4 Group/Panel/Separator. Panel sizes persist to localStorage via useDefaultLayout. CSS contains highlight classes, pulse/flash animations, sidebar overlay positioning, and navigator match indicators. TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
After all three tasks:
1. `npx tsc --noEmit` passes with zero errors
2. Store has all precedent state: lockedParaId, precedentSnippets, navigatorPosition, precedentFilename, precedentParagraphs, precedentSections
3. usePrecedent hook exports loading, relatedClauses, lock toggle, snippet management
4. SplitLayout conditionally renders split panes when precedentPanelOpen is true
5. CSS contains clause-pulse, clause-flash, sidebar-overlay, nav-match-dot, related-clause classes
</verification>

<success_criteria>
- Types.ts has PrecedentSnippet and NavigatorPosition types
- Store.ts has full PrecedentState interface with 8+ new actions
- use-precedent.ts hook manages data loading, related clause fetching with cache, lock/unlock, and snippet queue
- split-layout.tsx uses react-resizable-panels v4 API correctly (Group/Panel/Separator/useDefaultLayout)
- globals.css has all precedent CSS classes and animations
- Full TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-precedent-split-view/05-01-SUMMARY.md`
</output>
