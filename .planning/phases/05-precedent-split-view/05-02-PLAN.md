---
phase: 05-precedent-split-view
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/src/components/review/precedent-content.tsx
  - frontend/src/components/review/precedent-navigator.tsx
  - frontend/src/components/review/precedent-panel.tsx
  - frontend/src/components/review/precedent-selection-tooltip.tsx
autonomous: true

must_haves:
  truths:
    - "Precedent HTML renders faithfully with paragraph click handlers and related clause highlights"
    - "Navigator shows hierarchical paragraph list with search filter and match indicators"
    - "Clicking a navigator item scrolls precedent content to that clause with flash animation"
    - "Text selection in precedent shows floating tooltip with Copy, Use in Revision, Flag for Reference"
    - "Lock icon toggle freezes the precedent view on the current clause"
  artifacts:
    - path: "frontend/src/components/review/precedent-content.tsx"
      provides: "Precedent document HTML rendering with imperative highlight handlers"
      exports: ["PrecedentContent"]
    - path: "frontend/src/components/review/precedent-navigator.tsx"
      provides: "Hierarchical paragraph navigator with search, match indicators, position modes"
      exports: ["PrecedentNavigator"]
    - path: "frontend/src/components/review/precedent-panel.tsx"
      provides: "Assembled precedent panel with header, content, and navigator"
      exports: ["PrecedentPanel"]
    - path: "frontend/src/components/review/precedent-selection-tooltip.tsx"
      provides: "Floating tooltip for text selection actions in precedent"
      exports: ["PrecedentSelectionTooltip"]
  key_links:
    - from: "frontend/src/components/review/precedent-content.tsx"
      to: "frontend/src/hooks/use-precedent.ts"
      via: "usePrecedent hook for HTML, related clauses, lock state"
      pattern: "usePrecedent"
    - from: "frontend/src/components/review/precedent-selection-tooltip.tsx"
      to: "@floating-ui/react-dom"
      via: "useFloating with virtual element from selection range"
      pattern: "useFloating"
    - from: "frontend/src/components/review/precedent-navigator.tsx"
      to: "frontend/src/lib/store.ts"
      via: "precedentParagraphs, precedentSections, navigatorPosition from store"
      pattern: "useAppStore"
    - from: "frontend/src/components/review/precedent-panel.tsx"
      to: "frontend/src/components/review/precedent-content.tsx"
      via: "Composes PrecedentContent and PrecedentNavigator"
      pattern: "PrecedentContent|PrecedentNavigator"
---

<objective>
Build the four precedent panel components: HTML content renderer, hierarchical navigator, assembled panel, and text selection tooltip.

Purpose: These are the visual components that the user interacts with. They consume the hook and store state from Plan 01 and will be wired into the page layout in Plan 03.

Output: Four new component files in `frontend/src/components/review/`.
</objective>

<execution_context>
@C:/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-precedent-split-view/05-CONTEXT.md
@.planning/phases/05-precedent-split-view/05-RESEARCH.md
@.planning/phases/05-precedent-split-view/05-01-SUMMARY.md
@frontend/src/lib/types.ts
@frontend/src/lib/store.ts
@frontend/src/hooks/use-precedent.ts
@frontend/src/components/review/document-viewer.tsx
@frontend/src/components/review/navigation-panel.tsx
@frontend/src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: PrecedentContent -- HTML rendering with highlights and click handlers</name>
  <files>frontend/src/components/review/precedent-content.tsx, frontend/src/components/review/precedent-selection-tooltip.tsx</files>
  <action>
**precedent-content.tsx** -- Renders the precedent document HTML with imperative event handlers. Follows the exact same pattern as `DocumentViewer` (dangerouslySetInnerHTML + requestAnimationFrame + click handlers).

Structure:
```
"use client";
export function PrecedentContent({ onScrollToClause }: PrecedentContentProps) { ... }
```

Props:
- `onScrollToClause?: (paraId: string) => void` -- callback when user clicks a paragraph (for navigator coordination).

Implementation:
1. Read `precedentHtml` from store via `useAppStore((s) => s.precedentHtml)`.
2. Read related clause data from `usePrecedent()` hook: `relatedClauses`, `allRelatedClauses`, `isLocked`.
3. Render HTML using `dangerouslySetInnerHTML` in a container div with `ref={containerRef}`.
4. In a `useEffect` (same pattern as DocumentViewer), after HTML is set, use `requestAnimationFrame` to:
   - Query all `[data-para-id]` elements.
   - Attach click handlers that call `onScrollToClause?.(paraId)`.
5. In a separate `useEffect` triggered by `relatedClauses` changes:
   - Remove all existing `.related-clause` and `.related-clause-locked` classes from all `[data-para-id]` elements.
   - For each clause in the active related clauses array, find the element with matching `data-para-id` and add `.related-clause` class (or `.related-clause-locked` if `isLocked`).
6. Expose a `scrollToClause(paraId: string)` function via `useImperativeHandle` (forwardRef) so the parent can programmatically scroll to a specific clause. The scroll function:
   - Finds the `[data-para-id="..."]` element.
   - Calls `element.scrollIntoView({ behavior: "smooth", block: "center" })`.
   - Adds `.flash-highlight` class, removes it after 1 second via setTimeout.
7. Integrate `PrecedentSelectionTooltip` -- render it inside the content area, passing `containerRef`.

Loading state: Show `Skeleton` placeholder if `precedentHtml` is null.

Container styling: `className="flex-1 overflow-y-auto bg-secondary/30"` with inner `className="mx-auto max-w-3xl rounded border bg-card p-10 my-6 shadow-sm"` -- matching DocumentViewer layout.

**precedent-selection-tooltip.tsx** -- Floating tooltip that appears on text selection within the precedent content area.

Implementation:
1. Use `@floating-ui/react-dom`: import `useFloating`, `offset`, `flip`, `shift` from `"@floating-ui/react-dom"`.
2. Accept props: `containerRef: React.RefObject<HTMLDivElement | null>`.
3. Maintain state: `isOpen`, `selectedText`.
4. In `useEffect`, listen for `mouseup` on `containerRef.current`:
   - Get `window.getSelection()`.
   - If selection is collapsed, empty, or not within the container, hide tooltip.
   - Otherwise, set `selectedText`, create virtual reference element from `selection.getRangeAt(0).getBoundingClientRect()`, show tooltip.
5. Also listen for `mousedown` on document to close tooltip when clicking outside.
6. Also dismiss on scroll within the container (selection often collapses on scroll).
7. Render three action buttons in a compact horizontal bar:
   - **Copy**: `navigator.clipboard.writeText(selectedText)` then `toast.success("Copied to clipboard")`.
   - **Use in Revision**: Determine the source paragraph ID by finding the closest `[data-para-id]` ancestor of the selection anchor node. Call `usePrecedent().addSnippet(selectedText, sourceParagraphId, sourceSection)`. Toast: "Added to revision queue". Clear selection.
   - **Flag for Reference**: Call `flagItem` from `@/lib/api` using the existing generic flag mechanism. Pass: `session_id` from store, `para_id` set to the currently selected TARGET paragraph (from `selectedParaId` in the store), `note` containing a reference to the precedent clause (e.g., "Precedent ref: [sourceSection] - [first 80 chars of selected text]..."), and `flag_type: 'attorney'` as a sensible default. Do NOT implement any two-category flag UI or flag type selection -- that is Phase 6's responsibility. Toast: "Flagged for reference". Clear selection.
8. Styling: compact row of `Button variant="secondary" size="sm"` with lucide icons (Copy, FileInput, Flag). White background, shadow-lg, rounded-lg, z-50.

IMPORTANT: Use `refs.setPositionReference()` with a virtual element object `{ getBoundingClientRect: () => range.getBoundingClientRect() }` -- NOT `refs.setReference()` which expects a DOM element.

IMPORTANT: The tooltip must have `pointer-events: auto` (already in CSS as `.precedent-selection-tooltip` class) so the buttons are clickable.
  </action>
  <verify>
Run `cd C:/Users/david/Documents/claude-redlining/frontend && npx tsc --noEmit` -- no type errors.
Grep for `PrecedentContent` and `PrecedentSelectionTooltip` to confirm exports.
  </verify>
  <done>
PrecedentContent renders backend HTML with dangerouslySetInnerHTML, attaches imperative click handlers via requestAnimationFrame, applies related-clause highlight classes, exposes scrollToClause via forwardRef. PrecedentSelectionTooltip shows floating actions (Copy, Use in Revision, Flag for Reference) on text selection using @floating-ui/react-dom virtual element positioning. Flag for Reference uses existing flagItem API with default flag_type, no two-category UI (deferred to Phase 6). TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: PrecedentNavigator -- hierarchical paragraph list with search and match indicators</name>
  <files>frontend/src/components/review/precedent-navigator.tsx</files>
  <action>
Create the navigator component that displays a hierarchical, searchable list of precedent paragraphs. This is similar in concept to `NavigationPanel` but for the precedent document.

Structure:
```
"use client";
export function PrecedentNavigator({ onNavigate, relatedParaIds, pulsingParaIds }: PrecedentNavigatorProps) { ... }
```

Props:
- `onNavigate: (paraId: string) => void` -- scroll precedent content to this clause.
- `relatedParaIds: Set<string>` -- currently matched clause IDs (for blue dot indicators).
- `pulsingParaIds: Set<string>` -- newly updated matches (for pulse animation).

Implementation:

1. **Data source**: Read `precedentParagraphs`, `precedentSections`, `navigatorPosition` from the store.

2. **Search box**: `Input` component at top with a search icon. Filters paragraphs by text content (case-insensitive substring match).

3. **Match filter toggle**: A small toggle button next to search ("Show matches only"). When active, only paragraphs whose `id` is in `relatedParaIds` are shown.

4. **Hierarchical display**: Build a tree from `precedentSections` and `precedentParagraphs`:
   - Each section has a level (0, 1, 2...) determining indentation.
   - Paragraphs are grouped under their parent section.
   - Each item shows: indentation (left padding per level, e.g., `pl-{level * 4}`), section number, caption.
   - **Captions**: Use `section_hierarchy` caption if available. Since backend caption generation is DEFERRED (out of scope), fall back to first ~60 characters of paragraph text, truncated with ellipsis.
   - Headings (`type: "heading"`) display their text as-is (they are natural section captions).

5. **Match indicators**: Items whose `id` is in `relatedParaIds` get the `.nav-match-dot` class (CSS adds a blue dot before the text). Items in `pulsingParaIds` additionally get the `.pulse-highlight` class (auto-removes after animation via `onAnimationEnd` handler or a 1.5s timeout).

6. **Click behavior**: Clicking an item calls `onNavigate(paraId)`.

7. **Position modes** (per user decision -- three modes persisted to localStorage):
   - **Right sidebar** (default): Navigator renders as a scrollable column to the right of the precedent content, within the precedent panel. Width: ~220px, shrink-0, border-left.
   - **Bottom drawer**: Navigator renders below the precedent content, height ~200px, border-top.
   - **Overlay toggle**: Navigator renders as a floating overlay panel (z-30, absolute positioning within precedent panel) triggered by a toggle button. Can be dismissed by clicking outside or the toggle button.

   The component receives its position from the store's `navigatorPosition`. The container/wrapper styling changes per mode, but the internal list component is the same.

8. **Position toggle UI**: A small segmented button group in the navigator header with three icon buttons:
   - `PanelRight` icon (sidebar mode)
   - `PanelBottom` icon (drawer mode)
   - `Layers` icon (overlay mode)
   Use `lucide-react` icons. Highlight the active mode. On click, call `setNavigatorPosition` on the store.

9. **Empty state**: If no precedent paragraphs loaded, show "Loading precedent document..." or "No precedent document."

Styling: Match the visual hierarchy of `NavigationPanel` -- compact text (text-xs), rounded items, hover background, selected state with primary color.
  </action>
  <verify>
Run `cd C:/Users/david/Documents/claude-redlining/frontend && npx tsc --noEmit` -- no type errors.
Grep for `PrecedentNavigator` to confirm export.
  </verify>
  <done>
PrecedentNavigator displays hierarchical paragraph list with text search, match-only filter, blue dot indicators for matched clauses, pulse animation for newly updated matches, three position modes (right sidebar, bottom drawer, overlay) with segmented toggle, and click-to-navigate. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 3: PrecedentPanel -- assembled panel with header bar, lock toggle, content + navigator composition</name>
  <files>frontend/src/components/review/precedent-panel.tsx</files>
  <action>
Create the top-level precedent panel component that composes PrecedentContent and PrecedentNavigator, plus the header bar.

Structure:
```
"use client";
export function PrecedentPanel() { ... }
```

Implementation:

1. **Hook usage**: Call `usePrecedent()` to get all state: `precedentFilename`, `relatedClauses`, `allRelatedClauses`, `isLocked`, `toggleLock`, `loading`.

2. **Header bar** (per user decision: "filename header bar showing precedent document name + close button"):
   - Left: precedent document filename (from `precedentFilename`), truncated with ellipsis if long. Fallback: "Precedent Document".
   - Center/right area:
     - **Lock toggle**: Button with `Lock` or `Unlock` icon (lucide-react). Tooltip: "Lock to current clause" / "Unlock". On click: `toggleLock()`. Visual state: when locked, the lock icon is filled/primary color.
     - **Close button**: Button with `X` icon. On click: `closePrecedentPanel()` from store.
   - Styling: `h-10 border-b px-3 flex items-center justify-between bg-card`. Filename in `text-sm font-medium truncate`.

3. **Keyboard shortcut**: Add `useEffect` that listens for `Escape` key -- calls `closePrecedentPanel()`. Also listen for `Ctrl+Shift+P` (or `Meta+Shift+P` on Mac) to toggle the panel.

4. **Content + Navigator layout** (depends on navigator position mode):
   - Read `navigatorPosition` from store.
   - **Right sidebar mode**: Flex row. Left: `PrecedentContent` (flex-1). Right: `PrecedentNavigator` (w-[220px] shrink-0 border-l).
   - **Bottom drawer mode**: Flex column. Top: `PrecedentContent` (flex-1). Bottom: `PrecedentNavigator` (h-[200px] shrink-0 border-t).
   - **Overlay mode**: `PrecedentContent` fills the space. `PrecedentNavigator` renders as an absolute overlay triggered by a toggle button in the header.

5. **Related clause coordination**:
   - Compute `relatedParaIds = new Set(relatedClauses.map(c => c.para_id))`.
   - Compute `pulsingParaIds`: Track which paraIds are NEW since the last update. Use a `useRef` to store the previous set, compute the diff, and pass as `pulsingParaIds`. Clear pulsing state after 1.5 seconds.
   - When user clicks a navigator item: call `contentRef.current?.scrollToClause(paraId)` (using the forwardRef from PrecedentContent).

6. **Initial scroll on open**: When the precedent panel first opens (triggered from Related tab clicking a clause link), the store should have the target clause ID. Read it and call `scrollToClause` on mount. The target clause ID will be passed through the store or as a prop from the page (Plan 03 will wire this). For now, accept an optional prop `initialScrollTarget?: string` and scroll to it on first render.

7. **Loading state**: If `loading` is true, show a full-panel skeleton (matching the content + navigator layout with Skeleton components).

Overall panel structure:
```
<div className="flex h-full flex-col bg-card">
  {/* Header */}
  <header>...</header>
  {/* Content + Navigator */}
  <div className="flex flex-1 overflow-hidden">
    {/* Layout varies by navigatorPosition */}
  </div>
</div>
```
  </action>
  <verify>
Run `cd C:/Users/david/Documents/claude-redlining/frontend && npx tsc --noEmit` -- no type errors.
Grep for `PrecedentPanel` to confirm export.
Verify PrecedentPanel imports and uses PrecedentContent and PrecedentNavigator.
  </verify>
  <done>
PrecedentPanel composes header (filename + lock toggle + close button), PrecedentContent, and PrecedentNavigator. Header shows lock state, Escape closes panel. Navigator position determines layout (row/column/overlay). Related clause IDs are computed and passed to navigator with pulse tracking for new matches. TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
After all three tasks:
1. `npx tsc --noEmit` passes with zero errors
2. PrecedentContent renders backend HTML, attaches click handlers, applies highlight classes, exposes scrollToClause
3. PrecedentSelectionTooltip shows on text selection with Copy / Use in Revision / Flag for Reference actions
4. PrecedentNavigator displays hierarchical list with search, match filter, position modes, and pulse highlights
5. PrecedentPanel assembles everything with header bar, lock toggle, close button, and keyboard shortcuts
6. All components follow existing codebase patterns (dangerouslySetInnerHTML, requestAnimationFrame, useAppStore)
7. Flag for Reference uses existing flagItem API -- no two-category flag UI (Phase 6)
</verification>

<success_criteria>
- All four component files exist and export their named components
- PrecedentContent follows DocumentViewer's dangerouslySetInnerHTML + requestAnimationFrame pattern
- PrecedentSelectionTooltip uses @floating-ui/react-dom useFloating with virtual element
- PrecedentNavigator has search, match filter toggle, three position modes, and pulse animation
- PrecedentPanel composes all sub-components with header/lock/close/keyboard shortcuts
- Flag for Reference uses existing flagItem API with default flag_type (no category UI)
- Full TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-precedent-split-view/05-02-SUMMARY.md`
</output>
