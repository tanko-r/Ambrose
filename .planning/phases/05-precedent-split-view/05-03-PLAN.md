---
phase: 05-precedent-split-view
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - frontend/src/app/review/[sessionId]/page.tsx
  - frontend/src/components/review/sidebar.tsx
  - frontend/src/components/review/related-clauses-tab.tsx
  - frontend/src/lib/store.ts
autonomous: false

must_haves:
  truths:
    - "Review page wraps DocumentViewer + PrecedentPanel in SplitLayout"
    - "Clicking a related clause in the sidebar opens the precedent panel scrolled to that clause"
    - "When precedent opens, sidebar auto-collapses to a thin restore tab on the left"
    - "Sidebar expands as overlay on hover/click without closing precedent"
    - "Generate button shows badge count of queued precedent snippets"
    - "Bottom sheet coexists with precedent panel -- overlays the bottom of both panes"
    - "User can open, resize, navigate, and close precedent panel end-to-end"
  artifacts:
    - path: "frontend/src/app/review/[sessionId]/page.tsx"
      provides: "Review page with SplitLayout wrapping DocumentViewer and PrecedentPanel"
      contains: "SplitLayout"
    - path: "frontend/src/components/review/sidebar.tsx"
      provides: "Sidebar with overlay mode when precedent is open, snippet badge on generate button"
      contains: "sidebar-overlay"
    - path: "frontend/src/components/review/related-clauses-tab.tsx"
      provides: "Clickable related clause cards that open precedent panel"
      contains: "openPrecedentPanel"
    - path: "frontend/src/lib/store.ts"
      provides: "precedentScrollTarget field and setter for clause-click-to-open flow"
      contains: "precedentScrollTarget"
  key_links:
    - from: "frontend/src/app/review/[sessionId]/page.tsx"
      to: "frontend/src/components/review/split-layout.tsx"
      via: "SplitLayout wrapping DocumentViewer children"
      pattern: "SplitLayout"
    - from: "frontend/src/components/review/related-clauses-tab.tsx"
      to: "frontend/src/lib/store.ts"
      via: "openPrecedentPanel action on clause click"
      pattern: "openPrecedentPanel"
    - from: "frontend/src/components/review/sidebar.tsx"
      to: "frontend/src/lib/store.ts"
      via: "precedentPanelOpen for overlay/collapse behavior, snippetsForCurrentPara for badge"
      pattern: "precedentPanelOpen"
---

<objective>
Wire the precedent panel into the review page layout. Modify the sidebar for overlay/collapse behavior when precedent is open. Update the Related tab to open the precedent panel on clause click. Add snippet badge to the Generate button.

Purpose: This is the integration plan that connects all the pieces built in Plans 01 and 02 into a working end-to-end experience. After this plan, the full precedent split view workflow is functional.

Output: Modified review page, sidebar, and related clauses tab.
</objective>

<execution_context>
@C:/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-precedent-split-view/05-CONTEXT.md
@.planning/phases/05-precedent-split-view/05-RESEARCH.md
@.planning/phases/05-precedent-split-view/05-01-SUMMARY.md
@.planning/phases/05-precedent-split-view/05-02-SUMMARY.md
@frontend/src/app/review/[sessionId]/page.tsx
@frontend/src/components/review/sidebar.tsx
@frontend/src/components/review/related-clauses-tab.tsx
@frontend/src/components/review/split-layout.tsx
@frontend/src/components/review/precedent-panel.tsx
@frontend/src/hooks/use-precedent.ts
@frontend/src/lib/store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Review page layout -- integrate SplitLayout and PrecedentPanel</name>
  <files>frontend/src/app/review/[sessionId]/page.tsx</files>
  <action>
Modify the review page to wrap DocumentViewer inside SplitLayout with PrecedentPanel.

Current layout:
```
<div className="flex h-screen flex-col">
  <Header />
  <div className="flex flex-1 overflow-hidden">
    <NavigationPanel />
    <DocumentViewer loading={loading} />
    <Sidebar />
  </div>
  <RevisionSheet />
  <BottomBar />
  <AnalysisOverlay />
</div>
```

New layout:
```
<div className="flex h-screen flex-col">
  <Header />
  <div className="flex flex-1 overflow-hidden">
    <NavigationPanel />
    <SplitLayout precedentSlot={<PrecedentPanel />}>
      <DocumentViewer loading={loading} />
    </SplitLayout>
    <Sidebar />  {/* sidebar is OUTSIDE the split layout */}
  </div>
  <RevisionSheet />
  <BottomBar />
  <AnalysisOverlay />
</div>
```

Key changes:
1. Import `SplitLayout` from `@/components/review/split-layout`.
2. Import `PrecedentPanel` from `@/components/review/precedent-panel`.
3. Wrap `<DocumentViewer loading={loading} />` inside `<SplitLayout precedentSlot={<PrecedentPanel />}>`.
4. The Sidebar stays OUTSIDE the SplitLayout (it's a separate flex column on the right, or an overlay when precedent is open -- handled by the sidebar component itself).

Additionally:
5. Initialize precedent data: Call `usePrecedent()` hook at the page level (or rely on it being called inside PrecedentPanel). The hook auto-loads precedent data when sessionId and hasPrecedent are available.
6. Initialize `navigatorPosition` from localStorage on mount:
```typescript
useEffect(() => {
  const saved = localStorage.getItem('precedent-navigator-position');
  if (saved && ['right-sidebar', 'bottom-drawer', 'overlay'].includes(saved)) {
    useAppStore.getState().setNavigatorPosition(saved as NavigatorPosition);
  }
}, []);
```
7. Persist navigatorPosition changes to localStorage: Subscribe to store changes or add a small effect.

The RevisionSheet (bottom sheet) stays at the page level, OUTSIDE both the SplitLayout and Sidebar. Since it uses `fixed inset-x-0 bottom-0` positioning, it naturally overlays the bottom of both panes. No change needed for RevisionSheet.
  </action>
  <verify>
Run `cd C:/Users/david/Documents/claude-redlining/frontend && npx tsc --noEmit` -- no type errors.
Verify the page imports SplitLayout and PrecedentPanel.
  </verify>
  <done>
Review page wraps DocumentViewer in SplitLayout with PrecedentPanel as the precedent slot. Navigator position initializes from localStorage. RevisionSheet stays at page level overlaying both panes. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Sidebar overlay/collapse when precedent is open</name>
  <files>frontend/src/components/review/sidebar.tsx</files>
  <action>
**sidebar.tsx** -- Implement three sidebar modes based on precedentPanelOpen state:

1. **Normal mode** (precedent closed): Current behavior, no changes. Sidebar renders as a 380px aside in the flex layout.

2. **Collapsed mode** (precedent open, sidebar closed): Instead of the current right-edge restore tab, render a thin left-edge restore tab:
   - Position: `fixed left-0 top-1/2 -translate-y-1/2 z-30` (sidebar-restore-tab class).
   - Appearance: Small rounded-r tab with `PanelRightOpen` icon.
   - On hover/click: set `sidebarOpen` to true (sidebar enters overlay mode).

3. **Overlay mode** (precedent open, sidebar open): Sidebar renders as a fixed overlay on the LEFT side:
   - Position: `fixed top-[var(--header-height)] left-0 bottom-0 z-40 w-[380px]` (sidebar-overlay class).
   - The header height should match the `Header` component height. Use a CSS variable or hardcode `top-[49px]` (matching the h-12 header + border).
   - Add a semi-transparent backdrop behind the sidebar (optional, could also just have a shadow). Use `shadow-2xl` for a strong right-edge shadow.
   - Clicking outside the overlay (on the backdrop) collapses the sidebar.
   - The overlay must NOT affect the SplitLayout -- it sits on top via z-index.

Implementation detail:
- Read `precedentPanelOpen` from store.
- When `precedentPanelOpen` changes to `true`, auto-collapse the sidebar: `useEffect` that sets `sidebarOpen = false` when `precedentPanelOpen` becomes true.
- The `!sidebarOpen` branch now checks `precedentPanelOpen`:
  - If `precedentPanelOpen`: show left-edge restore tab.
  - If `!precedentPanelOpen`: show right-edge restore tab (existing behavior).
- The `sidebarOpen` branch now checks `precedentPanelOpen`:
  - If `precedentPanelOpen`: render as overlay (sidebar-overlay class).
  - If `!precedentPanelOpen`: render normally (existing aside element).
  </action>
  <verify>
Run `cd C:/Users/david/Documents/claude-redlining/frontend && npx tsc --noEmit` -- no type errors.
Verify sidebar.tsx references `precedentPanelOpen` and has overlay/collapse logic.
  </verify>
  <done>
Sidebar auto-collapses when precedent opens, shows left-edge restore tab, expands as z-40 overlay without closing precedent. Existing normal mode behavior is unchanged when precedent is closed. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 3: Related tab opens precedent + snippet badge on Generate button</name>
  <files>frontend/src/components/review/related-clauses-tab.tsx, frontend/src/lib/store.ts</files>
  <action>
**store.ts** -- Add a small extension for the clause-click-to-open flow:
- Add `precedentScrollTarget: string | null` to PrecedentState (initial: null).
- Add `setPrecedentScrollTarget: (paraId: string | null) => void` to AppStore interface and implement it.
- PrecedentPanel (already built in Plan 02) reads this on mount and scrolls to it, then clears it.

**related-clauses-tab.tsx** -- Make clause cards clickable to open the precedent panel:

1. Import `openPrecedentPanel`, `setPrecedentScrollTarget` from store via `useAppStore`.
2. Each clause card becomes clickable:
   - On click: call `setPrecedentScrollTarget(clause.para_id)`, then call `openPrecedentPanel()`.
   - This tells PrecedentPanel where to scroll when it opens.
3. Update the "no related clauses" state: Instead of just showing a message, show a single "Open Precedent" link/button that opens the precedent panel without a scroll target (per user decision: "If no related clauses found for the current paragraph, show a single 'Open Precedent' link").
4. REMOVE the similarity percentage display (`{Math.round(clause.similarity * 100)}% match`). Per user decision: "Match confidence scores are NOT shown to the user." The clauses are already sorted by similarity (best first) from the API.
5. Add a subtle hover state and cursor-pointer to the clause cards to indicate they are clickable.
6. Add a small arrow or "View in precedent" affordance to each card (e.g., a small `ExternalLink` or `ArrowRight` icon on the right side).

**Snippet badge on Generate button** (in sidebar.tsx):
- Read `precedentSnippets` from store, filter by `selectedParaId` to get `snippetsForPara`.
- In the sidebar footer, next to the Generate button, if `snippetsForPara.length > 0`:
  - Show a small `Badge` with the count (e.g., "2 refs") next to or on the Generate button.
  - Make the badge clickable to show a small dropdown/popover listing the queued snippets with an X to remove each.
  - When generating, pass the snippets as `customInstruction` to the `generate()` call:
    ```typescript
    const snippetTexts = snippetsForPara.map(s => s.text);
    const customInstruction = snippetTexts.length > 0
      ? `Incorporate the following precedent language where appropriate:\n${snippetTexts.map((t, i) => `${i + 1}. "${t}"`).join('\n')}`
      : undefined;
    generate(selectedParaId, riskIds, undefined, customInstruction);
    ```
  </action>
  <verify>
Run `cd C:/Users/david/Documents/claude-redlining/frontend && npx tsc --noEmit` -- no type errors.
Verify related-clauses-tab.tsx calls `openPrecedentPanel` and does NOT show similarity percentages.
Verify store.ts has `precedentScrollTarget` field and setter.
Verify sidebar.tsx shows snippet badge on Generate button.
  </verify>
  <done>
Related clauses tab cards are clickable to open precedent scrolled to that clause via precedentScrollTarget store field. "Open Precedent" link shown when no matches. Similarity percentages removed. Generate button shows snippet badge count with removal dropdown. TypeScript compiles.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: End-to-end verification of precedent split view</name>
  <files>none</files>
  <action>
Human verification of the full precedent split view feature built across all three plans.

What was built:
- Resizable split pane (60/40 default) with persistent sizes
- Precedent panel with header (filename + lock toggle + close button)
- Precedent HTML rendering with related clause highlights
- Hierarchical navigator with search, match filter, three position modes
- Text selection tooltip (Copy, Use in Revision, Flag for Reference)
- Sidebar auto-collapses to left restore tab when precedent opens
- Sidebar expands as overlay on click/hover
- Related tab clause cards open precedent scrolled to that clause
- "Open Precedent" link when no related clauses found
- Lock toggle freezes precedent view on current clause
- Snippet queue with badge on Generate button
- Escape key closes precedent panel
- Bottom sheet coexists with precedent (overlays bottom of both panes)

Verification steps:
1. Start both servers: Flask on :5000, Next.js on :3000
2. Load a test session that has a precedent document uploaded
3. Navigate to the review page
4. Click a paragraph in the main document
5. Go to the "Related" tab in the sidebar
6. Verify: Related clause cards appear WITHOUT similarity percentages
7. Click a related clause card
8. Verify: Precedent panel opens on the right (40% width), scrolled to the clicked clause
9. Verify: Sidebar collapses to a thin tab on the left edge
10. Click the sidebar restore tab
11. Verify: Sidebar expands as an overlay (z-index above document, below bottom sheet)
12. Click outside the sidebar overlay to dismiss it
13. Resize the split pane by dragging the handle
14. Refresh the page and reopen precedent
15. Verify: Split pane sizes are restored from localStorage
16. Click the Lock icon in the precedent header
17. Click a different paragraph in the main document
18. Verify: Precedent content stays focused on the locked clause; navigator items pulse
19. Unlock by clicking the lock icon again
20. Select text in the precedent document
21. Verify: Floating tooltip appears with Copy, Use in Revision, Flag for Reference
22. Click "Use in Revision" -- verify toast and badge appears on Generate button
23. Click the badge to see queued snippets; remove one
24. Press Escape to close the precedent panel
25. Verify: Sidebar returns to normal (non-overlay) position
26. Open precedent when no related clauses are found for a paragraph
27. Verify: "Open Precedent" link is shown and works
  </action>
  <verify>Human performs the verification steps above.</verify>
  <done>Human confirms "approved" or provides issues to fix.</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npx tsc --noEmit` passes
2. Review page layout includes SplitLayout wrapping DocumentViewer
3. Sidebar has three modes: normal, collapsed (left tab), overlay (z-40)
4. Related tab clause cards open precedent panel on click
5. Similarity percentages removed from related clause cards
6. Generate button shows snippet badge count
7. Bottom sheet overlays both panes correctly
8. Keyboard shortcut (Escape) closes the panel
9. End-to-end workflow: click clause -> open precedent -> lock -> navigate -> select text -> copy/use in revision -> close
</verification>

<success_criteria>
- Review page renders SplitLayout with PrecedentPanel when precedentPanelOpen is true
- Sidebar auto-collapses to left restore tab when precedent opens
- Sidebar expands as overlay (z-40) without affecting split layout
- Related clause cards are clickable, opening precedent scrolled to the clause
- "Open Precedent" link shown when no related clauses found
- Match scores NOT displayed to user
- Snippet badge on Generate button with removal UI
- Bottom sheet coexists at page level overlaying both panes
- Human verification checkpoint passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-precedent-split-view/05-03-SUMMARY.md`
</output>
