---
phase: 06-analysis-acceleration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/content_filter.py
  - app/services/claude_service.py
  - app/api/routes.py
autonomous: true

must_haves:
  truths:
    - "Blank paragraphs under 20 characters are never sent to Claude"
    - "Signature blocks are detected and skipped"
    - "Notice address blocks are detected and skipped"
    - "Exhibit content is skipped when user selected 'ignore exhibits' in intake"
    - "Section-only headers without substantive text are skipped"
  artifacts:
    - path: "app/services/content_filter.py"
      provides: "ContentFilter class for pre-analysis filtering"
      exports: ["ContentFilter"]
    - path: "app/services/claude_service.py"
      provides: "Updated analyze_document_with_llm using ContentFilter"
      contains: "content_filter"
  key_links:
    - from: "app/services/claude_service.py"
      to: "app/services/content_filter.py"
      via: "import and instantiation"
      pattern: "from app.services.content_filter import ContentFilter"
    - from: "app/services/content_filter.py"
      to: "session include_exhibits setting"
      via: "constructor parameter"
      pattern: "include_exhibits"
---

<objective>
Implement content pre-filtering to eliminate 30-40% of unnecessary API calls by detecting and skipping non-substantive paragraphs before LLM analysis.

Purpose: Dramatically reduce analysis time by not sending blank paragraphs, signature blocks, notice addresses, pure headers, and exhibit content (when user opted out) to Claude.

Output: ContentFilter service that integrates with the existing analysis pipeline.
</objective>

<execution_context>
@C:\Users\david\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\david\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-analysis-acceleration/06-RESEARCH.md

Key context from research:
- ContentFilter class pattern is already defined in research (see Code Examples section)
- Key patterns: SKIP_PATTERNS, CONDITIONAL_SKIP, EXHIBIT_START
- Must track "in_exhibit_section" state as we iterate through paragraphs
- Returns tuple (should_analyze: bool, skip_reason: str)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ContentFilter service</name>
  <files>app/services/content_filter.py</files>
  <action>
Create `app/services/content_filter.py` implementing the ContentFilter class from the research document.

The class must:
1. Accept `include_exhibits: bool` in constructor (default False)
2. Track `in_exhibit_section` state that persists across paragraph iterations
3. Implement `should_analyze(paragraph: Dict) -> Tuple[bool, str]` method
4. Implement `filter_content(paragraphs: List[Dict]) -> Tuple[List[Dict], Dict]` method
5. Use regex patterns for detection:
   - SKIP_PATTERNS: blank, page_break, header_only (always skip)
   - CONDITIONAL_SKIP: signature_block, notice_address, exhibit_header
   - EXHIBIT_START: Pattern to detect start of exhibit section
6. Reset `in_exhibit_section` to False at start of filter_content()
7. Return skip statistics for logging/debugging

Key patterns from research:
```python
SKIP_PATTERNS = {
    'blank': r'^\s*$',
    'page_break': r'^-{3,}$|^_{3,}$',
    'header_only': r'^(ARTICLE|SECTION)\s+[IVXLCDM\d]+\.?\s*$',
}
CONDITIONAL_SKIP = {
    'signature_block': r'(?i)(IN WITNESS WHEREOF|EXECUTED|signature block)',
    'notice_address': r'(?i)^(If to (Seller|Buyer|Purchaser|Landlord|Tenant):?\s*$|Attention:|Attn:|Address:)',
    'exhibit_header': r'(?i)^EXHIBIT\s+[A-Z0-9]+\s*$',
}
EXHIBIT_START = r'^(?i)EXHIBIT\s+[A-Z0-9]+\s*$'
```

Also skip paragraphs under 20 characters (too_short).

Include docstrings explaining each pattern and the overall filtering strategy.
  </action>
  <verify>
Run: `python -c "from app.services.content_filter import ContentFilter; cf = ContentFilter(include_exhibits=False); print('ContentFilter imported successfully')"`

Should print success message without import errors.
  </verify>
  <done>ContentFilter class exists with should_analyze() and filter_content() methods, using regex patterns for blank, signature, notice, header, and exhibit detection</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ContentFilter into claude_service</name>
  <files>app/services/claude_service.py</files>
  <action>
Modify `analyze_document_with_llm()` in `app/services/claude_service.py` to:

1. Add `include_exhibits: bool = False` parameter to function signature
2. Import ContentFilter at top of file: `from app.services.content_filter import ContentFilter`
3. Before the existing paragraph extraction loop, instantiate ContentFilter:
   ```python
   content_filter = ContentFilter(include_exhibits=include_exhibits)
   ```
4. Replace the existing paragraph filtering logic:
   ```python
   # OLD: paragraphs = [item for item in parsed_doc.get('content', []) if item.get('type') == 'paragraph' and len(item.get('text', '').strip()) > 50]

   # NEW: Use ContentFilter
   all_paragraphs = [item for item in parsed_doc.get('content', []) if item.get('type') == 'paragraph']
   paragraphs, skip_stats = content_filter.filter_content(all_paragraphs)
   ```
5. Add skip_stats to progress update for visibility:
   ```python
   update_progress(session_id, {
       ...
       'skip_stats': skip_stats,
       'total_skipped': sum(skip_stats.values()),
       ...
   })
   ```
6. Include skip_stats in the final analysis summary:
   ```python
   'summary': {
       ...
       'paragraphs_skipped': sum(skip_stats.values()),
       'skip_breakdown': skip_stats,
       ...
   }
   ```

Keep ALL existing functionality intact. This is additive - we're enhancing the filter, not replacing the analysis logic.
  </action>
  <verify>
Run: `python -c "from app.services.claude_service import analyze_document_with_llm; print('claude_service with ContentFilter integration imported successfully')"`

Should print success message without import errors.
  </verify>
  <done>analyze_document_with_llm() uses ContentFilter to pre-filter paragraphs, reports skip statistics in progress and summary</done>
</task>

<task type="auto">
  <name>Task 3: Wire include_exhibits from intake to analysis</name>
  <files>app/api/routes.py</files>
  <action>
Modify the `/api/analysis/<session_id>` endpoint in `app/api/routes.py` to pass the `include_exhibits` setting from the session to the analysis function.

Find the call to `analyze_document_with_llm()` (around line 295-301) and add the include_exhibits parameter:

```python
analysis = analyze_document_with_llm(
    parsed_doc=session.get('parsed_doc'),
    contract_type=session.get('contract_type', 'general'),
    representation=session.get('representation', 'seller'),
    aggressiveness=session.get('aggressiveness', 3),
    batch_size=5,
    session_id=session_id,
    include_exhibits=session.get('include_exhibits', False)  # ADD THIS
)
```

The `include_exhibits` value is already captured in the intake endpoint (line 121) and stored in the session. We're just passing it through to the analysis.
  </action>
  <verify>
Search routes.py for "include_exhibits" - should appear in both intake handler (existing) and analysis handler (new).

Run: `grep -n "include_exhibits" app/api/routes.py` should show at least 2 occurrences.
  </verify>
  <done>Analysis endpoint passes include_exhibits from session to analyze_document_with_llm, enabling exhibit skipping when user opted out</done>
</task>

</tasks>

<verification>
1. ContentFilter class can be imported without errors
2. claude_service.py imports and uses ContentFilter
3. routes.py passes include_exhibits to analysis function
4. No regressions in existing analysis (regex fallback still works)
</verification>

<success_criteria>
1. Blank paragraphs (< 20 chars) are filtered before LLM analysis
2. Signature blocks matching pattern are filtered
3. Notice address blocks matching pattern are filtered
4. When include_exhibits=False, paragraphs after EXHIBIT header are filtered
5. Skip statistics are visible in analysis progress and summary
6. Existing analysis functionality unchanged for substantive paragraphs
</success_criteria>

<output>
After completion, create `.planning/phases/06-analysis-acceleration/06-01-SUMMARY.md`
</output>
