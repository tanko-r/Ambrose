---
phase: 06-analysis-acceleration
task: experimental
total_tasks: 4+experimental
status: experimentation_complete
last_updated: 2026-02-04T12:00:00
---

<current_state>
Phase 6 core (4 plans) was complete. User requested experimentation with alternative analysis approach using Gemini instead of Claude for batch analysis, plus a new "v3 category-based framework" for better risk analysis quality.

We implemented and tested v3 approach which changes:
1. Initial analysis (Claude Opus) produces category-based risk FRAMEWORK, not granular risks
2. Paragraph map includes obligations, rights, conditions, party_bound, party_benefits
3. Defined terms include FULL text (no truncation)
4. Batch analysis (Gemini) does granular risk finding within the category framework

The v3 changes are now integrated into the live app and tested.
</current_state>

<completed_work>
- Phase 6 Plans 01-04: Complete (content filtering, initial analysis, parallel forking, progress UI)
- v3 experimentation scripts: Created in `Gemini-Analysis-Approach-Prompts/`
  - `run_example_analysis_v1.py` - Basic condensed context approach
  - `run_example_analysis_v2.py` - Added ContentFilter, granular paragraph map
  - `run_example_analysis_v3.py` - Category-based risk framework (final approach)
- v3 integration into live app:
  - `initial_analyzer.py` - Updated with RISK_CATEGORIES, normalize_contract_type(), v3 prompts
  - `parallel_analyzer.py` - Updated with v3 condensed context batch prompts
  - `claude_service.py` - Updated to pass representation/contract_type to parallel analyzer
- Live test: Ran full analysis on PSA document
  - 586 seconds total (~9 min 46 sec)
  - 197 paragraphs analyzed, 192 skipped
  - 220 risks found (43 high, 81 medium, 72 info)
  - 45 defined terms extracted
  - 39/40 batches successful
</completed_work>

<remaining_work>
- v3 is experimental - may want to tune prompts further based on quality review
- Consider if timing (~10 min) is acceptable vs original target (~90 sec)
- The initial Claude Opus analysis is the bottleneck - produces 100K+ char response
- May need to optimize initial analysis prompt to reduce response size
- Changes not yet committed to branch
</remaining_work>

<decisions_made>
- Switched batch analysis from Claude to Gemini due to Claude Opus rate limits (30K tokens/min)
- v3 category-based framework: Initial analysis provides risk CATEGORIES, batches do granular finding
- RISK_CATEGORIES dict per contract type (PSA has 12 categories, Lease has 12, etc.)
- Contract type normalization: 'psa' -> 'Purchase and Sale Agreement' for prompt clarity
- Paragraph map includes obligations/rights/conditions/party_bound/party_benefits for better context
- Full definition text (no truncation) to avoid context loss
</decisions_made>

<blockers>
- None currently. v3 is working but quality/performance tradeoffs TBD.
</blockers>

<context>
User (David, real estate attorney) wanted to improve analysis quality. The original approach was doing granular risk analysis in both initial and batch phases, which was redundant.

The v3 insight: Initial analysis should produce a FRAMEWORK (categories, where they appear, exposure levels) and batches should do granular risk finding within that framework. This matches how a senior attorney would review a contract - first get the lay of the land, then dive into details.

The test run found 220 risks in a PSA. Quality needs human review to confirm the category-based approach produces better results than the original.

Key files for v3:
- `app/services/initial_analyzer.py` - RISK_CATEGORIES, v3 prompts
- `app/services/parallel_analyzer.py` - v3 batch prompts with condensed context
- `Gemini-Analysis-Approach-Prompts/` - Example scripts and outputs
</context>

<next_action>
Start with: Review the actual risk quality from the v3 analysis. Compare v3 outputs (in `Gemini-Analysis-Approach-Prompts/v3_*.md`) against v2 outputs to see if category-based framework produces better results. If satisfied, commit the v3 changes. If not, iterate on prompts.

Alternative: If timing is the concern, consider reducing the initial analysis prompt scope to speed up Claude Opus response.
</next_action>
