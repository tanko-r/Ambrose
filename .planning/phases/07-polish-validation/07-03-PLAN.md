---
phase: 07-polish-validation
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - frontend/src/components/review/sidebar.tsx
  - frontend/src/components/review/bottom-bar.tsx
  - frontend/src/components/review/document-viewer.tsx
  - frontend/src/components/review/risk-card.tsx
  - frontend/src/components/review/navigation-panel.tsx
  - frontend/src/components/error-boundary.tsx
  - frontend/src/hooks/use-delayed-loading.ts
  - frontend/src/app/globals.css
autonomous: true

must_haves:
  truths:
    - "Analysis loading shows progress bar with percentage and status text updates"
    - "Quick async operations show skeleton screens that do not flash for instant responses"
    - "Errors display a friendly message with expandable technical details"
    - "Empty states guide users to next action (e.g., 'Select a paragraph to see its analysis')"
    - "Bottom bar has filter toggle buttons for revisions, flags, and risks"
    - "Compact mode toggle reduces card padding/margins in sidebar and bottom bar"
  artifacts:
    - path: "frontend/src/components/error-boundary.tsx"
      provides: "React error boundary with user-friendly error display"
      min_lines: 30
    - path: "frontend/src/hooks/use-delayed-loading.ts"
      provides: "Hook to delay skeleton screen display to avoid flashes"
      min_lines: 15
  key_links:
    - from: "frontend/src/components/review/sidebar.tsx"
      to: "frontend/src/lib/store.ts"
      via: "compactMode read for spacing"
      pattern: "compactMode"
    - from: "frontend/src/components/review/bottom-bar.tsx"
      to: "frontend/src/lib/store.ts"
      via: "Filter state for visibility toggles"
      pattern: "showRevisions|showFlags|showRisks"
---

<objective>
Add loading states with delayed skeletons, error boundaries with expandable details, empty state guidance text, bottom bar filter toggles, and compact mode visual implementation across sidebar and bottom bar.

Purpose: These are the UX polish items that transform the app from functional to production-quality. Loading states prevent confusion during async ops, error boundaries prevent blank screens, empty states guide new users, filters help power users focus, and compact mode increases information density.
Output: Polished review experience with professional loading/error/empty handling, working bottom bar filters, and compact mode visual changes.
</objective>

<execution_context>
@C:/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish-validation/07-RESEARCH.md
@frontend/src/components/review/sidebar.tsx
@frontend/src/components/review/bottom-bar.tsx
@frontend/src/components/review/risk-card.tsx
@frontend/src/components/review/analysis-overlay.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Error boundary, delayed skeleton hook, and empty/loading/error states across review components</name>
  <files>
    frontend/src/components/error-boundary.tsx
    frontend/src/hooks/use-delayed-loading.ts
    frontend/src/components/review/sidebar.tsx
    frontend/src/components/review/document-viewer.tsx
    frontend/src/components/review/risk-card.tsx
    frontend/src/components/review/navigation-panel.tsx
  </files>
  <action>
    1. Create `frontend/src/hooks/use-delayed-loading.ts`:
       - Hook: `useDelayedLoading(isLoading: boolean, delay?: number): boolean`
       - Default delay: 200ms
       - Returns `showSkeleton` boolean
       - When `isLoading` becomes true, start a timer; only set showSkeleton=true after delay
       - When `isLoading` becomes false, immediately set showSkeleton=false
       - This prevents a flash of skeleton content for instant responses

    2. Create `frontend/src/components/error-boundary.tsx`:
       - React class component (error boundaries must be class components)
       - Catches render errors and displays a friendly UI
       - Error display pattern per locked decisions:
         ```
         <div className="rounded-lg border border-destructive/50 bg-destructive/5 p-4">
           <p className="text-sm font-medium text-destructive">Something went wrong</p>
           <p className="text-sm text-muted-foreground mt-1">{friendlyMessage}</p>
           <details className="mt-2">
             <summary className="text-xs text-muted-foreground cursor-pointer">Technical details</summary>
             <pre className="mt-1 text-xs text-muted-foreground bg-muted p-2 rounded overflow-x-auto">{error.message}\n{error.stack}</pre>
           </details>
           <Button variant="outline" size="sm" className="mt-3" onClick={resetErrorBoundary}>Try Again</Button>
         </div>
         ```
       - Export both the class component and a reusable `<ErrorDisplay error={Error} />` function component for inline use

    3. Add empty states to sidebar.tsx:
       - When no paragraph is selected AND no risks exist: "Upload a contract and run analysis to see risk details here."
       - When no paragraph is selected AND risks exist: "Select a paragraph in the document to see its risk analysis."
       - When paragraph is selected but has no risks: "No risks identified for this clause. It looks good!"
       - Use muted text with a helpful icon (e.g., Info or CheckCircle)

    4. Add empty/loading states to navigation-panel.tsx:
       - When paragraphs array is empty: "No document loaded. Start by uploading a contract."
       - Loading state: Use skeleton list items (3-5 lines of varying width) with useDelayedLoading hook

    5. Add skeleton state to risk-card.tsx:
       - Export a `RiskCardSkeleton` component: rounded card with pulsing lines (title, severity badge, 2-line description)
       - Use shadcn Skeleton component (already in ui/skeleton.tsx)

    6. Add loading/error states to document-viewer.tsx:
       - When documentHtml is null and not loading: empty state guidance
       - When loading: use Skeleton component for a few block elements
       - Wrap content rendering in ErrorBoundary
       - Use useDelayedLoading to prevent skeleton flash

    IMPORTANT per locked decisions:
    - Error handling: Friendly message + expandable technical details (hybrid tone for "lawyers comfortable with tech")
    - Empty states: Inline help text (educational), guide users to next action
    - Skeleton screens: Avoid flash of skeleton on instant responses (200ms delay)
  </action>
  <verify>
    - `cd frontend && npm run build` completes without errors
    - error-boundary.tsx exports ErrorBoundary class component and ErrorDisplay function component
    - use-delayed-loading.ts exports useDelayedLoading hook
    - sidebar.tsx shows empty state text when no paragraph selected
    - navigation-panel.tsx shows empty state when no document loaded
  </verify>
  <done>
    Error boundary catches render errors with friendly + technical details display, skeleton screens delay 200ms before showing, empty states provide educational guidance in sidebar, navigation panel, and document viewer.
  </done>
</task>

<task type="auto">
  <name>Task 2: Bottom bar filter toggles and compact mode visual implementation</name>
  <files>
    frontend/src/components/review/bottom-bar.tsx
    frontend/src/lib/store.ts
    frontend/src/components/review/sidebar.tsx
    frontend/src/components/review/risk-card.tsx
    frontend/src/app/globals.css
  </files>
  <action>
    1. Add filter state to store.ts UIState:
       - Add `showRisks: boolean` (default: true)
       - Add `showRevisions: boolean` (default: true)
       - Add `showFlags: boolean` (default: true)
       - Add toggle actions: `toggleShowRisks`, `toggleShowRevisions`, `toggleShowFlags`
       - These control what's visible in the navigator panel and potentially filter sidebar content

    2. Add filter toggle buttons to bottom-bar.tsx:
       - Add a filter group between the left progress section and center navigation:
       - Three small pill-style toggle buttons:
         a. "Risks" pill with risk icon (AlertTriangle) -- toggles showRisks
         b. "Revisions" pill with edit icon (Pencil) -- toggles showRevisions
         c. "Flags" pill with flag icon (Flag) -- toggles showFlags
       - Active state: filled/primary background. Inactive: outline/ghost.
       - Style: `text-xs px-2 py-0.5 rounded-full border` with transition
       - These filters affect what's shown in the navigator panel (filter the list of paragraphs)

    3. Wire filters into navigation-panel.tsx:
       - Read showRisks, showRevisions, showFlags from store
       - When filtering is active, only show paragraphs matching active filters
       - If all filters are off, show all paragraphs (safety fallback)

    4. Implement compact mode CSS in globals.css:
       - Per locked decision: card spacing only -- reduce padding/margins in sidebar cards and bottom bar. No font size changes, no icon removal.
       - Add `.compact` class-based overrides:
         ```css
         /* Compact mode - reduced spacing per user decision */
         .compact .risk-card-container { padding: 0.5rem 0.75rem; }
         .compact .sidebar-card { padding: 0.5rem 0.75rem; }
         .compact .sidebar-content { gap: 0.25rem; }
         .compact .bottom-bar-container { padding-top: 0.25rem; padding-bottom: 0.25rem; }
         ```
       - OR use Tailwind conditional classes directly in components (preferred for type safety):
         - In sidebar.tsx: apply `cn("gap-2", compactMode && "gap-1")` to card containers
         - In risk-card.tsx: apply `cn("p-3", compactMode && "p-2")` to card wrapper
         - In bottom-bar.tsx: apply `cn("h-11 px-4", compactMode && "h-9 px-3")` to bar

    5. Apply `.compact` class to the app container:
       - In the review page or a layout wrapper, add `compact` class to a container element when `compactMode` is true in the store
       - Alternatively, use Tailwind conditional classes directly in each component (read compactMode from store)

    6. Verify bottom bar still hides when revision sheet is open (existing behavior).

    IMPORTANT per locked decisions:
    - Bottom bar filters: show/hide revisions, flags, and risks
    - Compact mode: Card spacing only, no font size changes, no icon removal
  </action>
  <verify>
    - `cd frontend && npm run build` completes without errors
    - store.ts has showRisks, showRevisions, showFlags in UIState with toggle actions
    - bottom-bar.tsx renders three filter toggle pills
    - Toggling compact mode reduces card padding in sidebar and bottom bar height
    - Navigation panel respects filter toggles
  </verify>
  <done>
    Bottom bar has three filter toggle buttons (risks, revisions, flags) that filter navigator content. Compact mode reduces card padding/margins and bottom bar height without changing fonts or removing icons.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` passes
2. Open review page with no document -- empty state messages appear in sidebar and navigator
3. Load a document, select paragraph with no risks -- "No risks" empty state appears
4. Toggle compact mode in settings -- card spacing visibly reduces
5. Click filter pills in bottom bar -- navigator panel filters accordingly
6. Intentionally trigger an error (e.g., corrupt data) -- error boundary shows friendly message with expandable details
</verification>

<success_criteria>
- Error boundary catches render errors and shows friendly + technical details
- Skeleton screens delay 200ms before displaying (no flash)
- Empty states in sidebar, navigator, and document viewer guide users
- Three filter pills in bottom bar control navigator visibility
- Compact mode reduces spacing in sidebar cards and bottom bar
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-validation/07-03-SUMMARY.md`
</output>
