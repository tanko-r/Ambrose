---
phase: 07-polish-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/hooks/use-keyboard-shortcuts.ts
  - frontend/src/components/command-palette.tsx
  - frontend/src/components/keyboard-help.tsx
  - frontend/src/app/review/page.tsx
autonomous: true

must_haves:
  truths:
    - "Cmd/Ctrl+K opens command palette with fuzzy search across all app actions"
    - "? key (when not typing) opens keyboard shortcuts help dialog"
    - "Keyboard shortcuts for navigation (J/K), panel toggles ([/]), and actions (F, G) work when not in text inputs"
    - "Shortcuts do NOT fire when user is typing in text fields, inputs, or contentEditable areas"
    - "Command palette lists all available actions with their keyboard shortcut hints"
    - "Escape closes any open dialog, panel, or sheet"
  artifacts:
    - path: "frontend/src/hooks/use-keyboard-shortcuts.ts"
      provides: "Global keyboard shortcut registration via react-hotkeys-hook"
      min_lines: 40
    - path: "frontend/src/components/command-palette.tsx"
      provides: "Cmd/Ctrl+K command palette with categorized actions"
      min_lines: 60
    - path: "frontend/src/components/keyboard-help.tsx"
      provides: "? key help dialog showing all shortcuts"
      min_lines: 40
  key_links:
    - from: "frontend/src/hooks/use-keyboard-shortcuts.ts"
      to: "frontend/src/lib/store.ts"
      via: "Store actions dispatched by shortcuts"
      pattern: "useAppStore|toggleNavPanel|toggleSidebar|selectParagraph"
    - from: "frontend/src/components/command-palette.tsx"
      to: "frontend/src/lib/store.ts"
      via: "Command items trigger store actions"
      pattern: "useAppStore"
    - from: "frontend/src/app/review/page.tsx"
      to: "frontend/src/hooks/use-keyboard-shortcuts.ts"
      via: "Hook called in review page"
      pattern: "useKeyboardShortcuts"
---

<objective>
Add keyboard shortcuts, a command palette (Cmd/Ctrl+K), and a keyboard help dialog (? key) to the review page, enabling power-user workflows for contract review navigation.

Purpose: Keyboard shortcuts and command palette are core Phase 7 deliverables per locked decisions. They make common actions (navigate risks, toggle panels, flag clauses) accessible without mouse interaction.
Output: 12 keyboard shortcuts, command palette with fuzzy search, help dialog showing all shortcuts.
</objective>

<execution_context>
@C:/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish-validation/07-RESEARCH.md
@frontend/src/lib/store.ts
@frontend/src/app/review/page.tsx
@frontend/src/components/review/bottom-bar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, create keyboard shortcuts hook, and wire to review page</name>
  <files>
    frontend/src/hooks/use-keyboard-shortcuts.ts
    frontend/src/app/review/page.tsx
  </files>
  <action>
    1. Install react-hotkeys-hook and shadcn Command component:
       ```
       cd frontend
       npm install react-hotkeys-hook
       npx shadcn@latest add command
       ```
       Note: `npx shadcn@latest add command` will install cmdk as a dependency and create `frontend/src/components/ui/command.tsx`

    2. Create `frontend/src/hooks/use-keyboard-shortcuts.ts`:
       - "use client" module
       - Import `useHotkeys` from react-hotkeys-hook
       - Import store actions from useAppStore
       - Accept callbacks for: openCommandPalette, openHelpDialog, openSettings
       - Register these shortcuts (all with `enableOnFormTags: false` for single-char keys):

       | Shortcut | Action | Notes |
       |----------|--------|-------|
       | `mod+k` | openCommandPalette() | Prevent default browser behavior |
       | `shift+/` (which is ?) | openHelpDialog() | Not in form fields |
       | `[` | toggleNavPanel() | Store action |
       | `]` | toggleSidebar() | Store action |
       | `j` | Navigate to next risk paragraph | Use store's risks + paragraphs to find next |
       | `k` | Navigate to previous risk paragraph | Use store's risks + paragraphs to find prev |
       | `f` | Open flag dialog for current paragraph | Only when selectedParaId exists |
       | `g` | Generate revision for current paragraph | Only when selectedParaId exists |
       | `escape` | Close current dialog/panel/sheet | Close bottomSheet > sidebar > navPanel (priority order) |
       | `mod+,` | openSettings() | Standard settings shortcut |
       | `mod+\\` | toggleBottomSheet() | Toggle revision sheet |

       For J/K navigation:
       - Get `risks`, `paragraphs`, `selectedParaId`, `selectParagraph` from store
       - Build sorted list of paragraph IDs that have risks
       - Find current index, advance to next/prev, call selectParagraph

       For Escape:
       - Check if bottomSheetOpen -> close it first
       - Then check if any dialog is open (this may need a ref or state)
       - Fall through to no-op if nothing is open

       IMPORTANT: Use `enableOnFormTags: false` for ALL single-character shortcuts (j, k, f, g, [, ], ?). Modifier shortcuts (mod+k, mod+,, mod+\\) are naturally safe. This prevents shortcuts from firing in text inputs, textareas, and contentEditable elements.

    3. Wire the hook into the review page:
       - In `frontend/src/app/review/page.tsx`, call `useKeyboardShortcuts()` at the top level
       - Pass in state setters for command palette open, help dialog open, settings open
       - These will be connected to the components built in Task 2
  </action>
  <verify>
    - `cd frontend && npm run build` completes without errors
    - `frontend/src/components/ui/command.tsx` exists (shadcn command component)
    - `frontend/src/hooks/use-keyboard-shortcuts.ts` exports useKeyboardShortcuts
    - The hook registers 11+ shortcuts
    - Review page calls useKeyboardShortcuts
  </verify>
  <done>
    Keyboard shortcuts hook created with 11 shortcuts, wired into the review page. Single-char shortcuts disabled in form fields. Command component installed via shadcn.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create command palette and keyboard help dialog</name>
  <files>
    frontend/src/components/command-palette.tsx
    frontend/src/components/keyboard-help.tsx
    frontend/src/app/review/page.tsx
  </files>
  <action>
    1. Create `frontend/src/components/command-palette.tsx`:
       - "use client" component
       - Props: `open: boolean, onOpenChange: (v: boolean) => void`
       - Uses shadcn CommandDialog, CommandInput, CommandList, CommandEmpty, CommandGroup, CommandItem, CommandSeparator
       - Groups:
         a. **Navigation**: Toggle Navigator Panel (shortcut hint: `[`), Toggle Sidebar (`]`), Next Risk (`J`), Previous Risk (`K`), Toggle Revision Sheet (`Ctrl+\`)
         b. **Actions**: Flag Current Clause (`F`), Generate Revision (`G`), Finalize Redline, Generate Transmittal
         c. **View**: Toggle Compact Mode, Open Settings (`Ctrl+,`), Toggle Precedent Panel
         d. **Help**: Keyboard Shortcuts (`?`)
       - Each CommandItem has:
         - An icon from lucide-react (appropriate to action)
         - Action label text
         - Right-aligned shortcut hint in a `<kbd>` styled element (e.g., `<kbd className="ml-auto text-xs text-muted-foreground bg-muted px-1.5 py-0.5 rounded">⌘K</kbd>`)
       - On item select: dispatch appropriate store action and close the palette
       - Display platform-aware modifier key (Cmd on Mac, Ctrl on Windows):
         - Detect platform: `typeof navigator !== 'undefined' && navigator.platform?.includes('Mac')`
         - Show `⌘` for Mac, `Ctrl` for Windows

    2. Create `frontend/src/components/keyboard-help.tsx`:
       - "use client" component
       - Props: `open: boolean, onOpenChange: (v: boolean) => void`
       - Uses shadcn Dialog (not CommandDialog)
       - Title: "Keyboard Shortcuts"
       - Organized table/grid layout showing all shortcuts:
         - Section: "Navigation" -- [, ], J, K, Escape
         - Section: "Actions" -- F, G, Cmd+\\, Cmd+K
         - Section: "Settings" -- ?, Cmd+,
       - Each row: left-aligned action description, right-aligned `<kbd>` element(s)
       - Style `<kbd>` elements consistently: `inline-flex items-center justify-center h-5 min-w-[1.25rem] px-1 text-xs font-mono border rounded bg-muted`
       - Platform-aware modifier display (same detection as command palette)
       - Close on Escape (Dialog handles this automatically)

    3. Update `frontend/src/app/review/page.tsx`:
       - Add state for command palette open/close: `const [cmdPaletteOpen, setCmdPaletteOpen] = useState(false)`
       - Add state for help dialog open/close: `const [helpOpen, setHelpOpen] = useState(false)`
       - Add state for settings dialog open/close (if not already connected from Plan 01): `const [settingsOpen, setSettingsOpen] = useState(false)`
       - Render CommandPalette and KeyboardHelp components at end of JSX tree
       - Pass open state setters to useKeyboardShortcuts hook
       - Add inline shortcut hints to existing buttons where appropriate:
         - Navigator toggle button tooltip: "Toggle Navigator ["
         - Sidebar toggle button tooltip: "Toggle Sidebar ]"
         - (Only add to buttons that already have tooltips or are obvious candidates)

    IMPORTANT per locked decisions:
    - Command palette is the primary discovery mechanism -- list ALL actions with shortcuts
    - Global scope only -- shortcuts always do the same thing regardless of focus
    - Inline hints in tooltips (add where natural, don't force into every button)
  </action>
  <verify>
    - `cd frontend && npm run build` completes without errors
    - command-palette.tsx renders CommandDialog with 4 groups of actions
    - keyboard-help.tsx renders Dialog with organized shortcut reference
    - Review page renders both components
    - Shortcut hints show platform-appropriate modifier key
  </verify>
  <done>
    Command palette (Cmd/Ctrl+K) with fuzzy search and 12+ actions, keyboard help dialog (? key) with organized shortcut reference, both rendered in review page and connected to keyboard shortcuts hook.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` passes
2. Open review page, press Cmd/Ctrl+K -- command palette opens with fuzzy search
3. Type "flag" in palette -- Flag Current Clause item appears
4. Press ? -- help dialog shows all shortcuts with correct modifier keys
5. Press [ and ] -- navigator and sidebar toggle
6. Press J/K -- navigate between risk paragraphs
7. Click into revision editor text field, press J -- no navigation happens (form field protection)
8. Press Escape -- closes open dialog/panel
</verification>

<success_criteria>
- 11+ keyboard shortcuts registered and functional
- Command palette opens with Cmd/Ctrl+K, has fuzzy search, lists all actions with shortcut hints
- Help dialog opens with ? key, shows organized shortcut reference
- Shortcuts disabled in text inputs and contentEditable areas
- Platform-aware modifier key display (Cmd on Mac, Ctrl on Windows)
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-validation/07-02-SUMMARY.md`
</output>
