---
phase: 07-polish-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/app/globals.css
  - frontend/src/app/layout.tsx
  - frontend/src/components/providers/theme-provider.tsx
  - frontend/src/lib/store.ts
  - frontend/src/hooks/use-preferences.ts
  - frontend/src/components/layout/header.tsx
  - frontend/src/components/settings-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Dark/light mode toggle in header switches theme and persists across page reload"
    - "App follows system theme on first load (no prior override)"
    - "Dark mode CSS variables apply correctly -- text readable, borders visible, cards distinguishable in dark mode"
    - "Document viewer content remains readable in dark mode (no invisible text, broken highlights)"
    - "User preferences (theme, compact mode, default sidebar tab, navigator default) persist in localStorage"
    - "Settings dialog accessible from header menu shows all 4-5 preference controls"
  artifacts:
    - path: "frontend/src/components/providers/theme-provider.tsx"
      provides: "next-themes ThemeProvider wrapper"
      min_lines: 10
    - path: "frontend/src/hooks/use-preferences.ts"
      provides: "localStorage preferences with load/save"
      min_lines: 30
    - path: "frontend/src/components/settings-dialog.tsx"
      provides: "Preferences dialog with theme, compact mode, default tab, nav visibility"
      min_lines: 50
  key_links:
    - from: "frontend/src/app/layout.tsx"
      to: "frontend/src/components/providers/theme-provider.tsx"
      via: "ThemeProvider wrapping children"
      pattern: "ThemeProvider"
    - from: "frontend/src/components/layout/header.tsx"
      to: "frontend/src/components/settings-dialog.tsx"
      via: "Settings button opens dialog"
      pattern: "SettingsDialog"
    - from: "frontend/src/hooks/use-preferences.ts"
      to: "localStorage"
      via: "JSON read/write on ambrose-preferences key"
      pattern: "ambrose-preferences"
---

<objective>
Set up dark/light theme switching with next-themes, fix the dark mode CSS variant bug, add dark mode overrides for document viewer styles, create the preferences system (localStorage-backed Zustand slice), build the theme toggle in the header, and create the settings dialog.

Purpose: Theme and preference infrastructure is foundational -- other Phase 7 plans (compact mode visuals, accessibility audit) depend on the theme system being in place.
Output: Working dark/light/system theme toggle, preferences dialog, localStorage persistence for 4-5 user settings.
</objective>

<execution_context>
@C:/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish-validation/07-RESEARCH.md
@frontend/src/app/globals.css
@frontend/src/app/layout.tsx
@frontend/src/lib/store.ts
@frontend/src/components/layout/header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install next-themes, fix dark variant, wire ThemeProvider, add document dark mode CSS</name>
  <files>
    frontend/src/components/providers/theme-provider.tsx
    frontend/src/app/layout.tsx
    frontend/src/app/globals.css
  </files>
  <action>
    1. Install next-themes: `cd frontend && npm install next-themes`

    2. Create `frontend/src/components/providers/theme-provider.tsx` -- standard shadcn pattern:
       - "use client" component wrapping NextThemesProvider
       - Pass through all props (attribute="class", defaultTheme="system", enableSystem, disableTransitionOnChange)

    3. Fix the dark mode variant bug in `globals.css` line 5:
       - Change `@custom-variant dark (&:is(.dark *))` to `@custom-variant dark (&:where(.dark, .dark *))`
       - This ensures dark: utility classes match both the .dark element AND its descendants

    4. Update `frontend/src/app/layout.tsx`:
       - Add `suppressHydrationWarning` to the `<html>` tag (prevents next-themes hydration warning)
       - Import and wrap children in ThemeProvider from providers/theme-provider.tsx
       - Move `<Toaster>` into a small client component wrapper OR set `theme="system"` on Toaster so it auto-detects dark mode without needing useTheme() in the server component layout

    5. Add `.dark .document-container` CSS overrides in globals.css at the end of the `@layer components` block:
       - `.dark .document-container [data-para-id]:hover` -- use a dark-friendly hover bg (e.g., `oklch(0.25 0.003 264 / 0.5)`)
       - `.dark .document-container [data-para-id].selected` -- dark selection bg
       - `.dark .document-container [data-para-id].has-revision` -- dark revision bg
       - `.dark .document-container [data-para-id].revision-accepted` -- dark accepted bg
       - `.dark .revision-diff` -- dark bg for revision editor
       - `.dark .revision-diff:hover` -- dark hover
       - `.dark .risk-highlight` -- dark risk highlight gradient
       - `.dark .risk-highlight-active` -- dark active risk outline
       - `.dark .diff-del, .dark del.diff-del` -- adjust red for readability on dark bg
       - `.dark .diff-ins, .dark ins.diff-ins` -- adjust blue for readability on dark bg
       - `.dark .user-addition` -- dark bg override (no yellow on dark)
       - `.dark .user-deletion` -- dark bg override
       - Keep track-changes-insert and track-changes-delete colors as-is (blue/red work on both)

    IMPORTANT: Do NOT change any existing light mode styles. Only ADD dark-prefixed overrides.
  </action>
  <verify>
    - `cd frontend && npm run build` completes without errors
    - The globals.css dark variant line reads `(&:where(.dark, .dark *))`
    - layout.tsx has `suppressHydrationWarning` on `<html>`
    - theme-provider.tsx exists with ThemeProvider component
    - `.dark .document-container` overrides exist in globals.css
  </verify>
  <done>
    Dark mode infrastructure is wired: ThemeProvider wraps the app, dark CSS variant is fixed, document viewer has dark mode overrides, Toaster supports dark mode. No theme toggle UI yet (that's Task 2).
  </done>
</task>

<task type="auto">
  <name>Task 2: Preferences system, theme toggle, and settings dialog</name>
  <files>
    frontend/src/hooks/use-preferences.ts
    frontend/src/lib/store.ts
    frontend/src/components/settings-dialog.tsx
    frontend/src/components/layout/header.tsx
  </files>
  <action>
    1. Create `frontend/src/hooks/use-preferences.ts`:
       - Define Preferences interface: { theme: 'light' | 'dark' | 'system', compactMode: boolean, defaultSidebarTab: 'risks' | 'related' | 'definitions' | 'flags', navPanelVisibleDefault: boolean }
       - Define PREFS_KEY = 'ambrose-preferences'
       - Export `loadPreferences()`: reads from localStorage, returns Partial&lt;Preferences&gt; with try/catch for SSR safety
       - Export `savePreferences(prefs: Preferences)`: writes to localStorage
       - Export `usePreferences()` hook: initializes defaults from localStorage on mount, provides getters/setters that auto-save
       - Default values: theme='system', compactMode=false, defaultSidebarTab='risks', navPanelVisibleDefault=true

    2. Update `frontend/src/lib/store.ts`:
       - Add `defaultSidebarTab` and `navPanelVisibleDefault` to UIState interface (these feed initial state)
       - The store's `compactMode` already exists -- keep it, preferences hook syncs it
       - No zustand persist middleware needed -- manual localStorage via use-preferences hook is cleaner

    3. Create `frontend/src/components/settings-dialog.tsx`:
       - "use client" component using shadcn Dialog
       - Props: `open: boolean, onOpenChange: (v: boolean) => void`
       - Contains sections for:
         a. **Theme**: Three-option toggle (Light / Dark / System) using a button group or radio group. Uses `useTheme()` from next-themes to set theme.
         b. **Compact Mode**: Toggle switch (shadcn doesn't have Switch -- use a checkbox or a simple Button toggle). Syncs with store's `compactMode`.
         c. **Default Sidebar Tab**: Select dropdown with options: Risks, Related, Definitions, Flags. Persists via use-preferences.
         d. **Navigator Panel Default**: Toggle for whether nav panel opens by default on session load. Persists via use-preferences.
       - Each control updates both the store (for immediate effect) and localStorage (for persistence)
       - Use a clean, minimal layout with labeled sections

    4. Update `frontend/src/components/layout/header.tsx`:
       - Add a theme toggle button in the right section (between New button and User menu):
         - Show Sun icon in light mode, Moon icon in dark mode (use CSS rotation trick from research)
         - Click cycles: light -> dark -> system -> light (or use a dropdown with three options)
         - Use `useTheme()` from next-themes
       - Wire the Settings menu item (currently shows "Coming soon" toast) to open the SettingsDialog
       - Import and render SettingsDialog with open/onOpenChange state
       - Add a keyboard shortcut hint text to the Settings menu item (show "Ctrl+," or "Cmd+,")

    IMPORTANT per locked decisions:
    - Follow system preference on first load (defaultTheme="system" in ThemeProvider handles this)
    - Compact mode is card spacing only (the visual implementation is in a later plan)
    - localStorage persistence, no backend sync
  </action>
  <verify>
    - `cd frontend && npm run build` completes without errors
    - header.tsx renders ThemeToggle with Sun/Moon icons
    - settings-dialog.tsx exists with all 4 preference controls
    - use-preferences.ts exports loadPreferences, savePreferences, usePreferences
    - Clicking Settings in the menu opens the dialog (not "Coming soon" toast)
  </verify>
  <done>
    Theme toggle visible in header, settings dialog opens with all 4-5 preference controls, preferences persist in localStorage under 'ambrose-preferences' key, theme follows system on first load and can be overridden.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` passes
2. Open app in browser, toggle dark mode -- all panels switch colors correctly
3. Document viewer text remains readable in dark mode (not invisible)
4. Toggle theme, refresh page -- theme persists
5. Open settings dialog, change preferences, refresh -- they persist
6. Clear localStorage, reload -- app follows system theme
</verification>

<success_criteria>
- Dark/light/system theme switching works via header toggle and settings dialog
- Document viewer has proper dark mode overrides (no invisible text, broken highlights)
- Preferences persist in localStorage and restore on page load
- Settings dialog has controls for: theme, compact mode, default sidebar tab, navigator default
- No hydration warnings in console from next-themes
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-validation/07-01-SUMMARY.md`
</output>
