---
phase: 08-cleanup-cutover
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/server.py
  - app/__init__.py
  - run.py
  - package.json
  - .github/workflows/npm-publish.yml
autonomous: true

must_haves:
  truths:
    - "Flask no longer serves static files or an index route -- only /api/* and /health"
    - "app/static/ is archived to _archived/static/ and no longer served"
    - "npm run dev from project root starts both Flask and Next.js dev servers"
    - "python run.py still works standalone and directs users to localhost:3000"
  artifacts:
    - path: "app/server.py"
      provides: "API-only Flask server"
      contains: "app = Flask(__name__)"
    - path: "_archived/static/index.html"
      provides: "Archived old frontend"
    - path: "package.json"
      provides: "Root dev orchestrator with concurrently"
      contains: "concurrently"
    - path: "run.py"
      provides: "Updated startup banner pointing to :3000"
      contains: "localhost:3000"
  key_links:
    - from: "package.json"
      to: "run.py"
      via: "concurrently runs python run.py"
      pattern: "python run\\.py"
    - from: "package.json"
      to: "frontend/package.json"
      via: "concurrently runs npm run dev --prefix frontend"
      pattern: "--prefix frontend"
---

<objective>
Archive the old vanilla JS frontend and convert Flask to API-only mode. Set up a root package.json with concurrently for one-command dev startup.

Purpose: This is the core cutover -- after this plan, Flask only serves API endpoints and the old frontend is archived. The developer experience is streamlined to a single `npm run dev` command.

Output: Flask is API-only, old frontend archived, one-command dev startup works.
</objective>

<execution_context>
@C:/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-cleanup-cutover/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Archive old frontend and strip Flask static serving</name>
  <files>
    app/server.py
    app/__init__.py
    .github/workflows/npm-publish.yml
  </files>
  <action>
    **Step 1: Archive app/static/ to _archived/static/**

    Move the entire `app/static/` directory to `_archived/static/` at the project root:
    ```bash
    mkdir -p _archived
    git mv app/static _archived/static
    ```

    **Step 2: Modify app/server.py to be API-only**

    Make these exact changes to `app/server.py`:

    1. Update the module docstring to:
       ```
       Contract Review API Server

       Flask-based backend providing REST API endpoints for the contract redlining webapp.
       The frontend is served separately by Next.js.
       ```

    2. Change the import line from:
       `from flask import Flask, send_from_directory`
       to:
       `from flask import Flask`

    3. Change the Flask constructor from:
       `app = Flask(__name__, static_folder='static', static_url_path='/static')`
       to:
       `app = Flask(__name__)`

    4. Remove the entire `index()` route and its decorator:
       ```python
       # DELETE THIS:
       @app.route('/')
       def index():
           return send_from_directory(app.static_folder, 'index.html')
       ```

    5. Keep everything else intact: CORS config, MAX_CONTENT_LENGTH, UPLOAD_FOLDER, SESSION_FOLDER, directory creation, blueprint registration, health endpoint, and the main() function.

    6. Update the startup banner in main() to:
       ```
       +==================================================================+
       |           Contract Review API Server                             |
       +==================================================================+
       |  API running at:  http://localhost:{port:<5}                        |
       |  Frontend at:     http://localhost:3000                          |
       |                                                                  |
       |  Start both with: npm run dev (from project root)               |
       |  Press Ctrl+C to stop the server.                               |
       +==================================================================+
       ```

    **Step 3: Update app/__init__.py docstring**

    Change the docstring from:
    `A Flask-based webapp for interactive contract review with AI-powered redlining.`
    to:
    `Flask API backend for the contract redlining application. Frontend served by Next.js.`

    **Step 4: Remove unused GitHub workflow**

    Delete `.github/workflows/npm-publish.yml` -- it is unused boilerplate for npm publishing that this private project does not use. It would also break with the new root package.json:
    ```bash
    git rm .github/workflows/npm-publish.yml
    ```

    If the `.github/workflows/` directory is now empty, remove it too:
    ```bash
    rmdir .github/workflows 2>/dev/null
    rmdir .github 2>/dev/null
    ```
  </action>
  <verify>
    1. `_archived/static/index.html` exists
    2. `app/static/` does NOT exist
    3. `python -c "from app.server import create_app; app = create_app(); print('OK')"` succeeds
    4. `grep -c "send_from_directory" app/server.py` returns 0
    5. `grep -c "static_folder" app/server.py` returns 0
    6. `.github/workflows/npm-publish.yml` does NOT exist
  </verify>
  <done>
    Flask is API-only (no static_folder, no index route, no send_from_directory import). Old frontend is archived to _archived/static/. Unused CI workflow is removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create root package.json with concurrently dev script</name>
  <files>
    package.json
    run.py
  </files>
  <action>
    **Step 1: Create root package.json**

    Create `package.json` at the project root with this exact content:
    ```json
    {
      "name": "claude-redlining",
      "version": "1.0.0",
      "private": true,
      "scripts": {
        "dev": "concurrently --kill-others-on-fail -n flask,next -c blue,green \"python run.py\" \"npm run dev --prefix frontend\"",
        "dev:flask": "python run.py",
        "dev:next": "npm run dev --prefix frontend",
        "build": "npm run build --prefix frontend",
        "test": "echo \"See pytest for backend tests\""
      },
      "devDependencies": {
        "concurrently": "^9.0.0"
      }
    }
    ```

    **Step 2: Install concurrently**

    ```bash
    npm install
    ```

    This installs concurrently into `node_modules/` at the project root. Verify `node_modules/` is already in `.gitignore` -- if not, add it.

    **Step 3: Update run.py docstring**

    Change the module docstring in `run.py` from:
    ```
    Quick start script for the Contract Review Application.

    Usage:
        python run.py

    This will start the server at http://localhost:5000
    ```
    to:
    ```
    Quick start script for the Contract Review API Server.

    Usage:
        python run.py          # Start API server only
        npm run dev            # Start both API + frontend (recommended)

    API server runs at http://localhost:5000
    Frontend runs at http://localhost:3000 (via Next.js)
    ```

    **Step 4: Verify .gitignore includes node_modules at root level**

    Check `.gitignore` for `node_modules` or `node_modules/`. The frontend already has this, but verify the root-level .gitignore also excludes it. Also add `package-lock.json` exclusion if not present (the frontend has its own lockfile; the root one is for dev tooling only and does not need to be tracked).

    Actually, keep `package-lock.json` tracked -- it ensures reproducible installs of concurrently. Just verify `node_modules/` is gitignored.
  </action>
  <verify>
    1. `package.json` exists at project root with `concurrently` in devDependencies
    2. `node_modules/.package-lock.json` exists (confirms npm install ran)
    3. `npm run dev --prefix frontend -- --help 2>/dev/null` does not error on the prefix resolution
    4. `grep "node_modules" .gitignore` returns a match
    5. `run.py` docstring mentions both `python run.py` and `npm run dev`
  </verify>
  <done>
    Root package.json exists with `npm run dev` that starts both Flask and Next.js via concurrently. run.py docstring updated to reflect the dual-server setup. node_modules is gitignored.
  </done>
</task>

</tasks>

<verification>
1. Flask starts without errors: `python -c "from app.server import create_app; app = create_app(); print('OK')"`
2. No references to send_from_directory or static_folder in server.py
3. `_archived/static/index.html` exists, `app/static/` does not
4. `package.json` exists with concurrently dependency installed
5. run.py mentions localhost:3000
</verification>

<success_criteria>
- Flask is API-only: constructor has no static_folder, no index() route, no send_from_directory import
- Old frontend archived to _archived/static/ (not deleted)
- `npm run dev` from root starts both servers via concurrently
- `python run.py` standalone still works, startup banner points to :3000
- Unused npm-publish.yml workflow removed
</success_criteria>

<output>
After completion, create `.planning/phases/08-cleanup-cutover/08-01-SUMMARY.md`
</output>
