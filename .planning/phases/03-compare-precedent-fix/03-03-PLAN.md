---
phase: 03-compare-precedent-fix
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - app/static/js/precedent.js
  - app/static/css/main.css
  - app/api/routes.py
autonomous: false

must_haves:
  truths:
    - "Matched clauses are visually highlighted in the precedent navigator"
    - "User can see which navigator items correspond to matches"
    - "User can manually create or modify clause correlations via drag-and-drop"
  artifacts:
    - path: "app/static/js/precedent.js"
      provides: "Navigator match highlighting and drag-drop correlation editing"
      contains: "draggable"
    - path: "app/static/css/main.css"
      provides: "Styles for matched navigator items and drag states"
      contains: ".precedent-nav-item.matched"
    - path: "app/api/routes.py"
      provides: "Endpoint for saving user correlation overrides"
      contains: "/correlations"
  key_links:
    - from: "app/static/js/precedent.js"
      to: "navigator DOM"
      via: "matched class application"
      pattern: "classList.add.*matched"
    - from: "app/static/js/precedent.js"
      to: "/api/correlations"
      via: "fetch POST"
      pattern: "fetch.*correlations"
---

<objective>
Highlight matched clauses in the precedent navigator and enable user-editable correlations.

Purpose: Fix UAT issue #4 (highlight matching clauses in navigator) and UAT issue #6 (user should be able to modify correlations). These features help users quickly identify matches and override the algorithm when needed.

Output: Navigator with visual match highlighting, optional drag-and-drop correlation editing.
</objective>

<execution_context>
@C:\Users\david\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\david\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-compare-precedent-fix/03-RESEARCH.md
@.planning/phases/03-compare-precedent-fix/03-01-SUMMARY.md
@.planning/phases/03-compare-precedent-fix/03-02-SUMMARY.md

# Existing files
@C:\Users\david\Documents\claude-redlining\app\static\js\precedent.js
@C:\Users\david\Documents\claude-redlining\app\static\css\main.css
@C:\Users\david\Documents\claude-redlining\app\api\routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Highlight matched clauses in precedent navigator</name>
  <files>app/static/js/precedent.js, app/static/css/main.css</files>
  <action>
1. Update `renderPrecedentNavigator()` in precedent.js to apply matched styling:

   The function should already check `precedentPanelState.relatedClauseIds` and apply a class. Ensure this is working correctly:

   ```javascript
   function renderPrecedentNavigator() {
       const navContainer = document.getElementById('precedent-navigator');
       if (!navContainer) return;

       const doc = precedentPanelState.document;
       if (!doc) return;

       const sections = doc.sections || [];
       const relatedIds = precedentPanelState.relatedClauseIds || [];

       let navHtml = `
           <div class="precedent-navigator-header">
               <span>Sections</span>
               <span class="match-count">${relatedIds.length} matches</span>
           </div>
           <div class="precedent-navigator-list">
       `;

       sections.forEach(section => {
           // Check if this section's para_id is in related clauses
           const isMatched = relatedIds.includes(section.para_id);
           const matchedClass = isMatched ? 'matched' : '';

           // Find the match score if available
           const matchInfo = precedentPanelState.relatedClausesDetails?.find(
               m => m.id === section.para_id
           );
           const scoreIndicator = matchInfo ? getScoreIndicator(matchInfo.score) : '';

           navHtml += `
               <div class="precedent-nav-item ${matchedClass}"
                    data-para-id="${section.para_id}"
                    onclick="scrollToPrecedentSection('${section.para_id}')">
                   ${scoreIndicator}
                   <span class="precedent-nav-ref">${escapeHtml(section.number || '')}</span>
                   <span class="precedent-nav-text">${escapeHtml(section.title || '')}</span>
               </div>
           `;
       });

       navHtml += '</div>';
       navContainer.innerHTML = navHtml;

       setupPrecedentNavObserver();
   }

   /**
    * Get visual score indicator based on match confidence
    */
   function getScoreIndicator(score) {
       if (score >= 0.7) {
           return '<span class="match-indicator high" title="High confidence match">&#9679;</span>';
       } else if (score >= 0.4) {
           return '<span class="match-indicator medium" title="Medium confidence match">&#9679;</span>';
       } else {
           return '<span class="match-indicator low" title="Low confidence match">&#9675;</span>';
       }
   }
   ```

2. Store full match details in state when fetching related clauses. Update `fetchRelatedPrecedentClauses()`:

   ```javascript
   async function fetchRelatedPrecedentClauses(paraId) {
       try {
           const relatedData = await api(`/precedent/${AppState.sessionId}/related/${paraId}`);
           const relatedClauses = relatedData.related_clauses || [];

           // Store both IDs and full details
           precedentPanelState.relatedClauseIds = relatedClauses.map(c => c.id);
           precedentPanelState.relatedClausesDetails = relatedClauses; // NEW: store full details

           return relatedClauses;
       } catch (error) {
           console.error('Failed to fetch related clauses:', error);
           precedentPanelState.relatedClauseIds = [];
           precedentPanelState.relatedClausesDetails = [];
           return [];
       }
   }
   ```

3. Add CSS for match indicators in main.css:

   ```css
   /* Match indicators in precedent navigator */
   .match-indicator {
       font-size: 0.625rem;
       margin-right: 0.25rem;
       flex-shrink: 0;
   }

   .match-indicator.high {
       color: #22c55e; /* Green */
   }

   .match-indicator.medium {
       color: #eab308; /* Yellow */
   }

   .match-indicator.low {
       color: #f97316; /* Orange */
   }

   /* Enhanced matched nav item styling */
   .precedent-nav-item.matched {
       border-left: 3px solid #eab308;
       background: linear-gradient(90deg, #fefce8 0%, transparent 100%);
       font-weight: 500;
   }

   .precedent-nav-item.matched:hover {
       background: linear-gradient(90deg, #fef9c3 0%, rgba(30, 58, 95, 0.08) 100%);
   }

   /* Match count in header */
   .precedent-navigator-header .match-count {
       font-size: 0.6875rem;
       font-weight: 400;
       color: #eab308;
       background: #fefce8;
       padding: 0.125rem 0.375rem;
       border-radius: 10px;
   }
   ```
  </action>
  <verify>
- Open precedent panel
- VERIFY: Navigator items show match indicators (colored dots)
- VERIFY: Matched items have yellow left border and subtle background
- VERIFY: Header shows "N matches" count
- VERIFY: High confidence matches show green dot, medium yellow, low orange
  </verify>
  <done>Navigator visually highlights matched clauses with confidence indicators</done>
</task>

<task type="auto">
  <name>Task 2: Add correlation persistence endpoint</name>
  <files>app/api/routes.py</files>
  <action>
1. Add a new endpoint for saving user correlation overrides:

   ```python
   @api_bp.route('/correlations/<session_id>', methods=['POST'])
   def save_correlation(session_id):
       """
       Save a user-defined correlation between target and precedent clauses.

       User overrides take precedence over algorithm-generated matches.

       Expects JSON:
       {
           "target_para_id": "p_123",
           "precedent_para_id": "p_456",
           "action": "add" | "remove"
       }
       """
       session = get_session(session_id)
       if not session:
           return jsonify({'error': 'Session not found'}), 404

       data = request.get_json()
       target_para_id = data.get('target_para_id')
       precedent_para_id = data.get('precedent_para_id')
       action = data.get('action', 'add')

       if not target_para_id or not precedent_para_id:
           return jsonify({'error': 'Missing para_id'}), 400

       # Initialize correlations storage if not exists
       if 'user_correlations' not in session:
           session['user_correlations'] = {}

       # Get or create correlations for this target paragraph
       if target_para_id not in session['user_correlations']:
           session['user_correlations'][target_para_id] = {
               'added': [],  # User explicitly added these matches
               'removed': []  # User explicitly removed these matches
           }

       correlations = session['user_correlations'][target_para_id]

       if action == 'add':
           # Add to added list, remove from removed list if present
           if precedent_para_id not in correlations['added']:
               correlations['added'].append(precedent_para_id)
           if precedent_para_id in correlations['removed']:
               correlations['removed'].remove(precedent_para_id)
       elif action == 'remove':
           # Add to removed list, remove from added list if present
           if precedent_para_id not in correlations['removed']:
               correlations['removed'].append(precedent_para_id)
           if precedent_para_id in correlations['added']:
               correlations['added'].remove(precedent_para_id)

       save_session(session_id, session)

       return jsonify({
           'status': 'saved',
           'target_para_id': target_para_id,
           'precedent_para_id': precedent_para_id,
           'action': action
       })


   @api_bp.route('/correlations/<session_id>/<target_para_id>', methods=['GET'])
   def get_correlations(session_id, target_para_id):
       """
       Get user-defined correlations for a target paragraph.
       """
       session = get_session(session_id)
       if not session:
           return jsonify({'error': 'Session not found'}), 404

       user_correlations = session.get('user_correlations', {})
       correlations = user_correlations.get(target_para_id, {'added': [], 'removed': []})

       return jsonify({
           'target_para_id': target_para_id,
           'added': correlations['added'],
           'removed': correlations['removed']
       })
   ```

2. Update the `get_related_precedent_clauses()` endpoint to incorporate user overrides:

   At the end of the function, before returning, add:

   ```python
   # Apply user correlation overrides
   user_correlations = session.get('user_correlations', {}).get(para_id, {'added': [], 'removed': []})

   # Remove user-removed correlations
   if user_correlations['removed']:
       related_clauses = [c for c in related_clauses if c['id'] not in user_correlations['removed']]

   # Add user-added correlations
   for added_id in user_correlations.get('added', []):
       # Check if already in list
       if not any(c['id'] == added_id for c in related_clauses):
           # Find the clause in precedent content
           added_clause = next(
               (item for item in precedent_content
                if item.get('id') == added_id),
               None
           )
           if added_clause:
               related_clauses.insert(0, {
                   'id': added_clause.get('id'),
                   'text': added_clause.get('text', ''),
                   'section_ref': added_clause.get('section_ref', ''),
                   'score': 1.0,  # User-defined = max confidence
                   'user_added': True
               })
   ```
  </action>
  <verify>
- Flask app starts without errors
- POST /correlations/{session_id} saves correlation
- GET /correlations/{session_id}/{para_id} retrieves user correlations
- Related clauses endpoint respects user overrides
  </verify>
  <done>Backend supports user correlation storage and override</done>
</task>

<task type="auto">
  <name>Task 3: Add drag-and-drop correlation editing UI</name>
  <files>app/static/js/precedent.js, app/static/css/main.css</files>
  <action>
1. Add state for edit mode:

   ```javascript
   let correlationEditMode = false;
   ```

2. Add edit mode toggle button to navigator header. Update `renderPrecedentNavigator()`:

   ```javascript
   // In the header section:
   navHtml = `
       <div class="precedent-navigator-header">
           <span>Sections</span>
           <div class="nav-header-actions">
               <span class="match-count">${relatedIds.length} matches</span>
               <button class="edit-correlations-btn ${correlationEditMode ? 'active' : ''}"
                       onclick="toggleCorrelationEditMode()"
                       title="Edit correlations">
                   &#9998;
               </button>
           </div>
       </div>
   `;
   ```

3. Add toggle function:

   ```javascript
   function toggleCorrelationEditMode() {
       correlationEditMode = !correlationEditMode;
       renderPrecedentNavigator();

       if (correlationEditMode) {
           setupCorrelationDragDrop();
           showToast('Correlation edit mode ON - drag clauses to match', 'info');
       } else {
           removeCorrelationDragDrop();
           showToast('Correlation edit mode OFF', 'info');
       }
   }
   ```

4. Add drag-and-drop handlers:

   ```javascript
   function setupCorrelationDragDrop() {
       const navItems = document.querySelectorAll('.precedent-nav-item');

       navItems.forEach(item => {
           item.draggable = true;

           item.addEventListener('dragstart', handleCorrelationDragStart);
           item.addEventListener('dragend', handleCorrelationDragEnd);
           item.addEventListener('dragover', handleCorrelationDragOver);
           item.addEventListener('drop', handleCorrelationDrop);
       });

       // Also make main document paragraphs droppable
       const mainParas = document.querySelectorAll('.para-block');
       mainParas.forEach(para => {
           para.addEventListener('dragover', handleMainDocDragOver);
           para.addEventListener('drop', handleMainDocDrop);
           para.addEventListener('dragleave', handleMainDocDragLeave);
       });
   }

   function removeCorrelationDragDrop() {
       const navItems = document.querySelectorAll('.precedent-nav-item');
       navItems.forEach(item => {
           item.draggable = false;
           item.removeEventListener('dragstart', handleCorrelationDragStart);
           item.removeEventListener('dragend', handleCorrelationDragEnd);
       });
   }

   let draggedPrecedentParaId = null;

   function handleCorrelationDragStart(e) {
       draggedPrecedentParaId = e.target.dataset.paraId;
       e.target.classList.add('dragging');
       e.dataTransfer.setData('text/plain', draggedPrecedentParaId);
       e.dataTransfer.effectAllowed = 'link';
   }

   function handleCorrelationDragEnd(e) {
       e.target.classList.remove('dragging');
       draggedPrecedentParaId = null;
   }

   function handleCorrelationDragOver(e) {
       e.preventDefault();
       e.dataTransfer.dropEffect = 'link';
   }

   function handleMainDocDragOver(e) {
       if (!correlationEditMode || !draggedPrecedentParaId) return;
       e.preventDefault();
       e.currentTarget.classList.add('correlation-drop-target');
   }

   function handleMainDocDragLeave(e) {
       e.currentTarget.classList.remove('correlation-drop-target');
   }

   async function handleMainDocDrop(e) {
       e.preventDefault();
       e.currentTarget.classList.remove('correlation-drop-target');

       if (!correlationEditMode || !draggedPrecedentParaId) return;

       const targetParaId = e.currentTarget.dataset.paraId;
       const precedentParaId = draggedPrecedentParaId;

       // Save correlation to backend
       try {
           await api(`/correlations/${AppState.sessionId}`, {
               method: 'POST',
               body: JSON.stringify({
                   target_para_id: targetParaId,
                   precedent_para_id: precedentParaId,
                   action: 'add'
               })
           });

           showToast('Correlation saved', 'success');

           // Refresh if this is the current paragraph
           if (targetParaId === precedentPanelState.currentParaId) {
               await fetchRelatedPrecedentClauses(targetParaId);
               renderPrecedentNavigator();
           }
       } catch (error) {
           showToast('Failed to save correlation', 'error');
       }
   }

   function handleCorrelationDrop(e) {
       // Handle dropping on another nav item (swap/link)
       e.preventDefault();
   }
   ```

5. Add context menu for removing correlations:

   ```javascript
   function setupCorrelationContextMenu() {
       document.querySelectorAll('.precedent-nav-item.matched').forEach(item => {
           item.addEventListener('contextmenu', async (e) => {
               if (!correlationEditMode) return;

               e.preventDefault();

               const precedentParaId = item.dataset.paraId;
               const targetParaId = precedentPanelState.currentParaId;

               // Show confirm (or could use custom context menu)
               if (confirm('Remove this correlation?')) {
                   try {
                       await api(`/correlations/${AppState.sessionId}`, {
                           method: 'POST',
                           body: JSON.stringify({
                               target_para_id: targetParaId,
                               precedent_para_id: precedentParaId,
                               action: 'remove'
                           })
                       });

                       showToast('Correlation removed', 'success');
                       await fetchRelatedPrecedentClauses(targetParaId);
                       renderPrecedentNavigator();
                   } catch (error) {
                       showToast('Failed to remove correlation', 'error');
                   }
               }
           });
       });
   }
   ```

6. Add CSS for drag-drop states in main.css:

   ```css
   /* Correlation edit mode */
   .edit-correlations-btn {
       background: transparent;
       border: 1px solid var(--border);
       border-radius: 4px;
       padding: 0.25rem 0.375rem;
       cursor: pointer;
       font-size: 0.75rem;
       color: var(--text-light);
       transition: all var(--transition-fast);
   }

   .edit-correlations-btn:hover {
       background: var(--bg-subtle);
       color: var(--text);
   }

   .edit-correlations-btn.active {
       background: var(--primary);
       color: white;
       border-color: var(--primary);
   }

   /* Drag states */
   .precedent-nav-item.dragging {
       opacity: 0.5;
       border: 2px dashed var(--primary);
   }

   .correlation-drop-target {
       outline: 2px dashed var(--primary);
       outline-offset: -2px;
       background: rgba(30, 58, 95, 0.05);
   }

   /* User-added correlation indicator */
   .precedent-nav-item[data-user-added="true"]::after {
       content: "\\2713";
       color: var(--success);
       font-size: 0.625rem;
       margin-left: auto;
   }
   ```

7. Export new functions:
   ```javascript
   window.toggleCorrelationEditMode = toggleCorrelationEditMode;
   ```
  </action>
  <verify>
- Edit button appears in navigator header
- Click edit button - toast shows "edit mode ON"
- Drag precedent nav item - item becomes semi-transparent with dashed border
- Drop on main document paragraph - correlation is saved
- Right-click matched item in edit mode - can remove correlation
- Toggle edit mode off - dragging is disabled
  </verify>
  <done>Users can manually edit clause correlations via drag-and-drop</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Compare Precedent UX improvements:
1. Split-pane layout with resizable gutter (Plan 01)
2. TF-IDF clause matching with auto-jump (Plan 02)
3. Navigator match highlighting and correlation editing (Plan 03)
  </what-built>
  <how-to-verify>
1. Start Flask app: `python run.py`
2. Open browser to http://127.0.0.1:5000
3. Load or create a session with a precedent document

Test split layout (Plan 01):
- Click "Compare Precedent" - panel should open as split pane on RIGHT
- Main document should push LEFT, not be overlaid
- Drag gutter between panes - both should resize smoothly
- Resize window - layout should adapt
- Close and reopen - sizes should be remembered

Test matching (Plan 02):
- When panel opens, should auto-scroll to first match
- Toast shows "Found N related clauses"
- Matches should be conceptually similar, not just keyword matches
- Select different clause - matches update

Test navigator (Plan 03):
- Navigator shows sections on right side of precedent pane
- Matched items have yellow border and dot indicators
- Green dot = high confidence, yellow = medium, orange = low
- Click edit (pencil) button
- Drag a precedent item to a main document paragraph
- Verify "Correlation saved" toast appears
- Right-click a matched item to remove correlation

Test overall flow:
- Can compare precedent for multiple clauses sequentially
- Can close panel and continue working on document
- No JavaScript errors in console
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. All three plans are complete
2. Split layout replaces overlay behavior
3. TF-IDF matching produces better results than keyword overlap
4. Auto-jump works on panel open
5. Navigator shows match indicators
6. Correlation editing via drag-drop works
7. No console errors, no regressions
</verification>

<success_criteria>
- UAT #1: Panel as split pane (not overlay) - FIXED
- UAT #2: Precedent navigator on right side - FIXED
- UAT #3: Auto-jump to first match - FIXED
- UAT #4: Highlight matched clauses in navigator - FIXED
- UAT #5: Better clause matching - FIXED (TF-IDF)
- UAT #6: User-editable correlations - FIXED (drag-drop)
- All fixes verified by human in checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/03-compare-precedent-fix/03-03-SUMMARY.md`
</output>
