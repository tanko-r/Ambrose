---
phase: 03-compare-precedent-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/static/css/main.css
  - app/static/index.html
  - app/static/js/precedent.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Precedent panel displays as split pane beside main document, not as overlay"
    - "User can resize the split pane by dragging the gutter"
    - "Precedent panel has its own section navigator on the right side"
    - "Main document content pushes left when precedent opens"
  artifacts:
    - path: "app/static/js/precedent.js"
      provides: "Split.js initialization and precedent navigator rendering"
      contains: "Split("
    - path: "app/static/css/main.css"
      provides: "Split pane layout styles replacing overlay"
      contains: ".split-container"
    - path: "app/static/index.html"
      provides: "Split container structure with gutter"
      contains: "split-container"
  key_links:
    - from: "app/static/js/precedent.js"
      to: "Split.js library"
      via: "CDN script or import"
      pattern: "Split\\("
    - from: "app/static/index.html"
      to: "app/static/css/main.css"
      via: "split-container class"
      pattern: "split-container"
---

<objective>
Replace precedent panel overlay behavior with Split.js split-pane layout and add a precedent navigator.

Purpose: Fix UAT issue #1 (panel overlays instead of pushing main doc) and UAT issue #2 (need precedent navigator on right side). Users need true side-by-side comparison with resizable panels.

Output: Working split-pane layout with draggable gutter, size persistence, and dedicated precedent section navigator.
</objective>

<execution_context>
@C:\Users\david\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\david\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-compare-precedent-fix/03-RESEARCH.md

# Existing files to modify
@C:\Users\david\Documents\claude-redlining\app\static\js\precedent.js
@C:\Users\david\Documents\claude-redlining\app\static\css\main.css
@C:\Users\david\Documents\claude-redlining\app\static\index.html
@C:\Users\david\Documents\claude-redlining\app\static\js\navigation.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Split.js and restructure HTML for split layout</name>
  <files>app/static/index.html</files>
  <action>
1. Add Split.js CDN script before other JS files:
   `<script src="https://unpkg.com/split.js@1.6.5/dist/split.min.js"></script>`

2. Wrap the main content area in a split container. Find the existing structure with `.document-panel` and `.sidebar` and restructure to:
   ```html
   <div class="split-container" id="split-container">
       <div class="split-pane" id="main-document-pane">
           <!-- Existing document-panel content -->
       </div>
       <div class="split-pane precedent-pane hidden" id="precedent-pane">
           <div class="precedent-navigator" id="precedent-navigator">
               <!-- Navigator content rendered by JS -->
           </div>
           <div class="precedent-content" id="precedent-content">
               <!-- Document content rendered by JS -->
           </div>
       </div>
   </div>
   ```

3. The sidebar should remain OUTSIDE the split container (it overlays on hover/click, separate from the split).

4. Remove the existing `<div class="precedent-panel" id="precedent-panel">` element - it will be replaced by the split pane structure.
  </action>
  <verify>
- View source shows split-container wrapping document content
- Split.js script is loaded before precedent.js
- No duplicate precedent-panel elements exist
  </verify>
  <done>HTML has split container structure ready for Split.js initialization</done>
</task>

<task type="auto">
  <name>Task 2: Update CSS for split-pane layout</name>
  <files>app/static/css/main.css</files>
  <action>
1. Add split container styles:
   ```css
   /* Split Pane Layout for Precedent Comparison */
   .split-container {
       display: flex;
       flex-direction: row;
       height: calc(100vh - var(--header-height) - 52px); /* Account for header and bottom bar */
       width: 100%;
   }

   .split-pane {
       overflow: hidden;
       display: flex;
       flex-direction: column;
   }

   .split-pane.hidden {
       display: none;
   }

   /* Gutter (drag handle) */
   .gutter {
       background-color: var(--border);
       background-repeat: no-repeat;
       background-position: 50%;
       cursor: col-resize;
       flex-shrink: 0;
   }

   .gutter:hover {
       background-color: var(--primary);
       opacity: 0.5;
   }

   .gutter.gutter-horizontal {
       width: 8px;
   }
   ```

2. Add precedent pane content styles:
   ```css
   /* Precedent Pane Layout */
   .precedent-pane {
       background: var(--card);
       border-left: 1px solid var(--border);
   }

   /* Precedent Navigator (mini-nav on right side of precedent) */
   .precedent-navigator {
       width: 180px;
       border-left: 1px solid var(--border);
       background: var(--bg-subtle);
       overflow-y: auto;
       flex-shrink: 0;
       display: flex;
       flex-direction: column;
   }

   .precedent-navigator-header {
       padding: 0.75rem 1rem;
       border-bottom: 1px solid var(--border);
       font-size: 0.75rem;
       font-weight: 600;
       color: var(--text-muted);
       text-transform: uppercase;
       letter-spacing: 0.08em;
   }

   .precedent-navigator-list {
       flex: 1;
       overflow-y: auto;
       padding: 0.5rem;
   }

   .precedent-nav-item {
       padding: 0.375rem 0.5rem;
       border-radius: 4px;
       cursor: pointer;
       font-size: 0.75rem;
       margin-bottom: 2px;
       display: flex;
       align-items: center;
       gap: 0.375rem;
   }

   .precedent-nav-item:hover {
       background: rgba(30, 58, 95, 0.08);
   }

   .precedent-nav-item.active {
       background: var(--primary);
       color: white;
   }

   .precedent-nav-item.matched {
       border-left: 3px solid #eab308;
       background: #fefce8;
   }

   .precedent-nav-ref {
       font-weight: 600;
       color: var(--text-muted);
       min-width: 32px;
   }

   .precedent-nav-text {
       white-space: nowrap;
       overflow: hidden;
       text-overflow: ellipsis;
   }
   ```

3. Update the precedent content area styles (reuse much of existing .precedent-panel-content styles but adapt for flex layout):
   ```css
   /* Precedent Content Area */
   .precedent-content {
       flex: 1;
       display: flex;
       flex-direction: column;
       overflow: hidden;
   }

   .precedent-content-header {
       display: flex;
       justify-content: space-between;
       align-items: center;
       padding: 0.75rem 1rem;
       border-bottom: 1px solid var(--border);
       background: linear-gradient(180deg, var(--card) 0%, var(--bg-subtle) 100%);
   }

   .precedent-content-body {
       flex: 1;
       overflow-y: auto;
       padding: 1rem;
   }
   ```

4. REMOVE or comment out the old overlay-based `.precedent-panel` styles that use `position: fixed` and `transform: translateX`. Keep the content styles (.precedent-para, .precedent-related, etc.) as they still apply.

5. Remove the `body.precedent-panel-open` rules that shifted content.
  </action>
  <verify>
- CSS has .split-container, .gutter, .precedent-pane classes
- Old fixed-position .precedent-panel styles are removed/disabled
- No conflicting transform rules remain
  </verify>
  <done>CSS supports split layout with gutter and precedent navigator styling</done>
</task>

<task type="auto">
  <name>Task 3: Rewrite precedent.js for Split.js integration and navigator</name>
  <files>app/static/js/precedent.js</files>
  <action>
1. Add Split.js instance management at top of file:
   ```javascript
   let splitInstance = null;
   const DEFAULT_SPLIT_SIZES = [60, 40];
   const MIN_PANE_SIZE = 250;
   ```

2. Rewrite `openPrecedentPanel()` to initialize Split.js instead of CSS class toggle:
   ```javascript
   function openPrecedentPanel() {
       const container = document.getElementById('split-container');
       const precedentPane = document.getElementById('precedent-pane');
       if (!container || !precedentPane) return;

       // Show precedent pane
       precedentPane.classList.remove('hidden');

       // Initialize Split.js if not already done
       if (!splitInstance) {
           const savedSizes = JSON.parse(localStorage.getItem('precedent-split-sizes')) || DEFAULT_SPLIT_SIZES;

           splitInstance = Split(['#main-document-pane', '#precedent-pane'], {
               sizes: savedSizes,
               minSize: MIN_PANE_SIZE,
               gutterSize: 8,
               direction: 'horizontal',
               cursor: 'col-resize',
               onDragEnd: (sizes) => {
                   localStorage.setItem('precedent-split-sizes', JSON.stringify(sizes));
               }
           });
       }

       precedentPanelState.isOpen = true;
   }
   ```

3. Rewrite `closePrecedentPanel()` to destroy Split and hide pane:
   ```javascript
   function closePrecedentPanel() {
       const precedentPane = document.getElementById('precedent-pane');
       if (!precedentPane) return;

       // Destroy split instance
       if (splitInstance) {
           splitInstance.destroy();
           splitInstance = null;
       }

       // Hide precedent pane
       precedentPane.classList.add('hidden');

       // Remove gutter if it exists
       const gutter = document.querySelector('.gutter');
       if (gutter) gutter.remove();

       precedentPanelState.isOpen = false;
   }
   ```

4. Add new function `renderPrecedentNavigator()` that builds the section navigator:
   ```javascript
   function renderPrecedentNavigator() {
       const navContainer = document.getElementById('precedent-navigator');
       if (!navContainer) return;

       const doc = precedentPanelState.document;
       if (!doc) return;

       const sections = doc.sections || [];
       const content = doc.content || [];

       // Build navigator items from sections
       let navHtml = `
           <div class="precedent-navigator-header">Sections</div>
           <div class="precedent-navigator-list">
       `;

       sections.forEach(section => {
           const isMatched = precedentPanelState.relatedClauseIds.includes(section.para_id);
           const matchedClass = isMatched ? 'matched' : '';

           navHtml += `
               <div class="precedent-nav-item ${matchedClass}"
                    data-para-id="${section.para_id}"
                    onclick="scrollToPrecedentSection('${section.para_id}')">
                   <span class="precedent-nav-ref">${escapeHtml(section.number || '')}</span>
                   <span class="precedent-nav-text">${escapeHtml(section.title || '')}</span>
               </div>
           `;
       });

       navHtml += '</div>';
       navContainer.innerHTML = navHtml;

       // Setup IntersectionObserver for active section highlighting
       setupPrecedentNavObserver();
   }
   ```

5. Add IntersectionObserver for active section tracking:
   ```javascript
   let precedentNavObserver = null;

   function setupPrecedentNavObserver() {
       // Cleanup previous observer
       if (precedentNavObserver) {
           precedentNavObserver.disconnect();
       }

       const contentEl = document.getElementById('precedent-content-body');
       if (!contentEl) return;

       precedentNavObserver = new IntersectionObserver((entries) => {
           entries.forEach(entry => {
               if (entry.isIntersecting) {
                   const paraId = entry.target.dataset.paraId;
                   updatePrecedentNavActive(paraId);
               }
           });
       }, {
           root: contentEl,
           rootMargin: '-20% 0px -60% 0px',
           threshold: 0
       });

       // Observe all paragraph elements
       contentEl.querySelectorAll('.precedent-para').forEach(el => {
           precedentNavObserver.observe(el);
       });
   }

   function updatePrecedentNavActive(paraId) {
       document.querySelectorAll('.precedent-nav-item').forEach(item => {
           item.classList.remove('active');
       });
       const activeItem = document.querySelector(`.precedent-nav-item[data-para-id="${paraId}"]`);
       if (activeItem) {
           activeItem.classList.add('active');
           activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
       }
   }
   ```

6. Update `renderPrecedentPanel()` to render into the new structure (precedent-content area) and call `renderPrecedentNavigator()`.

7. Remove `body.classList.add/remove('precedent-panel-open')` calls as they're no longer needed.
  </action>
  <verify>
- `python -m flask run` starts without errors
- Open browser, load a session with precedent
- Click "Compare Precedent" - panel opens as split pane on right
- Drag gutter to resize - both panes resize smoothly
- Navigator appears on right side of precedent pane
- Refresh page after resize - sizes are persisted
  </verify>
  <done>Precedent panel uses Split.js for resizable split layout with dedicated navigator</done>
</task>

</tasks>

<verification>
1. Load the app with a session that has a precedent document
2. Select a clause in the main document
3. Click "Compare Precedent" button in sidebar
4. VERIFY: Panel appears as split pane (not overlay), main content shifts left
5. VERIFY: Drag the gutter between panes - resize works smoothly
6. VERIFY: Precedent navigator shows on right side with section list
7. VERIFY: Close and reopen - sizes are remembered
</verification>

<success_criteria>
- Split pane layout replaces overlay (UAT #1 fixed)
- Gutter is draggable and sizes persist to localStorage
- Precedent navigator displays sections on right side (UAT #2 fixed)
- Main document remains usable when precedent panel is open
- No regressions in existing precedent functionality (content display, text copying)
</success_criteria>

<output>
After completion, create `.planning/phases/03-compare-precedent-fix/03-01-SUMMARY.md`
</output>
