---
phase: 04-revision-bottom-sheet-track-changes
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - frontend/src/components/review/sidebar.tsx
  - frontend/src/components/review/risk-accordion.tsx
  - frontend/src/app/review/[sessionId]/page.tsx
  - frontend/src/components/review/bottom-bar.tsx
  - frontend/src/components/review/document-viewer.tsx
autonomous: false

must_haves:
  truths:
    - "User can click Generate Revision in sidebar footer and see a revision appear in the bottom sheet"
    - "Only included risks (from risk accordion toggles) are sent to the generate API"
    - "Bottom sheet auto-opens when user clicks a paragraph that already has a revision"
    - "Bottom bar hides when the revision sheet is open"
    - "Accepting a revision updates the paragraph's visual state in the document viewer to revision-accepted"
    - "Rejecting a revision closes the bottom sheet and removes the paragraph's revision styling"
  artifacts:
    - path: "frontend/src/components/review/sidebar.tsx"
      provides: "Wired Generate Revision button"
      contains: "useRevision"
    - path: "frontend/src/app/review/[sessionId]/page.tsx"
      provides: "RevisionSheet rendered in review page layout"
      contains: "RevisionSheet"
  key_links:
    - from: "frontend/src/components/review/sidebar.tsx"
      to: "frontend/src/hooks/use-revision.ts"
      via: "Generate Revision button calls useRevision().generate()"
      pattern: "generate\\("
    - from: "frontend/src/components/review/sidebar.tsx"
      to: "frontend/src/components/review/risk-accordion.tsx"
      via: "onGetIncludedRiskIds callback passes included risk IDs up"
      pattern: "onGetIncludedRiskIds|getIncludedRiskIds"
    - from: "frontend/src/app/review/[sessionId]/page.tsx"
      to: "frontend/src/components/review/revision-sheet.tsx"
      via: "RevisionSheet component rendered in page layout"
      pattern: "RevisionSheet"
    - from: "frontend/src/components/review/document-viewer.tsx"
      to: "frontend/src/lib/store.ts"
      via: "Auto-open bottom sheet when clicking paragraph with revision"
      pattern: "toggleBottomSheet|setRevisionSheetParaId"
---

<objective>
Wire the revision workflow end-to-end: enable the Generate Revision button, add RevisionSheet to the review page, auto-open on paragraphs with revisions, and handle BottomBar visibility.

Purpose: This connects all the infrastructure (Plan 01) and components (Plan 02) into a working user flow. After this plan, a user can generate a revision, see it, edit it inline, and accept/reject it.

Output: Modified sidebar, risk-accordion, page layout, bottom-bar, and document-viewer files.
</objective>

<execution_context>
@C:\Users\david\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\david\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-revision-bottom-sheet-track-changes/04-RESEARCH.md
@.planning/phases/04-revision-bottom-sheet-track-changes/04-01-SUMMARY.md
@.planning/phases/04-revision-bottom-sheet-track-changes/04-02-SUMMARY.md
@frontend/src/components/review/sidebar.tsx
@frontend/src/components/review/risk-accordion.tsx
@frontend/src/app/review/[sessionId]/page.tsx
@frontend/src/components/review/bottom-bar.tsx
@frontend/src/components/review/document-viewer.tsx
@frontend/src/hooks/use-revision.ts
@frontend/src/components/review/revision-sheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire sidebar Generate button + risk inclusion flow</name>
  <files>
    frontend/src/components/review/risk-accordion.tsx
    frontend/src/components/review/sidebar.tsx
  </files>
  <action>
**Part A: Expose included risk IDs from RiskAccordion**

The risk inclusion state (`riskInclusions`) currently lives as local state in `RiskAccordion`. The sidebar's "Generate Revision" button needs access to the included risk IDs.

Strategy: Add a callback prop to RiskAccordion that the sidebar can call to get included risk IDs at generation time. Use a ref-based approach to avoid lifting state:

1. Add a new prop to `RiskAccordionProps`:
   ```typescript
   onIncludedRiskIdsRef?: React.MutableRefObject<(() => string[]) | null>;
   ```
2. Inside RiskAccordion, after the `riskInclusions` state is defined, create a `getIncludedRiskIds` callback:
   ```typescript
   const getIncludedRiskIds = useCallback(() => {
     return risks
       .filter((r) => riskInclusions[r.risk_id] === undefined || riskInclusions[r.risk_id])
       .map((r) => r.risk_id);
   }, [risks, riskInclusions]);
   ```
3. Assign to the ref when it changes:
   ```typescript
   useEffect(() => {
     if (onIncludedRiskIdsRef) {
       onIncludedRiskIdsRef.current = getIncludedRiskIds;
     }
   }, [onIncludedRiskIdsRef, getIncludedRiskIds]);
   ```

**Part B: Wire the Generate Revision button in Sidebar**

1. Import `useRevision` from `@/hooks/use-revision` and `useRef` from React.
2. Create a ref: `const getIncludedRiskIdsRef = useRef<(() => string[]) | null>(null);`
3. Call the hook: `const { generate, generating } = useRevision();`
4. Pass the ref to RiskAccordion: `<RiskAccordion ... onIncludedRiskIdsRef={getIncludedRiskIdsRef} />`
5. Replace the disabled "Generate Revision" button in the footer with a working button:
   ```tsx
   <Button
     size="sm"
     className="h-7 text-xs"
     disabled={generating || paraRisks.length === 0}
     onClick={() => {
       if (!selectedParaId) return;
       const riskIds = getIncludedRiskIdsRef.current?.() ?? paraRisks.map(r => r.risk_id);
       if (riskIds.length > 0) {
         generate(selectedParaId, riskIds);
       }
     }}
   >
     {generating ? "Generating..." : "Generate Revision"}
   </Button>
   ```
6. Also read `revisions` from store and check if current paragraph already has a revision. If so, show "View Revision" button instead that opens the bottom sheet:
   ```tsx
   const revisions = useAppStore((s) => s.revisions);
   const hasRevision = selectedParaId ? !!revisions[selectedParaId] : false;
   ```
   If `hasRevision && !generating`: show "View Revision" button (outline variant) that sets `revisionSheetParaId` to `selectedParaId` and opens the bottom sheet.
   If `!hasRevision`: show "Generate Revision" button as above.
   Show both buttons side by side if revision exists (View + Regenerate).
  </action>
  <verify>
    - `npx tsc --noEmit` from `frontend/` passes
    - `grep "useRevision" frontend/src/components/review/sidebar.tsx` confirms hook import
    - `grep "onIncludedRiskIdsRef" frontend/src/components/review/risk-accordion.tsx` confirms prop exists
    - `grep "Generate Revision\|View Revision\|Generating" frontend/src/components/review/sidebar.tsx` confirms button states
    - The old `disabled` attribute on the Generate button is removed
  </verify>
  <done>
    - RiskAccordion exposes included risk IDs via ref callback
    - Sidebar Generate Revision button is enabled and calls useRevision().generate()
    - Only included (toggled-on) risks are sent to the API
    - Button shows "Generating..." during API call
    - If paragraph already has revision, shows "View Revision" button
    - Project compiles with no type errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add RevisionSheet to page layout + auto-open + BottomBar visibility</name>
  <files>
    frontend/src/app/review/[sessionId]/page.tsx
    frontend/src/components/review/bottom-bar.tsx
    frontend/src/components/review/document-viewer.tsx
  </files>
  <action>
**Part A: Add RevisionSheet to review page layout**

In `frontend/src/app/review/[sessionId]/page.tsx`:
1. Import `RevisionSheet` from `@/components/review/revision-sheet`
2. Add `<RevisionSheet />` inside the JSX, after `<Sidebar />` and before `<BottomBar />`. The Drawer renders with `position: fixed` so DOM order doesn't strictly matter, but placing it here is semantically clear.

**Part B: Hide BottomBar when revision sheet is open**

In `frontend/src/components/review/bottom-bar.tsx`:
1. Read `bottomSheetOpen` from store: `const bottomSheetOpen = useAppStore((s) => s.bottomSheetOpen);`
2. If `bottomSheetOpen`, return null (hide the bar entirely). This prevents the bar from conflicting with the Drawer's bottom positioning.
   ```tsx
   if (bottomSheetOpen) return null;
   ```

**Part C: Auto-open bottom sheet when clicking paragraph with existing revision**

In `frontend/src/components/review/document-viewer.tsx`:
1. Import `setRevisionSheetParaId` pattern — read from store.
2. Add a `useEffect` that watches `selectedParaId` and `revisions`:
   ```tsx
   useEffect(() => {
     if (!selectedParaId) return;
     const revision = revisions[selectedParaId];
     if (revision) {
       // Paragraph has a revision — show it in the bottom sheet
       const store = useAppStore.getState();
       store.setRevisionSheetParaId(selectedParaId);
       if (!store.bottomSheetOpen) {
         store.toggleBottomSheet();
       }
     } else {
       // Paragraph has no revision — update the sheet's paraId but don't auto-close
       // (user may want to keep the sheet open to compare)
       useAppStore.getState().setRevisionSheetParaId(selectedParaId);
     }
   }, [selectedParaId, revisions]);
   ```
   This ensures:
   - Clicking a paragraph with a revision auto-opens the sheet with that revision
   - Clicking a paragraph without a revision updates revisionSheetParaId (sheet shows "no revision" state)
   - The sheet does NOT auto-close when navigating to a paragraph without a revision (user controls close via drag-down or X button)

**Part D: Ensure document-viewer paragraph state classes still work**

The document-viewer already sets `has-revision` and `revision-accepted` classes in `updateParagraphStates`. Verify this still works correctly — the revision state is read from `revisions[paraId]` which is updated by useRevision's accept/reject/reopen methods. No changes needed here if the existing code already handles it (it does, per the code review). Just confirm the existing code in `updateParagraphStates` correctly toggles:
- `has-revision`: `!!revision && !revision.accepted`
- `revision-accepted`: `!!revision && revision.accepted`

This is already implemented. No change needed.
  </action>
  <verify>
    - `npx tsc --noEmit` from `frontend/` passes
    - `grep "RevisionSheet" frontend/src/app/review/\\[sessionId\\]/page.tsx` confirms import and usage
    - `grep "bottomSheetOpen" frontend/src/components/review/bottom-bar.tsx` confirms visibility toggle
    - `grep "setRevisionSheetParaId\|toggleBottomSheet" frontend/src/components/review/document-viewer.tsx` confirms auto-open logic
    - `npm run build` from `frontend/` succeeds
  </verify>
  <done>
    - RevisionSheet is rendered in the review page layout
    - BottomBar hides when the revision sheet is open
    - Clicking a paragraph with an existing revision auto-opens the bottom sheet
    - Clicking a paragraph without a revision updates the sheet's target paraId
    - Document viewer paragraph state classes (has-revision, revision-accepted) correctly reflect store state
    - Full workflow functional: select paragraph, generate revision, see diff, edit inline, accept/reject
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete revision workflow: Generate Revision button in sidebar collects included risks, calls API, displays track-changes diff in a bottom sheet drawer. Inline editing creates Word-style additions (blue) and deletions (red strikethrough). Accept/reject/reset/reopen lifecycle. Auto-opens when clicking paragraphs with revisions.
  </what-built>
  <how-to-verify>
    1. Start both servers: Flask on :5000, Next.js on :3000
    2. Navigate to a review session (load test session if needed)
    3. Wait for analysis to complete (risks populate)
    4. Click a paragraph that has risks — sidebar shows risk cards
    5. Click "Generate Revision" in the sidebar footer
    6. Verify: bottom sheet slides up from bottom with a diff display
    7. Verify: deleted text appears red with strikethrough, inserted text appears blue with underline
    8. Verify: rationale appears below the diff in a violet-bordered block
    9. Click inside the diff and type some text — verify it appears blue underline with yellow background
    10. Press backspace on some text — verify it shows red strikethrough with yellow background (not deleted)
    11. Press Ctrl+Z — verify undo works
    12. Click "Accept" — verify the sheet shows "Accepted" state with Reopen button
    13. Verify the paragraph in the document shows a green-tinted background (revision-accepted class)
    14. Click "Reopen" — verify the sheet returns to editable state
    15. Click "Reject" on a different revision — verify the sheet closes and the revision styling is removed
    16. Navigate to the accepted paragraph — verify the bottom sheet auto-opens showing the accepted revision
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` from `frontend/` succeeds
- Full revision lifecycle works end-to-end: generate, view, edit, accept, reject, reopen
- Bottom sheet uses non-modal Drawer (sidebar and document remain interactive)
- BottomBar hides when sheet is open
- Track changes editor respects Word-style conventions (additions blue, deletions red strikethrough)
</verification>

<success_criteria>
- Generate Revision button enabled and functional in sidebar
- Only included risks sent to API
- Bottom sheet displays revision with track-changes diff
- Inline editing creates proper track-changes markup
- Accept/reject/reset/reopen lifecycle works
- Auto-open on paragraphs with existing revisions
- BottomBar hides when sheet is open
- Visual verification by human confirms correct behavior
</success_criteria>

<output>
After completion, create `.planning/phases/04-revision-bottom-sheet-track-changes/04-03-SUMMARY.md`
</output>
