---
phase: 04-revision-bottom-sheet-track-changes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/track-changes.ts
  - frontend/src/hooks/use-revision.ts
  - frontend/src/lib/store.ts
  - frontend/src/lib/types.ts
  - frontend/src/app/globals.css
  - frontend/src/components/ui/drawer.tsx
autonomous: true

must_haves:
  truths:
    - "Track-changes DOM utilities (extractFinalText, wrapRangeAsDeleted, insertUserText, selectCharacterBefore/After) are importable and functional"
    - "useRevision hook can call generate/accept/reject/reopen lifecycle methods"
    - "shadcn Drawer component is installed and importable"
    - "Track-changes CSS styles render diff-del, diff-ins, user-addition, user-deletion with correct visual treatment"
  artifacts:
    - path: "frontend/src/lib/track-changes.ts"
      provides: "Pure DOM manipulation utilities for contentEditable track changes"
      exports: ["extractFinalText", "wrapRangeAsDeleted", "insertUserText", "selectCharacterBefore", "selectCharacterAfter", "getPreviousNode"]
    - path: "frontend/src/hooks/use-revision.ts"
      provides: "Revision lifecycle hook (generate, accept, reject, reopen)"
      exports: ["useRevision"]
    - path: "frontend/src/components/ui/drawer.tsx"
      provides: "shadcn Drawer primitive component"
      exports: ["Drawer", "DrawerContent", "DrawerHeader", "DrawerTitle", "DrawerFooter", "DrawerTrigger"]
  key_links:
    - from: "frontend/src/hooks/use-revision.ts"
      to: "/api/revise, /api/accept, /api/reject"
      via: "api.ts typed functions (revise, acceptRevision, rejectRevision)"
      pattern: "import.*from.*@/lib/api"
    - from: "frontend/src/hooks/use-revision.ts"
      to: "frontend/src/lib/store.ts"
      via: "useAppStore for setRevision, removeRevision, toggleBottomSheet"
      pattern: "useAppStore"
---

<objective>
Install shadcn Drawer, port track-changes DOM utilities from revision.js, create the useRevision lifecycle hook, extend store/types, and add track-changes CSS.

Purpose: This is the infrastructure layer that Plan 02 (components) and Plan 03 (wiring) build on. The track-changes logic is pure DOM manipulation that must be ported accurately from the old revision.js. The useRevision hook encapsulates the API lifecycle so components stay simple.

Output: `track-changes.ts` (DOM utils), `use-revision.ts` (hook), Drawer component, CSS styles, store/type extensions.
</objective>

<execution_context>
@C:\Users\david\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\david\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-revision-bottom-sheet-track-changes/04-RESEARCH.md
@frontend/src/lib/store.ts
@frontend/src/lib/types.ts
@frontend/src/lib/api.ts
@frontend/src/app/globals.css
@app/static/js/revision.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Drawer + Create track-changes.ts + Add CSS</name>
  <files>
    frontend/src/components/ui/drawer.tsx
    frontend/src/lib/track-changes.ts
    frontend/src/lib/types.ts
    frontend/src/lib/store.ts
    frontend/src/app/globals.css
  </files>
  <action>
1. Install shadcn Drawer: run `npx shadcn@latest add drawer` from the `frontend/` directory. This installs vaul and creates `components/ui/drawer.tsx`.

2. Create `frontend/src/lib/track-changes.ts` — port the following functions from `app/static/js/revision.js`:
   - `extractFinalText(element: HTMLElement): string` — walks child nodes, skips `.user-deletion` and `.diff-del` elements, concatenates all other text content. Port from lines 861-880 of revision.js.
   - `wrapRangeAsDeleted(range: Range): void` — if selection is inside `.user-addition`, actually delete it (and remove empty parent). Otherwise, extract contents into `<span class="user-deletion">` and insert. Move cursor after span. Port from lines 471-507.
   - `insertUserText(text: string): void` — if cursor is inside `.user-addition` span, splice text into the existing text node at cursor offset. If previous sibling is `.user-addition`, append to it. Otherwise create new `<span class="user-addition">` and insert. Move cursor to end. Port from lines 531-586. Include the `getPreviousNode` helper (lines 589-601).
   - `selectCharacterBefore(range: Range): void` — skips over `.user-deletion` spans (they are already "deleted"), then selects one character before cursor. Port from lines 388-431.
   - `selectCharacterAfter(range: Range): void` — same but forward direction. Port from lines 434-468.
   All functions are pure DOM manipulation using Range, Selection, TreeWalker — no React dependencies. Export all as named exports. Add TypeScript types where appropriate.

3. Extend `frontend/src/lib/types.ts` — add `editedHtml?: string` field to the `Revision` interface (after `timestamp`). This stores user inline edits across paragraph switches.

4. Extend `frontend/src/lib/store.ts` — add two new state properties and actions:
   - `generatingRevision: boolean` (initial: `false`) in UIState interface
   - `setGeneratingRevision: (v: boolean) => void` in AppStore interface
   - `revisionSheetParaId: string | null` (initial: `null`) in ReviewState interface — tracks which paragraph's revision is displayed in the sheet (may differ from selectedParaId)
   - `setRevisionSheetParaId: (paraId: string | null) => void` in AppStore interface
   Add these to the corresponding initial state objects and implement the setters.

5. Add track-changes CSS to `frontend/src/app/globals.css` inside the existing `@layer components` block (after the `.risk-highlight-active` rule). Add these rules exactly:
   ```css
   /* Track changes in revision editor */
   .revision-diff {
     background: oklch(0.98 0 0);
     border: 1px solid var(--border);
     border-radius: 8px;
     padding: 1.25rem;
     font-family: inherit;
     font-size: 0.9375rem;
     line-height: 1.7;
     max-height: 200px;
     overflow-y: auto;
     transition: all 150ms;
   }
   .revision-diff:hover {
     background: oklch(1 0 0);
     border-color: oklch(0.546 0.215 264);
     box-shadow: 0 0 0 2px oklch(0.546 0.215 264 / 0.1);
   }
   .revision-diff[contenteditable="true"] {
     cursor: text;
     outline: none;
   }
   .revision-diff[contenteditable="true"]:focus {
     box-shadow: 0 0 0 2px oklch(0.546 0.215 264 / 0.2);
   }
   .revision-diff.user-modified {
     border-color: oklch(0.705 0.213 47.604);
     background: oklch(1 0 0);
   }
   .diff-del, del.diff-del {
     color: #b91c1c;
     text-decoration: line-through;
     text-decoration-color: #b91c1c;
   }
   .diff-ins, ins.diff-ins {
     color: #1d4ed8;
     text-decoration: underline;
     text-decoration-style: solid;
   }
   .user-addition {
     background: #fef9c3;
     color: #1d4ed8;
     text-decoration: underline;
     text-decoration-color: #1d4ed8;
     padding: 0 1px;
   }
   .user-deletion {
     background: #fef9c3;
     color: #dc2626;
     text-decoration: line-through;
     text-decoration-color: #dc2626;
     padding: 0 1px;
   }
   ```
  </action>
  <verify>
    - `ls frontend/src/components/ui/drawer.tsx` confirms Drawer installed
    - `ls frontend/src/lib/track-changes.ts` confirms file exists
    - `npx tsc --noEmit` from `frontend/` passes with no type errors
    - Verify track-changes.ts exports: `grep "export function" frontend/src/lib/track-changes.ts` shows all 6 functions
    - Verify store extensions: `grep "generatingRevision\|revisionSheetParaId" frontend/src/lib/store.ts` shows both
    - Verify CSS added: `grep "revision-diff\|diff-del\|diff-ins\|user-addition\|user-deletion" frontend/src/app/globals.css`
  </verify>
  <done>
    - shadcn Drawer component installed at components/ui/drawer.tsx
    - track-changes.ts exports extractFinalText, wrapRangeAsDeleted, insertUserText, selectCharacterBefore, selectCharacterAfter, getPreviousNode
    - Revision type has editedHtml optional field
    - Store has generatingRevision + revisionSheetParaId state with setters
    - globals.css has all track-changes CSS classes
    - Project compiles with no type errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useRevision lifecycle hook</name>
  <files>frontend/src/hooks/use-revision.ts</files>
  <action>
Create `frontend/src/hooks/use-revision.ts` implementing the full revision lifecycle:

```typescript
"use client";
import { useCallback } from "react";
import { useAppStore } from "@/lib/store";
import { revise, acceptRevision, rejectRevision } from "@/lib/api";
import { extractFinalText } from "@/lib/track-changes";
import { toast } from "sonner";
```

The hook returns `{ generate, accept, reject, reopen, generating }`.

**generate** — `async (paraId: string, riskIds: string[], includeRelatedIds?: string[], customInstruction?: string) => void`
  - Guard: return early if no sessionId or riskIds.length === 0
  - Set `generatingRevision = true` in store
  - Call `revise({ session_id: sessionId, para_id: paraId, risk_ids: riskIds, include_related_ids: includeRelatedIds, custom_instruction: customInstruction })`
  - On success: call `setRevision(paraId, { original, revised, rationale, thinking, diff_html, related_revisions, accepted: false, timestamp: new Date().toISOString() })` mapping from the ReviseResponse
  - Set `revisionSheetParaId` to paraId
  - If `!bottomSheetOpen`, call `toggleBottomSheet()`
  - `toast.success("Revision generated")`
  - On error: `toast.error(err instanceof Error ? err.message : "Revision failed")`
  - Finally: set `generatingRevision = false`

**accept** — `async (paraId: string, editorElement?: HTMLElement | null) => void`
  - Guard: return early if no sessionId
  - If editorElement provided, persist edited HTML: read `editorElement.innerHTML` and `extractFinalText(editorElement)`, then `setRevision(paraId, { ...current, editedHtml: editorElement.innerHTML, revised: extractFinalText(editorElement) })`
  - Call `acceptRevision({ session_id: sessionId, para_id: paraId })`
  - Update revision in store: `setRevision(paraId, { ...current, accepted: true })`
  - Log `result.affected_para_ids` if any, and show toast: `toast.success("Revision accepted")` or `toast.success(\`Revision accepted (${result.affected_para_ids.length} related clauses may need re-analysis)\`)` if affected_para_ids is non-empty
  - On error: `toast.error(...)`

**reject** — `async (paraId: string) => void`
  - Guard: return early if no sessionId
  - Call `rejectRevision({ session_id: sessionId, para_id: paraId })`
  - `removeRevision(paraId)`
  - Close bottom sheet if still open: `if (bottomSheetOpen) toggleBottomSheet()`
  - Set `revisionSheetParaId` to null
  - `toast.info("Revision rejected")`
  - On error: `toast.error(...)`

**reopen** — `(paraId: string) => void` (synchronous, no API call)
  - Get current revision from store. If not found, return.
  - `setRevision(paraId, { ...current, accepted: false })`
  - Keep editedHtml so user continues from where they left off
  - `toast.info("Revision reopened for editing")`

**generating** — read `generatingRevision` from store.

All callbacks should use `useCallback` with proper dependencies. Read store state via `useAppStore.getState()` inside callbacks to avoid stale closures, but read `generatingRevision` as a subscribed selector for reactivity.
  </action>
  <verify>
    - `npx tsc --noEmit` from `frontend/` passes with no type errors
    - `grep "export function useRevision" frontend/src/hooks/use-revision.ts` confirms the hook exists
    - `grep "generate\|accept\|reject\|reopen\|generating" frontend/src/hooks/use-revision.ts` confirms all members
  </verify>
  <done>
    - useRevision hook exports generate, accept, reject, reopen, generating
    - generate calls POST /api/revise via typed API client, stores result, opens bottom sheet
    - accept persists edited HTML, calls POST /api/accept, marks revision accepted
    - reject calls POST /api/reject, removes revision, closes sheet
    - reopen flips accepted to false without API call
    - All operations show toast notifications on success/error
    - Project compiles with no type errors
  </done>
</task>

</tasks>

<verification>
- `npm run build` from `frontend/` completes without errors
- All new files exist: drawer.tsx, track-changes.ts, use-revision.ts
- Store has generatingRevision and revisionSheetParaId
- Revision type has editedHtml field
- CSS has all track-changes classes
- No runtime test needed — this is pure infrastructure; components built in Plan 02 will exercise it
</verification>

<success_criteria>
- shadcn Drawer installed and importable
- track-changes.ts has 6 exported DOM utility functions ported from revision.js
- useRevision hook implements full generate/accept/reject/reopen lifecycle
- Store extended with generatingRevision and revisionSheetParaId
- Revision type extended with editedHtml
- Track-changes CSS in globals.css
- `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-revision-bottom-sheet-track-changes/04-01-SUMMARY.md`
</output>
