---
phase: 04-revision-bottom-sheet-track-changes
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - frontend/src/components/review/revision-sheet.tsx
  - frontend/src/components/review/track-changes-editor.tsx
  - frontend/src/components/review/revision-actions.tsx
autonomous: true

must_haves:
  truths:
    - "RevisionSheet displays as a non-modal bottom drawer with snap points (200px, 50%, full)"
    - "TrackChangesEditor renders diff_html in a contentEditable div managed by refs (React does NOT reconcile it)"
    - "User can type text that appears as blue underline with yellow background (user-addition)"
    - "User can backspace/delete text that appears as red strikethrough with yellow background (user-deletion)"
    - "Undo (Ctrl+Z) and redo (Ctrl+Shift+Z / Ctrl+Y) work correctly"
    - "Accept/Reject/Reset/Reopen buttons are shown based on revision state"
    - "Rationale is displayed below the diff editor"
  artifacts:
    - path: "frontend/src/components/review/revision-sheet.tsx"
      provides: "Drawer-based bottom sheet wrapping revision content"
      exports: ["RevisionSheet"]
    - path: "frontend/src/components/review/track-changes-editor.tsx"
      provides: "ContentEditable wrapper with track-changes behavior"
      exports: ["TrackChangesEditor"]
    - path: "frontend/src/components/review/revision-actions.tsx"
      provides: "Accept/reject/reset/reopen button bar"
      exports: ["RevisionActions"]
  key_links:
    - from: "frontend/src/components/review/track-changes-editor.tsx"
      to: "frontend/src/lib/track-changes.ts"
      via: "imports wrapRangeAsDeleted, insertUserText, selectCharacterBefore, selectCharacterAfter"
      pattern: "import.*from.*@/lib/track-changes"
    - from: "frontend/src/components/review/revision-sheet.tsx"
      to: "frontend/src/lib/store.ts"
      via: "reads bottomSheetOpen, revisions, revisionSheetParaId from store"
      pattern: "useAppStore"
    - from: "frontend/src/components/review/revision-actions.tsx"
      to: "frontend/src/hooks/use-revision.ts"
      via: "calls accept, reject, reopen from useRevision hook"
      pattern: "useRevision"
---

<objective>
Build the three revision UI components: the Drawer-based RevisionSheet, the imperative TrackChangesEditor, and the RevisionActions button bar.

Purpose: These are the visual components that let the user see, edit, and act on revisions. The TrackChangesEditor is the most complex — it must manage contentEditable entirely through refs, intercepting beforeinput/keydown events to produce Word-style track changes. The RevisionSheet wraps everything in a shadcn Drawer with snap points.

Output: Three new components in `frontend/src/components/review/`.
</objective>

<execution_context>
@C:\Users\david\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\david\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-revision-bottom-sheet-track-changes/04-RESEARCH.md
@.planning/phases/04-revision-bottom-sheet-track-changes/04-01-SUMMARY.md
@frontend/src/lib/track-changes.ts
@frontend/src/hooks/use-revision.ts
@frontend/src/lib/store.ts
@frontend/src/lib/types.ts
@frontend/src/components/ui/drawer.tsx
@app/static/js/revision.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TrackChangesEditor component</name>
  <files>frontend/src/components/review/track-changes-editor.tsx</files>
  <action>
Create `frontend/src/components/review/track-changes-editor.tsx` — a React component wrapping a contentEditable div with imperative track-changes behavior.

**Props interface:**
```typescript
interface TrackChangesEditorProps {
  diffHtml: string;           // HTML from backend diff_html (or editedHtml if user edited previously)
  readOnly: boolean;          // true when revision is accepted
  onModified: () => void;     // called when user makes first edit (show reset button)
  editorRef: React.RefObject<HTMLDivElement | null>; // exposed to parent for reading innerHTML
}
```

**Key implementation rules — React MUST NOT reconcile the contentEditable DOM subtree:**
1. Use a local `divRef` merged with the passed `editorRef` (use a callback ref or useImperativeHandle pattern so parent can also access the DOM element). Simplest: just use the passed `editorRef` directly.
2. In a `useEffect` keyed on `[diffHtml]`: set `editorRef.current.innerHTML = diffHtml`, reset undo/redo stacks (stored in `useRef<string[]>([])`), reset `isModifiedRef` to false.
3. In a separate `useEffect` keyed on `[readOnly]`: if `readOnly` changes to true, set contentEditable to false. If false, set to true and attach event listeners.
4. **Event listeners** — attach in a `useEffect` that runs when `readOnly` is false:
   - `beforeinput` handler: for `insertText` and `insertParagraph` inputTypes — `e.preventDefault()`, call `saveUndoState()`, if selection is not collapsed call `wrapRangeAsDeleted(range)`, then call `insertUserText(text)`, then call `onModified()`. Import these from `@/lib/track-changes`.
   - `keydown` handler:
     - Ctrl+Z → undo (pop from undoStack, push current to redoStack, set innerHTML, call onModified)
     - Ctrl+Shift+Z or Ctrl+Y → redo (pop from redoStack, push current to undoStack, set innerHTML, call onModified)
     - Backspace/Delete → `e.preventDefault()`, saveUndoState, if selection not collapsed call `wrapRangeAsDeleted`, else call `selectCharacterBefore` (Backspace) or `selectCharacterAfter` (Delete) then `wrapRangeAsDeleted` on the new selection. Call onModified.
   - Return cleanup function that removes both listeners.
5. `saveUndoState`: push `editorRef.current.innerHTML` to undoStackRef, cap at 50 entries, clear redoStackRef.
6. The component renders only: `<div ref={editorRef} className="revision-diff" contentEditable={!readOnly} suppressContentEditableWarning />`. No children. No dangerouslySetInnerHTML (that would cause React to reconcile). The innerHTML is set imperatively in the useEffect.

**CRITICAL anti-pattern:** Do NOT store diffHtml in React state and pass to dangerouslySetInnerHTML. Do NOT store edited content in React state (causes re-render and cursor loss). Everything stays in refs.
  </action>
  <verify>
    - `npx tsc --noEmit` from `frontend/` passes
    - `grep "contentEditable" frontend/src/components/review/track-changes-editor.tsx` shows the div
    - `grep "beforeinput\|keydown" frontend/src/components/review/track-changes-editor.tsx` shows both event handlers
    - `grep "import.*from.*@/lib/track-changes" frontend/src/components/review/track-changes-editor.tsx` confirms track-changes import
    - File does NOT contain `dangerouslySetInnerHTML` (critical check)
  </verify>
  <done>
    - TrackChangesEditor renders a ref-managed contentEditable div
    - React never reconciles the innerHTML (set imperatively in useEffect)
    - beforeinput intercepts text insertion, wraps in user-addition spans
    - keydown intercepts backspace/delete, wraps in user-deletion spans
    - Ctrl+Z/Y undo/redo work via innerHTML snapshot stacks
    - readOnly prop disables editing when revision is accepted
    - editorRef is exposed to parent for reading final content
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RevisionActions and RevisionSheet components</name>
  <files>
    frontend/src/components/review/revision-actions.tsx
    frontend/src/components/review/revision-sheet.tsx
  </files>
  <action>
**Part A: Create `revision-actions.tsx`**

A button bar that shows different buttons based on revision state:

Props:
```typescript
interface RevisionActionsProps {
  paraId: string;
  accepted: boolean;
  isModified: boolean;    // true if user has made inline edits
  onAccept: () => void;
  onReject: () => void;
  onReset: () => void;
  onReopen: () => void;
}
```

When `accepted === true`:
- Show green checkmark + "Accepted" label
- Show "Reopen" button (secondary variant, calls onReopen)

When `accepted === false`:
- Show "Accept" button (default variant with Check icon, calls onAccept)
- Show "Reset" button (outline variant with RotateCcw icon, only visible when isModified === true, calls onReset)
- Show "Reject" button (destructive variant with X icon, calls onReject)

Use shadcn Button, lucide-react icons (Check, X, RotateCcw, RotateCw).
Layout: `flex items-center gap-2` with the action buttons. Accepted state has green text "Accepted" with a checkmark.

**Part B: Create `revision-sheet.tsx`**

The main bottom sheet component using shadcn Drawer.

```typescript
import { Drawer, DrawerContent, DrawerHeader, DrawerTitle } from "@/components/ui/drawer";
```

**State management:**
- Read `bottomSheetOpen`, `revisions`, `revisionSheetParaId`, `toggleBottomSheet`, `setRevision` from store
- Get the current revision: `revisions[revisionSheetParaId]`
- Use `useRevision()` hook for accept/reject/reopen
- Track `isModified` state locally with `useState<boolean>(false)` — set to true when TrackChangesEditor calls onModified, reset to false when diffHtml changes

**Drawer configuration:**
```typescript
const SNAP_POINTS = [0.25, 0.5, 1] as const;
// Use fraction-based snap points (25%, 50%, 100%) rather than pixel-based
// This adapts better to different screen sizes
```
- `direction="bottom"`, `modal={false}`, `dismissible={true}`
- `open={bottomSheetOpen}`
- `onOpenChange`: if closing, call toggleBottomSheet. Before closing, if editor has content and revision exists, persist editedHtml to store.
- Snap points: `[0.25, 0.5, 1]`, default active snap: `0.5`

**Layout structure inside DrawerContent:**
1. **DrawerHeader** — drag handle (built-in to Drawer) + title showing section ref and paragraph excerpt (from the revision's original text, first 60 chars). Show a close button (X icon) on the right.
2. **Editor area** — `<TrackChangesEditor diffHtml={revision.editedHtml || revision.diff_html} readOnly={revision.accepted} onModified={() => setIsModified(true)} editorRef={editorRef} />`
3. **Rationale** — styled block below editor: `<div className="rounded-r border-l-[3px] border-violet-500 bg-gradient-to-r from-violet-50 to-purple-50 px-3 py-2.5 text-sm italic text-muted-foreground">` with "Rationale: " prefix in bold, then the rationale text. Only show if rationale exists.
4. **RevisionActions** — wire accept to `useRevision().accept(paraId, editorRef.current)`, reject to `useRevision().reject(paraId)`, reopen to `useRevision().reopen(paraId)`, reset to `() => { editorRef.current.innerHTML = revision.diff_html; setIsModified(false); }`.

**Persist edits on paragraph switch:**
Add a `useEffect` watching `revisionSheetParaId`. When it changes, if the previous paraId had a revision and the editor has content, persist `editedHtml` to the store before switching. Use a `prevParaIdRef` to track the previous value.

**Empty state:** If `revisionSheetParaId` is null or no revision exists for it, show a minimal message: "No revision to display. Select a paragraph and generate a revision."

**Styling:** The DrawerContent should have padding, max-width-none (it should span the available width). Add `className="mx-0"` or similar to avoid default centering. The Drawer overlay should NOT block interaction with sidebar (this is handled by `modal={false}`).
  </action>
  <verify>
    - `npx tsc --noEmit` from `frontend/` passes
    - `grep "export function RevisionSheet" frontend/src/components/review/revision-sheet.tsx` confirms export
    - `grep "export function RevisionActions" frontend/src/components/review/revision-actions.tsx` confirms export
    - `grep "Drawer" frontend/src/components/review/revision-sheet.tsx` confirms Drawer usage
    - `grep "TrackChangesEditor" frontend/src/components/review/revision-sheet.tsx` confirms editor integration
    - `grep "useRevision" frontend/src/components/review/revision-sheet.tsx` confirms hook usage
  </verify>
  <done>
    - RevisionSheet renders as a non-modal bottom Drawer with snap points (25%, 50%, full)
    - Shows header with section ref, editor with track-changes behavior, rationale, and action buttons
    - Controlled by bottomSheetOpen and revisionSheetParaId from store
    - Persists editedHtml to store on paragraph switch and on close
    - RevisionActions shows Accept/Reject/Reset when pending, Accepted/Reopen when accepted
    - Reset restores original diff_html
    - All actions wired through useRevision hook
    - Project compiles with no type errors
  </done>
</task>

</tasks>

<verification>
- `npm run build` from `frontend/` completes without errors
- All three component files exist and export their named components
- TrackChangesEditor does NOT use dangerouslySetInnerHTML
- RevisionSheet uses shadcn Drawer with modal={false}
- RevisionActions conditionally renders based on accepted state
</verification>

<success_criteria>
- TrackChangesEditor renders contentEditable div with imperative event handling
- User text insertion creates user-addition spans (blue underline, yellow bg)
- Backspace/delete creates user-deletion spans (red strikethrough, yellow bg)
- Undo/redo work via Ctrl+Z/Y
- RevisionSheet shows Drawer with snap points, header, editor, rationale, actions
- RevisionActions shows correct buttons for pending vs accepted states
- EditedHtml persisted to store on paragraph switch
- `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-revision-bottom-sheet-track-changes/04-02-SUMMARY.md`
</output>
