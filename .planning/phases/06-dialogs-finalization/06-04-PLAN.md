---
phase: 06-dialogs-finalization
plan: 04
type: execute
wave: 1
depends_on: ["06-01"]
files_modified:
  - frontend/src/components/review/flags-tab.tsx
  - frontend/src/components/review/document-viewer.tsx
  - frontend/src/app/globals.css
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Clicking anywhere on a flag card navigates/scrolls to the flagged paragraph"
    - "Flag cards do NOT show quoted text excerpt; instead clicking navigates to paragraph which highlights it"
    - "Flag cards have a pencil edit icon that opens the flag for editing"
    - "Flag margin icons appear on the RIGHT side of the paragraph, not the left"
    - "Hovering a flag margin icon shows the flag note text as a tooltip"
    - "Clicking a flag margin icon navigates to the flag in the flags tab"
    - "Text selection in document produces a floating Flag button reliably on first select"
    - "Clicking the floating Flag button opens the Flag Dialog"
  artifacts:
    - path: "frontend/src/components/review/flags-tab.tsx"
      provides: "FlagCard with full-card click navigation, edit button, no text excerpt"
      contains: "onClick"
    - path: "frontend/src/app/globals.css"
      provides: "Right-side flag margin icons with tooltip support"
      contains: "right"
    - path: "frontend/src/components/review/document-viewer.tsx"
      provides: "Fixed text selection flagging with all 3 bugs resolved"
      contains: "suppressSelectionClear"
  key_links:
    - from: "frontend/src/components/review/flags-tab.tsx"
      to: "frontend/src/components/review/document-viewer.tsx"
      via: "selectParagraph -> scrollIntoView"
      pattern: "selectParagraph"
    - from: "frontend/src/app/globals.css"
      to: "frontend/src/components/review/document-viewer.tsx"
      via: "data-flag-category attribute drives CSS pseudo-element styling"
      pattern: "data-flag-category"
---

<objective>
Fix flag card navigation, enhance flag cards (remove excerpt, add edit button), move margin flag icons to right side with tooltip/click behavior, and commit the already-applied text selection flagging fixes.

Purpose: Closes UAT gaps from Tests 2, 3, and 4, plus enhancements from Tests 1 and 3.
Output: Fully functional flag card interaction, right-side margin icons with hover/click, reliable text selection flagging.
</objective>

<execution_context>
@C:/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dialogs-finalization/06-01-SUMMARY.md
@.planning/phases/06-dialogs-finalization/06-UAT.md
@.planning/debug/flag-card-navigation.md
@.planning/debug/text-selection-flagging.md
@frontend/src/components/review/flags-tab.tsx
@frontend/src/components/review/document-viewer.tsx
@frontend/src/app/globals.css
@frontend/src/lib/store.ts
@frontend/src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix flag card navigation + remove excerpt + add edit button</name>
  <files>frontend/src/components/review/flags-tab.tsx</files>
  <action>
Read `frontend/src/components/review/flags-tab.tsx` and make these changes to the FlagCard component:

**1. Full-card click navigation (GAP FIX -- Test 2):**

On the FlagCard outer `<div>` (currently line 57), add an onClick handler and cursor-pointer:

```tsx
<div
  className="group relative cursor-pointer rounded-lg border p-3 transition-colors hover:bg-accent/30"
  onClick={() => onClickSection?.(flag.para_id)}
>
```

This makes the entire card clickable for navigation, not just the tiny section_ref Badge. The section_ref Badge's own onClick can remain (it provides the same action, just a more specific click target). The remove button (X) already uses `event.stopPropagation()` implicitly since it's a separate `<button>` element -- BUT to be safe, add `onClick={(e) => { e.stopPropagation(); onRemove(flag.para_id); }}` to the remove button to prevent the card's onClick from also firing.

**2. Remove quoted text excerpt (Enhancement -- Test 1):**

Delete the text_excerpt block entirely (currently lines 87-91):
```tsx
{/* DELETE THIS BLOCK */}
{flag.text_excerpt && (
  <p className="mt-1 text-[10px] italic text-muted-foreground/70 line-clamp-2">
    &ldquo;{flag.text_excerpt}&rdquo;
  </p>
)}
```

The user wants to see the flagged language highlighted in the document when clicking the card, NOT displayed as quoted text on the card. The card-level onClick navigation already handles this.

**3. Add edit button (Enhancement -- Test 1):**

Import `Pencil` from lucide-react (add to existing import from lucide-react at top of file).

Add a pencil edit button NEXT TO the remove (X) button in the top-right corner of FlagCard. Position them as a row:

Replace the single remove button with a button group:
```tsx
{/* Action buttons (top right) */}
<div className="absolute right-2 top-2 flex items-center gap-0.5 opacity-0 transition-opacity group-hover:opacity-100">
  <button
    onClick={(e) => {
      e.stopPropagation();
      onEdit?.(flag);
    }}
    className="rounded p-0.5 text-muted-foreground/50 hover:bg-accent hover:text-foreground"
    title="Edit flag"
  >
    <Pencil className="h-3 w-3" />
  </button>
  <button
    onClick={(e) => {
      e.stopPropagation();
      onRemove(flag.para_id);
    }}
    className="rounded p-0.5 text-muted-foreground/50 hover:bg-destructive/10 hover:text-destructive"
    title="Remove flag"
  >
    <X className="h-3.5 w-3.5" />
  </button>
</div>
```

Add `onEdit?: (flag: Flag) => void` to FlagCard's props interface.

In the FlagsTab component, add state and handler for flag editing:
- Add state: `const [editingFlag, setEditingFlag] = useState<Flag | null>(null);`
- Create handler: `const handleEdit = (flag: Flag) => { setEditingFlag(flag); setFlagDialogOpen(true); };`
- Pass `onEdit={handleEdit}` to every FlagCard instance.
- When the FlagDialog for editing opens, it should be pre-populated. Pass the editing flag's category and note as defaults to FlagDialog. Since FlagDialog currently creates NEW flags, and editing requires removing the old + creating a new one (the backend flag API is idempotent per para_id), handle this by:
  - When `editingFlag` is set, pass its `category` and `note` as `defaultCategory` and `defaultNote` props to FlagDialog.
  - In the FlagDialog's onOpenChange callback: when closing, clear `editingFlag`.
  - The existing FlagDialog create flow already removes + recreates the flag for the para_id because the backend's `/flag` endpoint replaces any existing flag for the same para_id.

Update FlagDialog rendering in the paragraph-selected section to handle edit mode:
```tsx
<FlagDialog
  open={flagDialogOpen}
  onOpenChange={(open) => {
    setFlagDialogOpen(open);
    if (!open) setEditingFlag(null);
  }}
  paraId={editingFlag?.para_id ?? paraId}
  defaultCategory={editingFlag?.category}
  defaultNote={editingFlag?.note}
/>
```

Also add the same edit handling in the no-paragraph-selected section. For the "All Flags" list when no paragraph is selected, the FlagDialog currently can't open (button is disabled). To support editing from the all-flags view:
- At the top of the FlagsTab, add a second FlagDialog render for the edit case that doesn't depend on paraId:
```tsx
{editingFlag && (
  <FlagDialog
    open={flagDialogOpen}
    onOpenChange={(open) => {
      setFlagDialogOpen(open);
      if (!open) setEditingFlag(null);
    }}
    paraId={editingFlag.para_id}
    defaultCategory={editingFlag.category}
    defaultNote={editingFlag.note}
  />
)}
```
- Remove the existing FlagDialog render at the bottom of the paragraph-selected section to avoid duplicate dialogs. Use the single top-level dialog for both creating and editing.
- For creating new flags (Add Flag button), set `editingFlag` to null and open the dialog: `onClick={() => { setEditingFlag(null); setFlagDialogOpen(true); }}`

**4. Date format TODO:**

Add a comment near the timestamp display in FlagCard:
```tsx
{/* TODO: Add locale preference to user settings (currently uses browser locale) */}
```

**5. FlagDialog defaultNote prop:**

Read `frontend/src/components/dialogs/flag-dialog.tsx`. Add an optional `defaultNote?: string` prop. Use it to initialize the note textarea state: `const [note, setNote] = useState(defaultNote ?? "")`. Add a useEffect to update note when defaultNote changes (for when the dialog opens with a different flag):
```tsx
useEffect(() => {
  if (open) {
    setNote(defaultNote ?? "");
  }
}, [open, defaultNote]);
```

Similarly, the `defaultCategory` prop already exists -- verify it's being used to initialize the category state on open. If the category state is initialized from defaultCategory only once (useState initializer), add a similar useEffect for open + defaultCategory.
  </action>
  <verify>
- `npx tsc --noEmit` passes with no errors
- FlagCard has onClick on outer div calling onClickSection
- FlagCard has onEdit prop and pencil button
- FlagCard does NOT render text_excerpt
- Remove button has stopPropagation
- FlagDialog accepts defaultNote prop
- Single FlagDialog instance handles both create and edit flows
  </verify>
  <done>
- Clicking anywhere on a flag card navigates to the flagged paragraph in the document
- Flag cards show category badge, section ref, note, and timestamp -- but NOT the quoted text
- Pencil icon appears on hover, clicking it opens the flag dialog pre-populated for editing
- Edit flow replaces the existing flag via the idempotent backend endpoint
  </done>
</task>

<task type="auto">
  <name>Task 2: Move flag icons to right side + tooltip + click navigation</name>
  <files>
    frontend/src/app/globals.css
    frontend/src/components/review/document-viewer.tsx
  </files>
  <action>
**globals.css -- Move flag icons to right side (Enhancement -- Test 3):**

Read `frontend/src/app/globals.css` and find the flag icon CSS rules (around lines 230-261).

Change the `.flagged::before` pseudo-element positioning from LEFT to RIGHT:

Current (left side):
```css
.document-container [data-para-id].flagged::before {
  content: '';
  position: absolute;
  left: -20px;
  top: 4px;
  width: 14px;
  height: 14px;
  ...
}
```

Updated (right side):
```css
.document-container [data-para-id].flagged::after {
  content: '';
  position: absolute;
  right: -20px;
  top: 4px;
  width: 14px;
  height: 14px;
  background-size: contain;
  background-repeat: no-repeat;
  opacity: 0.7;
  cursor: pointer;
  pointer-events: auto;
}
```

NOTE: Switch from `::before` to `::after` to avoid conflicting with any existing `::before` usage. Update ALL four category selectors to use `::after` as well:
- `[data-flag-category="business-decision"]::after`
- `[data-flag-category="risk-alert"]::after`
- `[data-flag-category="for-discussion"]::after`
- `[data-flag-category="fyi"]::after`

Also update the base `.flagged` style box-shadow to be on the right side (it's already `inset -3px 0 0` which is right-side -- keep as-is).

Add hover effect:
```css
.document-container [data-para-id].flagged::after:hover {
  opacity: 1;
  transform: scale(1.2);
}
```

**document-viewer.tsx -- Flag icon tooltip and click behavior (Enhancement -- Test 3):**

Read `frontend/src/components/review/document-viewer.tsx`.

In the `updateParagraphStates` callback, where flagged paragraphs get the `data-flag-category` attribute set, ALSO set a `title` attribute for the tooltip. The title should be the flag's note text (truncated to 100 chars):

```typescript
if (isFlagged) {
  el.setAttribute("data-flag-category", flagCategoryMap.get(paraId) ?? "for-discussion");
  // Tooltip: show first flag's note
  const flagNote = flags.find(f => f.para_id === paraId)?.note;
  if (flagNote) {
    el.setAttribute("data-flag-tooltip", flagNote.slice(0, 100));
  }
} else {
  el.removeAttribute("data-flag-category");
  el.removeAttribute("data-flag-tooltip");
}
```

Wait -- the `title` attribute on the paragraph element would show on hover of the ENTIRE paragraph, not just the flag icon. Since the flag icon is a CSS pseudo-element (`::after`), we can't add a title attribute to it directly. Instead, use a CSS `content: attr(data-flag-tooltip)` approach for a tooltip, OR use a simpler approach:

Actually, the simplest robust approach: Replace the CSS `::after` pseudo-element approach with a real DOM element for the flag icon. In `updateParagraphStates`, when a paragraph is flagged, create/update a small DOM element inside the paragraph:

No -- this would be too invasive. The CSS pseudo-element approach is cleaner. For the tooltip, use CSS to show a tooltip on hover via a `::after` on a wrapper, but that's complex.

**Simpler approach**: Use the paragraph's `title` attribute for a basic tooltip. This shows on hover anywhere on the paragraph, which is acceptable since the user hovers the right margin area to see the icon. Set it only on flagged paragraphs:

```typescript
if (isFlagged) {
  el.setAttribute("data-flag-category", flagCategoryMap.get(paraId) ?? "for-discussion");
  const flagNote = flags.find(f => f.para_id === paraId)?.note;
  el.title = flagNote ? flagNote.slice(0, 100) : "Flagged for review";
} else {
  el.removeAttribute("data-flag-category");
  el.title = "";
}
```

For the **click navigation to flags tab**: Add a click handler for the flag icon area. Since the icon is a pseudo-element, detect clicks in the right margin region. In the `attachClickHandlers` callback, for each flagged paragraph, add a click handler that checks if the click was in the right ~30px:

Actually, this is complex with pseudo-elements. A cleaner approach: In `attachClickHandlers`, for elements that are flagged, check the click's clientX relative to the element's right edge. If the click is within 30px of the right edge, switch the sidebar to the Flags tab.

But `attachClickHandlers` runs once when HTML loads, and flagged state changes later. Better approach: In the existing click handler, check if the click target area is near the right edge:

```typescript
el.addEventListener("click", (e) => {
  // Guard: don't fire paragraph selection when selecting text
  const selection = window.getSelection();
  if (selection && !selection.isCollapsed && selection.toString().trim()) {
    return;
  }

  // Check if click was on the flag icon area (right margin)
  const rect = el.getBoundingClientRect();
  const clickX = (e as MouseEvent).clientX;
  if (el.classList.contains("flagged") && clickX > rect.right - 30) {
    // Switch to flags tab
    useAppStore.getState().setActiveTab("flags");
    return;
  }

  const paraId = el.getAttribute("data-para-id");
  if (paraId) selectParagraph(paraId);
});
```

Wait -- the click handler is added once and accesses `el.classList.contains("flagged")` at click time, which is correct since classes are updated dynamically. But `useAppStore` needs to be accessible. It's already imported in the component.

However, `attachClickHandlers` creates closures with `selectParagraph` from the outer scope. We need `setActiveTab` as well. Read the store to check if `setActiveTab` exists.

Actually, looking at the existing code, the sidebar tab is controlled in the sidebar component itself. Check if the store has an `activeTab` or `sidebarTab` state. If not, this navigation needs a different approach.

**Alternative simpler approach for click**: Instead of switching tabs, clicking the flag icon should call `selectParagraph(paraId)` (which it already does via the normal click handler) -- this selects the paragraph, and the FlagsTab already shows flags for the selected paragraph. So clicking the flag icon area effectively "navigates to the flag" by selecting the paragraph, which causes the Flags tab to show that paragraph's flags (if the Flags tab is active).

The user's request was "Click icon should navigate to the flag in the flags tab." The most practical implementation: clicking the flag icon selects the paragraph AND switches the active sidebar tab to "flags".

Check if the store has a sidebar tab state. If it does, use it. If not, this is a minor enhancement that could be deferred. For now, implement what's feasible:

Look for `activeTab` or `sidebarTab` in the store. If found, set it to the flags tab identifier. If not found, just ensure clicking the flag icon selects the paragraph (which already happens via the normal click handler). Add a `// TODO: switch sidebar to Flags tab on flag icon click` comment.

IMPORTANT: The `attachClickHandlers` function only runs once per HTML load (it uses addEventListener). Modifying it to check flagged state at click time works because the `.flagged` class is toggled dynamically by `updateParagraphStates`.

**Also commit the already-applied text selection fixes:**

The document-viewer.tsx file already has the three text selection flagging bug fixes applied (suppressSelectionClear ref, dialogContext separation, selection guard in click handler, preventDefault on Flag button). These need to be committed as part of this plan. No additional code changes needed -- just ensure the file is included in the commit.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- CSS flag icons use `::after` pseudo-element positioned on the RIGHT side
- All 4 category-specific CSS rules updated from `::before` to `::after`
- Flagged paragraphs have title attribute with flag note text
- document-viewer.tsx contains the text selection flagging fixes (suppressSelectionClear, dialogContext, selection guard)
- `npm run build` in frontend/ directory succeeds
  </verify>
  <done>
- Flag icons appear on the RIGHT margin of flagged paragraphs
- Hovering a flagged paragraph shows the flag note as a browser tooltip
- Flag icons have a hover effect (increased opacity/scale)
- Text selection flagging works reliably: select once, Flag button appears, clicking it opens dialog
- All three text selection bugs are fixed (selection guard, mousedown preventDefault, separate dialogContext)
  </done>
</task>

</tasks>

<verification>
1. Click a flag card anywhere -> document scrolls to that paragraph
2. Flag cards show category, section ref, note, timestamp but NOT quoted text
3. Pencil icon on flag card hover -> opens flag dialog pre-populated with existing flag data
4. Flag icons are on the RIGHT side of paragraphs (not left)
5. Hovering a flagged paragraph shows a tooltip with the flag note
6. Text selection in document -> Flag button appears immediately on first select
7. Clicking Flag button -> dialog opens reliably
8. `npx tsc --noEmit` passes
9. `npm run build` passes
</verification>

<success_criteria>
- UAT Test 2 gap closed: flag card click navigates to paragraph
- UAT Test 4 gap closed: text selection flagging works reliably
- UAT Test 1 enhancements: no excerpt on card, edit button on card
- UAT Test 3 enhancements: right-side icons, tooltip, hover effect
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-dialogs-finalization/06-04-SUMMARY.md`
</output>
