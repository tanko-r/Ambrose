---
phase: 06-dialogs-finalization
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - frontend/src/components/dialogs/transmittal-dialog.tsx
  - frontend/src/components/dialogs/new-project-dialog.tsx
  - frontend/src/components/dialogs/delete-project-dialog.tsx
  - frontend/src/components/dashboard/recent-projects.tsx
  - frontend/src/app/review/[sessionId]/page.tsx
  - frontend/src/components/review/bottom-bar.tsx
  - frontend/src/lib/api.ts
  - app/api/routes.py
autonomous: false

must_haves:
  truths:
    - "User can generate a transmittal email showing flagged items with categories and notes"
    - "User can toggle on a summary of key revisions in addition to flags"
    - "Transmittal is editable in-app before copying or sending"
    - "User can copy transmittal to clipboard or open in email client"
    - "New project auto-saves current session before navigating to intake"
    - "New project confirmation dialog has 'Don't show again' checkbox persisted in localStorage"
    - "Recent projects list shows status badges: In Progress, Finalized"
    - "Projects are deletable from history with confirmation"
    - "Reopening a finalized project shows a banner with Edit button to re-enter review mode"
    - "Transmittal button in bottom bar opens TransmittalDialog"
  artifacts:
    - path: "frontend/src/components/dialogs/transmittal-dialog.tsx"
      provides: "Transmittal email preview, editing, copy, and mailto"
      exports: ["TransmittalDialog"]
    - path: "frontend/src/components/dialogs/new-project-dialog.tsx"
      provides: "Enhanced new project dialog with auto-save and skip preference"
      exports: ["NewProjectDialog"]
    - path: "frontend/src/components/dialogs/delete-project-dialog.tsx"
      provides: "Delete project confirmation dialog"
      exports: ["DeleteProjectDialog"]
    - path: "frontend/src/components/dashboard/recent-projects.tsx"
      provides: "Recent projects with status badges and delete action"
      contains: "Finalized"
    - path: "frontend/src/app/review/[sessionId]/page.tsx"
      provides: "Finalized project banner at top of review page"
      contains: "finalized"
    - path: "frontend/src/components/review/bottom-bar.tsx"
      provides: "Transmittal button wired to TransmittalDialog"
      contains: "TransmittalDialog"
    - path: "frontend/src/lib/api.ts"
      provides: "Enhanced getTransmittal with includeRevisions parameter"
      contains: "include_revisions"
    - path: "app/api/routes.py"
      provides: "Enhanced transmittal endpoint with include_revisions toggle, enhanced session DELETE to remove from disk"
      contains: "include_revisions"
  key_links:
    - from: "frontend/src/components/dialogs/transmittal-dialog.tsx"
      to: "/api/transmittal"
      via: "getTransmittal() from api.ts"
      pattern: "getTransmittal"
    - from: "frontend/src/components/dialogs/new-project-dialog.tsx"
      to: "/api/session/save"
      via: "saveSession() from api.ts"
      pattern: "saveSession"
    - from: "frontend/src/components/dialogs/delete-project-dialog.tsx"
      to: "/api/session/DELETE"
      via: "discardSession() from api.ts"
      pattern: "discardSession"
    - from: "frontend/src/components/review/bottom-bar.tsx"
      to: "frontend/src/components/dialogs/transmittal-dialog.tsx"
      via: "TransmittalDialog controlled by local state"
      pattern: "TransmittalDialog"
---

<objective>
Build the transmittal email dialog, enhance the new project workflow (auto-save, skip preference, status badges, delete), add finalized project banner, wire transmittal button in bottom bar, and enhance backend endpoints.

Purpose: These dialogs complete the full review-to-delivery workflow. The transmittal is the client communication artifact. The new project flow ensures smooth session transitions. The finalized banner prevents accidental edits to completed reviews.
Output: Complete dialog suite covering all Phase 6 requirements.
</objective>

<execution_context>
@C:/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dialogs-finalization/06-CONTEXT.md
@.planning/phases/06-dialogs-finalization/06-RESEARCH.md
@.planning/phases/06-dialogs-finalization/06-01-SUMMARY.md
@.planning/phases/06-dialogs-finalization/06-02-SUMMARY.md
@frontend/src/lib/types.ts
@frontend/src/lib/api.ts
@frontend/src/lib/store.ts
@frontend/src/components/dialogs/new-project-dialog.tsx
@frontend/src/components/dashboard/recent-projects.tsx
@frontend/src/components/review/bottom-bar.tsx
@frontend/src/app/review/[sessionId]/page.tsx
@app/api/routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Transmittal dialog + backend enhancement + bottom bar wiring</name>
  <files>
    frontend/src/components/dialogs/transmittal-dialog.tsx
    frontend/src/lib/api.ts
    frontend/src/components/review/bottom-bar.tsx
    app/api/routes.py
  </files>
  <action>
**routes.py transmittal endpoint enhancement:**
- In the `get_transmittal` function (around line 1109), add support for `include_revisions` query parameter:
  ```python
  include_revisions = request.args.get('include_revisions', 'false').lower() == 'true'
  ```
- When `include_revisions` is true, add a "Key Revisions" section before "Items for Your Review":
  - Iterate over `revisions` dict, find entries where `accepted` is True.
  - For each accepted revision, look up the paragraph in `parsed_doc['content']` to get `section_ref` and `section_hierarchy`.
  - Group by top-level section, then output: `"- [Section X.Y]: {rationale first 100 chars}"`
  - Limit to 10 revisions max. Section header: `"## Key Revisions Made"`
- Also add the `category` field to flag items in the transmittal output: change `{i}. [{section}]: {note}` to `{i}. [{section}] ({category_label}): {note}`. Map category slugs to labels: `{'business-decision': 'Business Decision', 'risk-alert': 'Risk Alert', 'for-discussion': 'For Discussion', 'fyi': 'FYI'}`. Fall back to flag_type label if category not present (backwards compatibility with old flags that lack category).
- Add `include_revisions` boolean to the response JSON so the frontend knows the state.

**routes.py session DELETE enhancement:**
- In the `discard_session` function (around line 1252), after removing from the in-memory `sessions` dict, also delete the JSON file from disk:
  ```python
  session_folder = current_app.config['SESSION_FOLDER']
  session_path = session_folder / f'{session_id}.json'
  if session_path.exists():
      session_path.unlink()
  ```
- Return success even if the file didn't exist on disk.

**api.ts enhancement:**
- Update the `getTransmittal` function signature to accept optional params:
  ```typescript
  export async function getTransmittal(
    sessionId: string,
    options?: { includeRevisions?: boolean }
  ): Promise<TransmittalResponse> {
    const params = new URLSearchParams();
    if (options?.includeRevisions) params.set('include_revisions', 'true');
    const qs = params.toString();
    return request(`/api/transmittal/${sessionId}${qs ? `?${qs}` : ''}`);
  }
  ```
- This is backwards compatible -- existing callers pass no options.

**transmittal-dialog.tsx (NEW file):**
- Follow established dialog pattern: `open`/`onOpenChange` controlled props.
- Use shadcn `Dialog` (complex content).
- Props: `open: boolean`, `onOpenChange: (open: boolean) => void`

State:
- `emailContent: string` -- the full email text, editable by user
- `subject: string` -- email subject line
- `loading: boolean` -- fetching transmittal from backend
- `includeRevisions: boolean` -- toggle for revision summary (default false per locked decision: "default content: flagged items only")
- `copied: boolean` -- briefly true after clipboard copy (for visual feedback)
- `flagCount: number` and `revisionCount: number` -- from API response

Fetch transmittal on open (useEffect with AbortController for React strict mode):
- Read `sessionId` from store.
- Call `getTransmittal(sessionId, { includeRevisions })`.
- Set `emailContent`, `subject`, `flagCount`, `revisionCount` from response.
- Re-fetch when `includeRevisions` toggles (add to useEffect deps alongside `open`).
- Clear state when dialog closes (`!open`).

Layout (max-w-2xl):
1. DialogHeader: Title "Generate Transmittal", description "Review and send the client communication."

2. Toggle row: "Include revision summary" -- native HTML checkbox + label (matching intake-form pattern). When toggled, updates `includeRevisions` state which triggers re-fetch.

3. Subject line: Read-only text showing the subject. Small muted "Subject:" label above it.

4. Email textarea: Full-width `<textarea>` (raw HTML, not shadcn Textarea) with:
   - Value bound to `emailContent` state, onChange updates it
   - `rows={16}` for generous editing space
   - `font-mono text-sm` for email-like feel
   - Small muted note above: "Edit as needed before sending."
   - Border and focus styling matching project design tokens (`rounded-md border border-input bg-background px-3 py-2 focus:outline-none focus:ring-2 focus:ring-ring`)

5. Stats line: Muted text below textarea showing flag/revision counts.

6. DialogFooter:
   - "Copy to Clipboard" primary button with Copy icon. On click:
     - `navigator.clipboard.writeText(...)` with try/catch.
     - Fallback: create textarea element, select, execCommand('copy').
     - Set `copied = true`, reset after 2s via setTimeout.
     - Show `toast.success('Copied to clipboard')`.
     - Button text changes to "Copied!" with Check icon when `copied` is true.
   - "Open in Email Client" outline button with Mail icon. On click:
     - Build mailto URL. If > 2000 chars: truncate body, copy full to clipboard, show toast.info.
     - If <= 2000: just `window.location.href = mailtoUrl`.
   - "Close" ghost button.

**bottom-bar.tsx -- add Transmittal button:**
- Import `TransmittalDialog` from `@/components/dialogs/transmittal-dialog`.
- Add local state: `transmittalOpen: boolean` (default false).
- Add a "Generate Transmittal" outline button with Mail icon, positioned to the LEFT of the "Finalize Redline" button.
- Wire `onClick` to set `transmittalOpen = true`.
- Enable the button when there are flags (`flags.length > 0`). Disable when no flags.
- Render `<TransmittalDialog open={transmittalOpen} onOpenChange={setTransmittalOpen} />` alongside the FinalizeDialog.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- TransmittalDialog component exports from transmittal-dialog.tsx
- Backend transmittal endpoint accepts `include_revisions` query parameter
- Backend session DELETE endpoint removes file from disk
- api.ts getTransmittal supports optional includeRevisions parameter
- Bottom bar shows "Generate Transmittal" button next to Finalize
  </verify>
  <done>
- Transmittal dialog fetches and displays email content
- User can toggle revision summary on/off (re-fetches from backend)
- User can edit email content in textarea before sending
- "Copy to clipboard" works with fallback for localhost
- "Open in email client" works with mailto URL length truncation
- Backend includes category labels in flag items
- Backend session DELETE removes JSON file from disk
- Bottom bar has Transmittal button wired to TransmittalDialog
  </done>
</task>

<task type="auto">
  <name>Task 2: New project enhancement + delete dialog + recent projects + finalized banner</name>
  <files>
    frontend/src/components/dialogs/new-project-dialog.tsx
    frontend/src/components/dialogs/delete-project-dialog.tsx
    frontend/src/components/dashboard/recent-projects.tsx
    frontend/src/app/review/[sessionId]/page.tsx
  </files>
  <action>
**new-project-dialog.tsx ENHANCEMENT:**
Replace the current Save/Discard flow with auto-save + confirmation:

Per locked decisions:
- Auto-saves current session before navigating
- Brief confirmation dialog: "Current work will be saved. Start new project?" with Continue/Cancel
- Has a "Don't show again" checkbox (preference persisted in localStorage)

Rewrite the component:
1. On open, check localStorage `'new-project-skip-confirm'`. If `'true'` AND sessionId exists, skip dialog entirely: auto-save and navigate directly to dashboard. Call a `quickSaveAndGo()` function that saves, resets, and navigates.
2. If showing dialog:
   - Use `AlertDialog` (this IS a confirmation action).
   - Title: "Start New Project?"
   - Description: "Current work will be saved automatically." If session has work (check revisions/flags from store directly -- no need to fetch session info), show brief stats: "{N} revisions, {M} flags will be saved."
   - Add a checkbox row at the bottom of the AlertDialogDescription area: native HTML checkbox + label "Don't show this again".
   - Local state: `dontShowAgain: boolean` (default false), `saving: boolean`.
   - Footer: "Cancel" outline button + "Continue" primary button.
   - On "Continue":
     - If `dontShowAgain` checked, write `localStorage.setItem('new-project-skip-confirm', 'true')`
     - Call `saveSession(sessionId)` (auto-save per locked decision)
     - Snapshot intake settings before reset: `const prevRep = store.representation; const prevApp = store.approach; const prevAgg = store.aggressiveness;`
     - Call `resetSession()`
     - Restore carried-over settings: `store.setSession({ representation: prevRep, approach: prevApp, aggressiveness: prevAgg })`
     - Navigate to `/` (dashboard)
     - Show `toast.success('Session saved')`
   - Remove the old "Save & Close" / "Discard" two-button pattern entirely.
   - Remove the `loaded`, `info`, `discarding` state variables. The new dialog is simpler.

**delete-project-dialog.tsx (NEW file):**
- `AlertDialog` (destructive confirmation).
- Props: `open: boolean`, `onOpenChange: (open: boolean) => void`, `sessionId: string`, `filename: string`, `onDeleted?: () => void`
- Title: "Delete Project?"
- Description: `Permanently delete "{filename}"? This cannot be undone.`
- Footer: Cancel + "Delete" destructive button.
- On delete: call `discardSession(sessionId)` from api.ts, show `toast.success('Project deleted')`, call `onDeleted?.()` callback, close dialog.
- Show Loader2 while deleting. Local state: `deleting: boolean`.

**recent-projects.tsx ENHANCEMENT:**
Read current file first to understand structure, then:
1. **Status badges:** For each project in the list, show a Badge next to the filename:
   - `status === 'finalized'`: Badge with "Finalized" in green (`variant="outline" className="border-green-300 text-green-700 text-[10px]"`)
   - `status === 'analyzed'`: Badge with "In Progress" in blue (`variant="outline" className="border-blue-300 text-blue-700 text-[10px]"`)
   - `status === 'initialized'`: Badge with "Not Started" in gray
   - Other: Badge with capitalized status text
2. **Delete button:** Add a small ghost Trash2 icon button at the end of each project row. On click, open DeleteProjectDialog for that project. After deletion, refresh the saved sessions list (call `listSavedSessions()` from api.ts and update store via `setSavedSessions(response.sessions)`).
3. Import and render DeleteProjectDialog (controlled by local state: `deleteTarget: { sessionId: string, filename: string } | null`). Open state derived from `deleteTarget !== null`.
4. Keep existing click-to-load behavior for project rows.

**review page (page.tsx) -- finalized project banner:**
Per locked decision: "Reopening a finalized project shows a read-only summary view first, with an 'Edit' button to re-enter full review mode."

Per Claude's Discretion recommendation: show a banner at the top of the review page (not a separate view).

Implementation:
- Read `status` from store.
- When `status === 'finalized'`, render a banner bar between the Header and the main content area:
  ```tsx
  {status === 'finalized' && (
    <div className="flex items-center justify-between border-b bg-green-50 px-6 py-2">
      <div className="flex items-center gap-2 text-sm text-green-800">
        <CheckCircle2 className="h-4 w-4" />
        <span>This project was finalized. Editing will clear the finalized status.</span>
      </div>
      <Button
        size="sm"
        variant="outline"
        className="h-7 text-xs"
        onClick={() => setSession({ status: 'analyzed' })}
      >
        Edit
      </Button>
    </div>
  )}
  ```
- When user clicks "Edit", set status back to 'analyzed' which removes the banner and enables full editing.
- Import `CheckCircle2` from lucide-react.
- IMPORTANT: Do NOT make the page read-only. The banner is informational. Clicking Edit clears the finalized status. The user can still interact with the page even with the banner visible -- the banner just warns them.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- NewProjectDialog auto-saves and navigates without Save/Discard choice
- "Don't show again" checkbox persists preference to localStorage
- Subsequent new-project triggers skip dialog when preference is set
- DeleteProjectDialog shows confirmation and deletes on confirm
- Recent projects show status badges (In Progress, Finalized)
- Recent projects have delete buttons that open DeleteProjectDialog
- Finalized projects show green banner with Edit button in review page
  </verify>
  <done>
- New project flow: auto-save, brief confirmation, "Don't show again" option
- Intake settings (representation, approach, aggressiveness) carry over to new project
- Delete project dialog with destructive confirmation
- Recent projects list shows status badges
- Recent projects have delete action with confirmation
- Finalized project banner with Edit button to clear status
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-end Phase 6 verification</name>
  <what-built>
Complete dialog suite: Flag system (4 categories, sidebar + text selection + FlagsTab entry points, margin icons), Finalize dialog (stats, revision list, author name, Word export), Transmittal dialog (editable email, copy, mailto), New Project enhancement (auto-save, skip preference, status badges, delete), Finalized project banner.
  </what-built>
  <how-to-verify>
Start both servers: Flask on :5000, Next.js on :3000.

**Flag system:**
1. Load a session with analysis. Select a paragraph with risks.
2. In sidebar footer, click the Flag icon button. Verify FlagDialog opens.
3. Select "Risk Alert" category, type a note, click "Add Flag". Verify flag appears in FlagsTab.
4. Verify flagged paragraph shows an orange flag icon in the left margin.
5. Select text in the document. Verify a floating "Flag" button appears near the selection.
6. Click the floating Flag button. Verify FlagDialog opens with the correct paragraph.
7. In FlagsTab, click the X button on a flag to remove it. Verify margin icon disappears.

**Finalize and Export:**
8. Accept at least one revision on a paragraph.
9. Click "Finalize Redline" in the bottom bar. Verify FinalizeDialog opens.
10. Check stats: accepted revision count, flag count, unreviewed warning.
11. Expand a revision in the accordion -- verify diff is shown.
12. Enter author name, click "Export Documents". Wait for export.
13. Click "Download Redline" -- verify .docx file downloads.
14. Click "Download Clean" -- verify .docx file downloads.
15. Close dialog. Verify session is still active (can still navigate).
16. Verify a green "finalized" banner appears at top of review page.

**Transmittal:**
17. Click "Generate Transmittal" in the bottom bar. Verify dialog opens.
18. Verify email shows flagged items with categories.
19. Toggle "Include revision summary" -- verify content updates.
20. Edit the email text in the textarea.
21. Click "Copy to Clipboard" -- verify toast and paste works.
22. Click "Open in Email Client" -- verify email client opens (or mailto URL).

**New Project:**
23. Click New Project from header menu. Verify confirmation dialog appears.
24. Check "Don't show again", click Continue. Verify redirected to dashboard.
25. Verify the saved project appears in recent projects with "Finalized" badge.
26. Click New Project again -- verify dialog is skipped (auto-saves and navigates directly).
27. In recent projects, click delete on a project. Verify confirmation and deletion.

**Finalized Project Reopen:**
28. Click on a finalized project in recent projects. Verify it loads.
29. Verify green "finalized" banner shows at top.
30. Click "Edit" on the banner. Verify banner disappears and session is fully editable.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues for each area (flags, finalize, transmittal, new project, finalized reopen)</resume-signal>
</task>

</tasks>

<verification>
1. Flag system: create from sidebar, text selection, and FlagsTab; verify margin icons; remove flag
2. Finalize: open dialog, verify stats, export, download both file types
3. Transmittal: generate, toggle revisions, edit, copy, mailto with length handling
4. New project: auto-save, skip preference, status badges, delete projects
5. Finalized banner: shows on finalized project, Edit clears status
6. `npx tsc --noEmit` passes
7. No console errors during all workflows
8. Backend: transmittal includes categories and revision summary, session DELETE removes file
</verification>

<success_criteria>
- All 12 Phase 6 requirements met: FIN-01..04, TRANS-01..04, NEW-01..04
- Flag system works from 3 entry points (sidebar button, text selection, flags tab)
- Finalize produces both track changes and clean Word documents
- Transmittal is editable with copy and mailto delivery
- New project auto-saves and has skip preference
- Recent projects show status badges and support deletion
- Finalized project shows banner; Edit button clears finalized status
</success_criteria>

<output>
After completion, create `.planning/phases/06-dialogs-finalization/06-03-SUMMARY.md`
</output>
