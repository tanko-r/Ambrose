---
phase: 06-dialogs-finalization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/hooks/use-finalize.ts
  - frontend/src/components/dialogs/finalize-dialog.tsx
  - frontend/src/components/review/bottom-bar.tsx
autonomous: true

must_haves:
  truths:
    - "User can click Finalize Redline in bottom bar to open the finalize dialog"
    - "Finalize dialog shows stats: accepted revision count, flag count, unreviewed risk warning"
    - "Finalize dialog shows expandable accordion list of accepted revisions grouped by section"
    - "User can configure track changes author name in the finalize dialog"
    - "User can download track changes Word document from finalize dialog"
    - "User can download clean Word document from finalize dialog"
    - "Both files download directly without ZIP bundle"
    - "Session stays open after export for continued review"
  artifacts:
    - path: "frontend/src/hooks/use-finalize.ts"
      provides: "Finalize preview fetch, export trigger, and blob download"
      exports: ["useFinalize"]
    - path: "frontend/src/components/dialogs/finalize-dialog.tsx"
      provides: "Finalize dialog with stats, revision list, author name, download buttons"
      exports: ["FinalizeDialog"]
    - path: "frontend/src/components/review/bottom-bar.tsx"
      provides: "Wired Finalize Redline button opening FinalizeDialog"
      contains: "FinalizeDialog"
  key_links:
    - from: "frontend/src/hooks/use-finalize.ts"
      to: "/api/finalize/preview"
      via: "finalizePreview() from api.ts"
      pattern: "finalizePreview"
    - from: "frontend/src/hooks/use-finalize.ts"
      to: "/api/finalize"
      via: "finalize() from api.ts"
      pattern: "finalize\\("
    - from: "frontend/src/hooks/use-finalize.ts"
      to: "/api/download"
      via: "downloadFile() from api.ts"
      pattern: "downloadFile"
    - from: "frontend/src/components/review/bottom-bar.tsx"
      to: "frontend/src/components/dialogs/finalize-dialog.tsx"
      via: "FinalizeDialog controlled by local state"
      pattern: "FinalizeDialog"
---

<objective>
Build the finalize and export workflow: useFinalize hook for preview/export/download, FinalizeDialog with stats and revision list, and wire the Finalize button in bottom bar.

Purpose: Export is the culmination of the review workflow -- the user needs to produce Word documents with track changes for delivery to opposing counsel.
Output: Working finalize dialog with export capability.
</objective>

<execution_context>
@C:/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dialogs-finalization/06-CONTEXT.md
@.planning/phases/06-dialogs-finalization/06-RESEARCH.md
@frontend/src/lib/types.ts
@frontend/src/lib/api.ts
@frontend/src/lib/store.ts
@frontend/src/components/review/bottom-bar.tsx
@frontend/src/components/dialogs/new-project-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: useFinalize hook + FinalizeDialog</name>
  <files>
    frontend/src/hooks/use-finalize.ts
    frontend/src/components/dialogs/finalize-dialog.tsx
  </files>
  <action>
**use-finalize.ts (NEW file):**
- Export `useFinalize()` hook.
- Reads `sessionId` from `useAppStore`.
- `fetchPreview()`: calls `finalizePreview({ session_id: sessionId })` from api.ts, returns `FinalizePreviewResponse`. Handles errors with toast.error.
- `doExport(authorName: string)`: calls `finalize({ session_id: sessionId, author_name: authorName })` from api.ts. On success, calls `useAppStore.getState().setSession({ status: 'finalized' })`. Returns the `FinalizeResponse`. Handles errors with toast.error.
- `download(type: 'track_changes' | 'clean', filename?: string)`: calls `downloadFile(sessionId, type)` from api.ts to get a Blob. Then triggers browser download: `URL.createObjectURL(blob)` -> create anchor element -> set `href` and `download` attributes -> click -> cleanup. Default filename: `${targetFilename}_${type}.docx` (read targetFilename from store). Shows `toast.success('Download started')`. Handles errors with toast.error.
- Return `{ fetchPreview, doExport, download }`.

**finalize-dialog.tsx (NEW file):**
- Follow established dialog pattern: `open`/`onOpenChange` controlled props.
- Use shadcn `Dialog` (complex content, not a confirmation).
- Props: `open: boolean`, `onOpenChange: (open: boolean) => void`

**State:**
- `preview: FinalizePreviewResponse | null` -- fetched on dialog open
- `loading: boolean` -- for preview fetch
- `authorName: string` -- defaults to empty string (user types their name)
- `exporting: boolean` -- during finalize API call
- `exported: boolean` -- after successful finalize, shows download buttons
- `exportResult: FinalizeResponse | null` -- stored after successful export

**Fetch preview on open (useEffect with AbortController for React strict mode):**
```
useEffect(() => {
  if (!open) { setPreview(null); setExported(false); setExportResult(null); return; }
  const controller = new AbortController();
  setLoading(true);
  fetchPreview().then(setPreview).catch(() => {}).finally(() => {
    if (!controller.signal.aborted) setLoading(false);
  });
  return () => controller.abort();
}, [open]);
```

**Compute stats from store (not just preview -- preview only has accepted revisions):**
- `acceptedCount`: count of revisions where `accepted === true` from store.revisions
- `flagCount`: store.flags.length
- `totalRiskParaIds`: Set of unique para_ids from store.risks
- `reviewedParaIds`: Set of para_ids that have a revision (accepted or not) in store.revisions
- `unreviewedCount`: totalRiskParaIds minus reviewedParaIds (paragraphs with risks but no revision generated)

**Layout (max-w-3xl):**
1. **DialogHeader:** Title "Finalize & Export", description "Review your revisions and export Word documents."

2. **Stats row** (3 summary cards in a flex row):
   - Card 1: Accepted revisions count (green check icon + number + "revisions accepted")
   - Card 2: Flags count (flag icon + number + "items flagged")
   - Card 3: Unreviewed warning (if unreviewedCount > 0): amber AlertTriangle icon + number + "clauses with risks not yet reviewed". If 0, show green check + "All risk clauses reviewed".

3. **Revision list** (only when preview loaded, scrollable max-h-64):
   - Use shadcn Accordion (already installed). Each AccordionItem:
     - Trigger: section_ref badge + first 80 chars of rationale text
     - Content: diff_html rendered via dangerouslySetInnerHTML in a `revision-diff` styled div (reuse existing CSS class). Show original excerpt and revised excerpt below diff.
   - If no revisions: show muted text "No accepted revisions to export."

4. **Author name input:**
   - Label: "Track Changes Author"
   - shadcn Input (not Textarea) with placeholder "e.g., David Smith"
   - Muted helper text: "This name appears as the revision author in Word."

5. **DialogFooter:**
   - If NOT yet exported:
     - Cancel button (outline)
     - "Export Documents" primary button. Disabled while exporting or if acceptedCount === 0. Shows Loader2 spinner while exporting. On click: calls `doExport(authorName)`, on success sets `exported = true` and stores result.
   - If exported:
     - "Download Redline (.docx)" primary button with FileDown icon. On click: `download('track_changes')`.
     - "Download Clean (.docx)" outline button with FileDown icon. On click: `download('clean')`.
     - Small muted text: "Session remains open. You can continue reviewing and re-export."
     - "Close" ghost button to dismiss dialog.

**Per locked decision:** No cherry-picking. All accepted revisions are exported. Session stays open after export.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `useFinalize` hook exports from use-finalize.ts
- `FinalizeDialog` component exports from finalize-dialog.tsx
- Dialog renders with stats cards, accordion revision list, author name input, and export/download buttons
  </verify>
  <done>
- useFinalize provides fetchPreview, doExport, download methods
- FinalizeDialog shows stats, expandable revision list, configurable author name
- Export triggers finalize API and enables download buttons
- Download triggers blob download for both track_changes and clean document types
  </done>
</task>

<task type="auto">
  <name>Task 2: Bottom bar Finalize button wiring</name>
  <files>
    frontend/src/components/review/bottom-bar.tsx
  </files>
  <action>
**bottom-bar.tsx wiring:**
- Import `FinalizeDialog` from `@/components/dialogs/finalize-dialog`.
- Add local state: `finalizeOpen: boolean` (default false).
- Find the existing disabled "Finalize Redline" button (around line 139-142). Remove the `disabled` prop. Wire `onClick` to set `finalizeOpen = true`.
- Add condition: only enable the button when there is at least 1 accepted revision. Read `revisions` from store, compute `hasAcceptedRevisions = Object.values(revisions).some(r => r.accepted)`. Set `disabled={!hasAcceptedRevisions}`.
- Render `<FinalizeDialog open={finalizeOpen} onOpenChange={setFinalizeOpen} />` at the end of the component's return JSX (outside the bar layout, just before the closing fragment/div).

NOTE: The Transmittal button wiring and sidebar flag button are handled in Plan 06-03, which depends on this plan. This task ONLY wires the Finalize button.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Bottom bar "Finalize Redline" button is enabled when there are accepted revisions
- Clicking "Finalize Redline" opens FinalizeDialog
  </verify>
  <done>
- Finalize button in bottom bar opens FinalizeDialog
- Finalize button is disabled when no accepted revisions exist
  </done>
</task>

</tasks>

<verification>
1. Accept a revision on a paragraph, then click "Finalize Redline" in bottom bar
2. Verify dialog shows correct stats (1 accepted revision, flag count, unreviewed warning)
3. Verify accordion shows the accepted revision with diff
4. Enter author name, click "Export Documents"
5. Verify "Download Redline" and "Download Clean" buttons appear after export
6. Click each download button -- verify .docx files download
7. Verify session stays open (can still navigate and review)
8. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Finalize dialog opens from bottom bar with stats, revision list, author name input
- Export produces both track changes and clean Word documents for download
- Session remains open after export (per locked decision)
- No type errors, no console errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-dialogs-finalization/06-02-SUMMARY.md`
</output>
