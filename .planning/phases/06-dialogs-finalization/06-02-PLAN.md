---
phase: 06-dialogs-finalization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/hooks/use-finalize.ts
  - frontend/src/components/dialogs/finalize-dialog.tsx
  - frontend/src/components/review/bottom-bar.tsx
  - frontend/src/components/review/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can click Finalize Redline in bottom bar to open the finalize dialog"
    - "Finalize dialog shows stats: accepted revision count, flag count, unreviewed risk warning"
    - "Finalize dialog shows expandable accordion list of accepted revisions grouped by section"
    - "User can configure track changes author name in the finalize dialog"
    - "User can download track changes Word document from finalize dialog"
    - "User can download clean Word document from finalize dialog"
    - "Both files download directly without ZIP bundle"
    - "Session stays open after export for continued review"
    - "Sidebar risk cards have a Flag button to quickly flag the associated paragraph"
  artifacts:
    - path: "frontend/src/hooks/use-finalize.ts"
      provides: "Finalize preview fetch, export trigger, and blob download"
      exports: ["useFinalize"]
    - path: "frontend/src/components/dialogs/finalize-dialog.tsx"
      provides: "Finalize dialog with stats, revision list, author name, download buttons"
      exports: ["FinalizeDialog"]
    - path: "frontend/src/components/review/bottom-bar.tsx"
      provides: "Wired Finalize Redline button opening FinalizeDialog"
      contains: "FinalizeDialog"
    - path: "frontend/src/components/review/sidebar.tsx"
      provides: "Flag button on risk cards in sidebar footer area"
      contains: "FlagDialog"
  key_links:
    - from: "frontend/src/hooks/use-finalize.ts"
      to: "/api/finalize/preview"
      via: "finalizePreview() from api.ts"
      pattern: "finalizePreview"
    - from: "frontend/src/hooks/use-finalize.ts"
      to: "/api/finalize"
      via: "finalize() from api.ts"
      pattern: "finalize\\("
    - from: "frontend/src/hooks/use-finalize.ts"
      to: "/api/download"
      via: "downloadFile() from api.ts"
      pattern: "downloadFile"
    - from: "frontend/src/components/review/bottom-bar.tsx"
      to: "frontend/src/components/dialogs/finalize-dialog.tsx"
      via: "FinalizeDialog controlled by local state"
      pattern: "FinalizeDialog"
---

<objective>
Build the finalize and export workflow: useFinalize hook for preview/export/download, FinalizeDialog with stats and revision list, wire the Finalize button in bottom bar, and add a quick-flag button to sidebar risk cards.

Purpose: Export is the culmination of the review workflow -- the user needs to produce Word documents with track changes for delivery to opposing counsel. The sidebar flag button enables quick flagging during risk review without switching tabs.
Output: Working finalize dialog with export, plus sidebar quick-flag entry point.
</objective>

<execution_context>
@C:/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dialogs-finalization/06-CONTEXT.md
@.planning/phases/06-dialogs-finalization/06-RESEARCH.md
@frontend/src/lib/types.ts
@frontend/src/lib/api.ts
@frontend/src/lib/store.ts
@frontend/src/components/review/bottom-bar.tsx
@frontend/src/components/review/sidebar.tsx
@frontend/src/components/dialogs/new-project-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: useFinalize hook + FinalizeDialog</name>
  <files>
    frontend/src/hooks/use-finalize.ts
    frontend/src/components/dialogs/finalize-dialog.tsx
  </files>
  <action>
**use-finalize.ts (NEW file):**
- Export `useFinalize()` hook.
- Reads `sessionId` from `useAppStore`.
- `fetchPreview()`: calls `finalizePreview({ session_id: sessionId })` from api.ts, returns `FinalizePreviewResponse`. Handles errors with toast.error.
- `doExport(authorName: string)`: calls `finalize({ session_id: sessionId, author_name: authorName })` from api.ts. On success, calls `useAppStore.getState().setSession({ status: 'finalized' })`. Returns the `FinalizeResponse`. Handles errors with toast.error.
- `download(type: 'track_changes' | 'clean', filename?: string)`: calls `downloadFile(sessionId, type)` from api.ts to get a Blob. Then triggers browser download: `URL.createObjectURL(blob)` -> create anchor element -> set `href` and `download` attributes -> click -> cleanup. Default filename: `${targetFilename}_${type}.docx` (read targetFilename from store). Shows `toast.success('Download started')`. Handles errors with toast.error.
- Return `{ fetchPreview, doExport, download }`.

**finalize-dialog.tsx (NEW file):**
- Follow established dialog pattern: `open`/`onOpenChange` controlled props.
- Use shadcn `Dialog` (complex content, not a confirmation).
- Props: `open: boolean`, `onOpenChange: (open: boolean) => void`

**State:**
- `preview: FinalizePreviewResponse | null` — fetched on dialog open
- `loading: boolean` — for preview fetch
- `authorName: string` — defaults to empty string (user types their name)
- `exporting: boolean` — during finalize API call
- `exported: boolean` — after successful finalize, shows download buttons
- `exportResult: FinalizeResponse | null` — stored after successful export

**Fetch preview on open (useEffect with AbortController for React strict mode):**
```
useEffect(() => {
  if (!open) { setPreview(null); setExported(false); setExportResult(null); return; }
  const controller = new AbortController();
  setLoading(true);
  fetchPreview().then(setPreview).catch(() => {}).finally(() => {
    if (!controller.signal.aborted) setLoading(false);
  });
  return () => controller.abort();
}, [open]);
```

**Compute stats from store (not just preview — preview only has accepted revisions):**
- `acceptedCount`: count of revisions where `accepted === true` from store.revisions
- `flagCount`: store.flags.length
- `totalRiskParaIds`: Set of unique para_ids from store.risks
- `reviewedParaIds`: Set of para_ids that have a revision (accepted or not) in store.revisions
- `unreviewedCount`: totalRiskParaIds minus reviewedParaIds (paragraphs with risks but no revision generated)

**Layout (max-w-3xl):**
1. **DialogHeader:** Title "Finalize & Export", description "Review your revisions and export Word documents."

2. **Stats row** (3 summary cards in a flex row):
   - Card 1: Accepted revisions count (green check icon + number + "revisions accepted")
   - Card 2: Flags count (flag icon + number + "items flagged")
   - Card 3: Unreviewed warning (if unreviewedCount > 0): amber AlertTriangle icon + number + "clauses with risks not yet reviewed". If 0, show green check + "All risk clauses reviewed".

3. **Revision list** (only when preview loaded, scrollable max-h-64):
   - Use shadcn Accordion (already installed). Each AccordionItem:
     - Trigger: section_ref badge + first 80 chars of rationale text
     - Content: diff_html rendered via dangerouslySetInnerHTML in a `revision-diff` styled div (reuse existing CSS class). Show original excerpt and revised excerpt below diff.
   - If no revisions: show muted text "No accepted revisions to export."

4. **Author name input:**
   - Label: "Track Changes Author"
   - shadcn Input (not Textarea) with placeholder "e.g., David Smith"
   - Muted helper text: "This name appears as the revision author in Word."

5. **DialogFooter:**
   - If NOT yet exported:
     - Cancel button (outline)
     - "Export Documents" primary button. Disabled while exporting or if acceptedCount === 0. Shows Loader2 spinner while exporting. On click: calls `doExport(authorName)`, on success sets `exported = true` and stores result.
   - If exported:
     - "Download Redline (.docx)" primary button with FileDown icon. On click: `download('track_changes')`.
     - "Download Clean (.docx)" outline button with FileDown icon. On click: `download('clean')`.
     - Small muted text: "Session remains open. You can continue reviewing and re-export."
     - "Close" ghost button to dismiss dialog.

**Per locked decision:** No cherry-picking. All accepted revisions are exported. Session stays open after export.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `useFinalize` hook exports from use-finalize.ts
- `FinalizeDialog` component exports from finalize-dialog.tsx
- Dialog renders with stats cards, accordion revision list, author name input, and export/download buttons
  </verify>
  <done>
- useFinalize provides fetchPreview, doExport, download methods
- FinalizeDialog shows stats, expandable revision list, configurable author name
- Export triggers finalize API and enables download buttons
- Download triggers blob download for both track_changes and clean document types
  </done>
</task>

<task type="auto">
  <name>Task 2: Bottom bar wiring + sidebar flag button</name>
  <files>
    frontend/src/components/review/bottom-bar.tsx
    frontend/src/components/review/sidebar.tsx
  </files>
  <action>
**bottom-bar.tsx wiring:**
- Import `FinalizeDialog` from `@/components/dialogs/finalize-dialog`.
- Add local state: `finalizeOpen: boolean` (default false).
- Find the existing disabled "Finalize Redline" button (around line 139-142). Remove the `disabled` prop. Wire `onClick` to set `finalizeOpen = true`.
- Add condition: only enable the button when there is at least 1 accepted revision. Read `revisions` from store, compute `hasAcceptedRevisions = Object.values(revisions).some(r => r.accepted)`. Set `disabled={!hasAcceptedRevisions}`.
- Render `<FinalizeDialog open={finalizeOpen} onOpenChange={setFinalizeOpen} />` at the end of the component's return JSX (outside the bar layout, just before the closing fragment/div).

**sidebar.tsx flag button on risk cards:**
- Import `FlagDialog` from `@/components/dialogs/flag-dialog`.
- Import `Flag` icon from lucide-react (already imported).
- Import `FlagCategory` from `@/lib/types` (only if needed for the default category prop).
- Add local state: `flagDialogOpen: boolean`, `flagDialogParaId: string | null`.
- In the sidebar footer area (where the "Generate Revision" button is), add a small "Flag" button:
  - Position it in the button row, before the snippet badge and revision buttons.
  - Appearance: `variant="ghost" size="sm" className="h-7 w-7 p-0"` with a `Flag` icon (h-3.5 w-3.5).
  - Tooltip or title: "Flag this clause"
  - On click: set `flagDialogParaId = selectedParaId`, set `flagDialogOpen = true`.
  - Only show when `selectedParaId` is not null and `!generating`.
- Render `<FlagDialog open={flagDialogOpen} onOpenChange={setFlagDialogOpen} paraId={flagDialogParaId || ''} />` at the end of the sidebar content JSX.
- When FlagDialog closes, clear `flagDialogParaId`.

NOTE: The FlagDialog import requires Plan 01's flag-dialog.tsx to exist. Since Plan 01 and Plan 02 run in Wave 1 (parallel), handle this gracefully: if types are not yet available at compile time, both plans will be committed and the build will pass after both complete. The executor should run Plan 01 first within Wave 1 since Plan 02 imports from it. If running truly in parallel and there's a brief compile error, it resolves once both plans complete.

IMPORTANT: Do NOT modify the sidebar content area or tab structure. Only add the flag button in the footer section and the FlagDialog render.
  </action>
  <verify>
- `npx tsc --noEmit` passes (after Plan 01 completes)
- Bottom bar "Finalize Redline" button is enabled when there are accepted revisions
- Clicking "Finalize Redline" opens FinalizeDialog
- Sidebar shows Flag button in footer when a paragraph is selected
- Clicking Flag button opens FlagDialog
  </verify>
  <done>
- Finalize button in bottom bar opens FinalizeDialog
- Finalize button is disabled when no accepted revisions exist
- Sidebar has quick-flag button in footer area
- Flag button opens FlagDialog for currently selected paragraph
  </done>
</task>

</tasks>

<verification>
1. Accept a revision on a paragraph, then click "Finalize Redline" in bottom bar
2. Verify dialog shows correct stats (1 accepted revision, flag count, unreviewed warning)
3. Verify accordion shows the accepted revision with diff
4. Enter author name, click "Export Documents"
5. Verify "Download Redline" and "Download Clean" buttons appear after export
6. Click each download button -- verify .docx files download
7. Verify session stays open (can still navigate and review)
8. Test sidebar Flag button: select paragraph, click Flag icon, verify FlagDialog opens
9. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Finalize dialog opens from bottom bar with stats, revision list, author name input
- Export produces both track changes and clean Word documents for download
- Session remains open after export (per locked decision)
- Sidebar provides quick-flag entry point via Flag icon button
- No type errors, no console errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-dialogs-finalization/06-02-SUMMARY.md`
</output>
