---
phase: 06-dialogs-finalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/types.ts
  - app/api/routes.py
  - frontend/src/hooks/use-flags.ts
  - frontend/src/components/dialogs/flag-dialog.tsx
  - frontend/src/components/review/flags-tab.tsx
  - frontend/src/components/review/document-viewer.tsx
  - frontend/src/app/globals.css
autonomous: true

must_haves:
  truths:
    - "User can flag a paragraph with one of four categories (Business Decision, Risk Alert, For Discussion, FYI) and a free-text note"
    - "User can create a flag from text selection in the document viewer"
    - "Flagged paragraphs show a small color-coded flag icon in the document left margin"
    - "Flags tab in sidebar lists all flagged items across the document with category badges and remove action"
    - "User can remove a flag from the flags tab"
  artifacts:
    - path: "frontend/src/lib/types.ts"
      provides: "FlagCategory type, updated Flag and FlagRequest interfaces"
      contains: "FlagCategory"
    - path: "app/api/routes.py"
      provides: "Backend flag endpoint accepting category field"
      contains: "category"
    - path: "frontend/src/hooks/use-flags.ts"
      provides: "Flag CRUD hook with create/remove operations"
      exports: ["useFlags"]
    - path: "frontend/src/components/dialogs/flag-dialog.tsx"
      provides: "Flag creation dialog with category picker and note input"
      exports: ["FlagDialog"]
    - path: "frontend/src/components/review/flags-tab.tsx"
      provides: "Full flags listing with create button, category badges, remove action"
      exports: ["FlagsTab"]
    - path: "frontend/src/components/review/document-viewer.tsx"
      provides: "Text selection flagging and flag margin icon application"
    - path: "frontend/src/app/globals.css"
      provides: "Flag margin icon CSS with category color-coding"
      contains: "flag-icon"
  key_links:
    - from: "frontend/src/hooks/use-flags.ts"
      to: "/api/flag"
      via: "flagItem() from api.ts"
      pattern: "flagItem"
    - from: "frontend/src/components/dialogs/flag-dialog.tsx"
      to: "frontend/src/hooks/use-flags.ts"
      via: "useFlags hook create method"
      pattern: "useFlags"
    - from: "frontend/src/components/review/document-viewer.tsx"
      to: "frontend/src/components/dialogs/flag-dialog.tsx"
      via: "text selection opens FlagDialog"
      pattern: "FlagDialog"
---

<objective>
Build the complete flag system: data model enhancement, flag creation dialog with four categories, full flags-tab with listing and management, document margin flag icons, and text selection flagging in the document viewer.

Purpose: Flags are the primary mechanism for marking clauses for client communication. They feed directly into the transmittal email (Plan 03) and are visible throughout the review workflow.
Output: Working flag system with category-based flagging from multiple entry points.
</objective>

<execution_context>
@C:/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dialogs-finalization/06-CONTEXT.md
@.planning/phases/06-dialogs-finalization/06-RESEARCH.md
@frontend/src/lib/types.ts
@frontend/src/lib/api.ts
@frontend/src/lib/store.ts
@frontend/src/components/review/flags-tab.tsx
@frontend/src/components/review/document-viewer.tsx
@frontend/src/components/dialogs/new-project-dialog.tsx
@frontend/src/app/globals.css
@app/api/routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Flag data model + backend + hook + dialog</name>
  <files>
    frontend/src/lib/types.ts
    app/api/routes.py
    frontend/src/hooks/use-flags.ts
    frontend/src/components/dialogs/flag-dialog.tsx
  </files>
  <action>
**types.ts enhancements:**
- Add `FlagCategory` type: `'business-decision' | 'risk-alert' | 'for-discussion' | 'fyi'`
- Add `category: FlagCategory` field to the `Flag` interface (after `flag_type`)
- Add `category: FlagCategory` field to the `FlagRequest` interface
- Add `FLAG_CATEGORY_LABELS` and `FLAG_CATEGORY_COLORS` as exported const objects:
  - Labels: `{ 'business-decision': 'Business Decision', 'risk-alert': 'Risk Alert', 'for-discussion': 'For Discussion', 'fyi': 'FYI' }`
  - Colors: `{ 'business-decision': 'blue', 'risk-alert': 'orange', 'for-discussion': 'purple', 'fyi': 'gray' }`

**routes.py backend enhancement:**
- In the `/flag` POST handler (around line 847), add `category = data.get('category', 'for-discussion')` to read the category from the request
- Add `'category': category` to the `flag_entry` dict (alongside `flag_type`)
- All flags created from the UI will use `flag_type: 'client'` since all four user-facing categories are for client review per the locked decision

**use-flags.ts hook (NEW file):**
- Export `useFlags()` hook
- `create(paraId: string, category: FlagCategory, note: string)`: calls `flagItem()` from api.ts with `session_id`, `para_id`, `note`, `flag_type: 'client'`, `category`. On success, calls `store.addFlag(response.flag)`. Shows `toast.success('Flagged for review')`.
- `remove(paraId: string)`: calls `unflagItem()` from api.ts, on success calls `store.removeFlag(paraId)`. Shows `toast.success('Flag removed')`.
- `getFlagForPara(paraId: string)`: returns flag from store.flags matching paraId, or null.
- Read `sessionId` from `useAppStore`.
- Handle errors with `toast.error()`.

**flag-dialog.tsx (NEW file):**
- Follow the established dialog pattern from `new-project-dialog.tsx`: controlled via `open`/`onOpenChange` props.
- Use shadcn `Dialog` (not AlertDialog — this is a form, not a confirmation).
- Props: `open: boolean`, `onOpenChange: (open: boolean) => void`, `paraId: string`, `sectionRef?: string`, `defaultCategory?: FlagCategory`
- State: `category` (default to `defaultCategory` or `'for-discussion'`), `note` (default empty string), `saving` boolean
- Layout:
  - DialogHeader: title "Flag for Review", description showing section ref if available
  - Category selector: 4 radio-style buttons in a 2x2 grid, each showing the category label with its color dot. Selected state uses primary border + faint bg. Use native buttons with conditional classes (NOT shadcn RadioGroup — keep it lightweight).
  - Note textarea: shadcn `Textarea` with placeholder "Add a note for the client (optional)...", 3 rows
  - DialogFooter: Cancel button + "Add Flag" primary button (disabled while saving, shows Loader2 spinner)
- On submit: call `useFlags().create(paraId, category, note)`. On success, close dialog via `onOpenChange(false)` and reset state.
- Reset `category` and `note` when dialog opens (useEffect on `open`).
  </action>
  <verify>
- `npx tsc --noEmit` passes with no type errors
- `FlagCategory` type is exported from types.ts
- `useFlags` hook exports from use-flags.ts
- `FlagDialog` component exports from flag-dialog.tsx
- Backend route in routes.py includes `category` in flag_entry
  </verify>
  <done>
- FlagCategory type exists with 4 values
- Flag and FlagRequest interfaces include category field
- Backend flag endpoint stores category
- useFlags hook provides create/remove/getFlagForPara
- FlagDialog renders with 4-category selector and note textarea
  </done>
</task>

<task type="auto">
  <name>Task 2: Flags tab rewrite + document margin icons + text selection flagging</name>
  <files>
    frontend/src/components/review/flags-tab.tsx
    frontend/src/components/review/document-viewer.tsx
    frontend/src/app/globals.css
  </files>
  <action>
**flags-tab.tsx REWRITE:**
Replace the placeholder FlagsTab with a full implementation:
- Remove the "Full flagging UI available in Phase 6" text entirely.
- Two modes based on whether `paraId` is null:
  - **No paragraph selected:** Show ALL flags across the document, grouped by paragraph. Each flag card shows: section_ref badge, category badge (color-coded using FLAG_CATEGORY_COLORS), note text, text_excerpt (truncated), timestamp, and a remove button (X icon).
  - **Paragraph selected:** Show flags for that paragraph at top, then a divider "All Flags ({count})" expanding to show all other flags below.
- Each flag card: rounded border card with:
  - Top row: section_ref in a secondary Badge + category badge (colored per FLAG_CATEGORY_COLORS: blue border/text for business-decision, orange for risk-alert, purple for for-discussion, gray for fyi) + timestamp
  - Middle: note text (if any)
  - Bottom: text_excerpt in italic muted text, 2-line clamp
  - Remove button: small ghost X button in top-right corner. On click, call `useFlags().remove(flag.para_id)`.
- "Add Flag" button at top of the tab: small outline button with Flag icon. Opens FlagDialog for the currently selected paragraph. If no paragraph selected, button is disabled.
- Import and render `FlagDialog` within FlagsTab (controlled by local `flagDialogOpen` state).
- Click on a flag card's section_ref badge scrolls to and selects that paragraph (call `selectParagraph`).

**document-viewer.tsx enhancements:**
1. **Flag margin icons:** In `updateParagraphStates`, when toggling the `.flagged` class, also set a `data-flag-category` attribute on the element with the flag's category value. If the paragraph has multiple flags, use the first flag's category. This enables the CSS to color-code the margin icon.

2. **Text selection flagging:** Add a new effect/callback that:
   - Listens for `mouseup` events on the document container.
   - On mouseup, checks `window.getSelection()` for a non-empty selection.
   - If selection exists, finds the nearest ancestor with `[data-para-id]` attribute from the selection's anchorNode.
   - If found, stores `{ paraId, textExcerpt: selection.toString().trim().slice(0, 200) }` in local state (e.g. `selectionContext`).
   - Renders the `FlagDialog` with that paraId when the user triggers it.
   - Show a small floating "Flag" button near the selection (positioned absolutely based on selection range bounding rect). When clicked, opens FlagDialog with the paraId and the selected text as a pre-filled note prefix.
   - The floating button disappears when selection is cleared (listen for `selectionchange`).
   - Use a portal or absolute-positioned div for the floating button.
   - Clean up event listeners on unmount.

**globals.css flag margin icon styles:**
Add styles for flag margin icons using `::before` pseudo-element on flagged paragraphs:
```css
.document-container [data-para-id].flagged {
  position: relative;
  /* Keep existing box-shadow from current .flagged rule */
}

.document-container [data-para-id].flagged::before {
  content: '';
  position: absolute;
  left: -20px;
  top: 4px;
  width: 14px;
  height: 14px;
  background-size: contain;
  background-repeat: no-repeat;
  opacity: 0.7;
}
```
Use inline SVG data URIs for the flag icon, color-coded by `data-flag-category`:
- `[data-flag-category="business-decision"]::before` - blue (#2563eb)
- `[data-flag-category="risk-alert"]::before` - orange (#ea580c)
- `[data-flag-category="for-discussion"]::before` - purple (#7c3aed)
- `[data-flag-category="fyi"]::before` - gray (#6b7280)

The SVG should be a simple flag/pin shape, 14x14. Example data URI pattern:
`background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%232563eb' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z'/%3E%3Cline x1='4' y1='22' x2='4' y2='15'/%3E%3C/svg%3E");`

Use separate selectors for each category with the appropriate color in the SVG stroke attribute.

IMPORTANT: The existing `.flagged` rule at line 230 of globals.css has `box-shadow: inset -3px 0 0 ...`. Keep this rule but add `position: relative;` to it so the `::before` pseudo-element positions correctly. The box-shadow provides the right-edge indicator; the `::before` provides the left-margin flag icon. Both are per the locked decision ("small flag/pin icon in the document margin").
  </action>
  <verify>
- `npx tsc --noEmit` passes
- FlagsTab renders flag cards with category badges and remove buttons (no placeholder text)
- Document viewer sets `data-flag-category` attribute on flagged paragraphs
- Text selection in document shows floating Flag button
- globals.css has flag margin icon styles for all 4 categories
  </verify>
  <done>
- FlagsTab shows all flags across document with category badges, notes, remove actions
- FlagsTab has "Add Flag" button that opens FlagDialog for selected paragraph
- Document margin shows color-coded flag icons for flagged paragraphs
- Text selection in document viewer shows floating Flag button that opens FlagDialog
  </done>
</task>

</tasks>

<verification>
1. Create a flag on a paragraph via the FlagsTab "Add Flag" button -- verify it appears in the tab with correct category badge
2. Create a flag via text selection in the document -- verify floating button appears, flag dialog opens, flag is created
3. Verify flagged paragraphs show color-coded margin icons in the document
4. Remove a flag from the FlagsTab -- verify icon disappears from document margin
5. `npx tsc --noEmit` passes with no errors
6. Verify no regressions in existing sidebar/document functionality
</verification>

<success_criteria>
- All four flag categories work: Business Decision, Risk Alert, For Discussion, FYI
- Flags can be created from FlagsTab button AND from document text selection
- Flagged paragraphs display margin icons color-coded by category
- FlagsTab shows complete flag listing with remove capability
- No type errors, no console errors during normal usage
</success_criteria>

<output>
After completion, create `.planning/phases/06-dialogs-finalization/06-01-SUMMARY.md`
</output>
